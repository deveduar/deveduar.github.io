creation date: 2025-05-19 22:20
tags:
  - NET
  - ASP
  - backend
keywords:
source:
status: üåü
Parent: "Area-Prog"
cssclasses:
  - hide-embedded-header1
  - wide
categories: "[Backend](/backend/backend/)"
public_note: "true"
# ASP NET

- [Backend](/backend/backend/)
- [net](/software%20engineering/net/)
- [api](/backend/api/)
- [sql server](/devops/sql-server/)
- app para exportar a excel con plantillas angular, net y cell
- [Aprende ASP .NET GRATIS - YouTube](https://youtu.be/28LjewDjaz4)


## Introducci√≥n a ASP.NET Core

ASP.NET Core es un framework multiplataforma, modular y de alto rendimiento para construir aplicaciones web modernas. Permite crear APIs, aplicaciones MVC, Blazor, microservicios y aplicaciones en tiempo real (SignalR).

**Ventajas principales:**
- Multiplataforma (Windows, Linux, macOS)
- Integraci√≥n nativa con [Azure](/cloud/azure/) y contenedores Docker
- Arquitectura modular y de c√≥digo abierto
- Alta performance gracias a Kestrel y al runtime optimizado de .NET
- Seguridad, autenticaci√≥n y autorizaci√≥n integradas
- Integraci√≥n con Entity Framework Core para persistencia de datos


## Arquitectura base

ASP.NET Core sigue el patr√≥n **Middleware Pipeline**, donde cada componente maneja la solicitud HTTP en una secuencia controlada.

**Componentes comunes del pipeline:**
- `UseRouting()`: define las rutas de la aplicaci√≥n.
- `UseAuthentication()` y `UseAuthorization()`: gestionan seguridad.
- `UseEndpoints()`: mapea las rutas a los controladores o handlers.

{% raw %}
```csharp
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();
app.Run();
```
{% endraw %}`


## ASP.NET Core MVC

### Patr√≥n MVC

El patr√≥n **Model-View-Controller** separa la l√≥gica de negocio, la presentaci√≥n y el control de flujo.

* **Model:** representa los datos y reglas del dominio.
* **View:** define la interfaz visual (HTML + Razor).
* **Controller:** maneja las solicitudes, coordina modelos y vistas.

{% raw %}
```csharp
public class HomeController : Controller
{
	public IActionResult Index()
	{
		var model = new WelcomeModel { Message = "Hola desde ASP.NET Core MVC" };
		return View(model);
	}
}
```
{% endraw %}

### Caracter√≠sticas Clave

* Soporte de Razor para vistas din√°micas.
* Enlace de modelos autom√°tico (Model Binding).
* Validaci√≥n con DataAnnotations.
* Inyecci√≥n de dependencias integrada.


## ASP.NET Core Web API

Dise√±ado para crear **servicios RESTful** con JSON, XML u otros formatos de salida.

**Caracter√≠sticas principales:**

* Atributos como `[HttpGet]`, `[HttpPost]`, `[HttpPut]`, `[HttpDelete]`
* Versionado de API nativo
* Middleware para [CORS](/backend/cors/), Autenticaci√≥n JWT y Swagger
* Serializaci√≥n JSON con `System.Text.Json` o `Newtonsoft.Json`

{% raw %}
```csharp
[ApiController]
[Route("api/[controller]")]
public class ProductsController : ControllerBase
{
	private readonly IProductService _service;

	public ProductsController(IProductService service)
	{
		_service = service;
	}

	[HttpGet]
	public async Task<IEnumerable<Product>> Get() => await _service.GetAllAsync();

	[HttpPost]
	public async Task<IActionResult> Create(Product product)
	{
		await _service.AddAsync(product);
		return CreatedAtAction(nameof(Get), new { id = product.Id }, product);
	}
}
```
{% endraw %}


## Blazor

Blazor permite construir interfaces web **interactivas** usando **C# en lugar de JavaScript**, tanto en el cliente (WebAssembly) como en el servidor.

**Modos de ejecuci√≥n:**

* **Blazor Server:** Renderizado en el servidor, conexi√≥n persistente por SignalR.
* **Blazor WebAssembly:** Corre directamente en el navegador.
* **Blazor Hybrid:** Integraci√≥n con aplicaciones de escritorio o m√≥viles (MAUI).

**Ventajas:**

* Reutilizaci√≥n de c√≥digo entre front y back.
* Integraci√≥n directa con .NET y sus librer√≠as.
* Componentes reutilizables y fuerte tipado.

{% raw %}
```razor
@page "/counter"

<h3>Contador</h3>

<p>Valor actual: @count</p>

<button @onclick="Incrementar">Incrementar</button>

@code {
	int count = 0;
	void Incrementar() => count++;
}
```
{% endraw %}


## Integraci√≥n con SQL Server y EF Core

ASP.NET Core se integra con Entity Framework Core para manejar bases de datos relacionales.

**Ejemplo de configuraci√≥n:**

{% raw %}
```csharp
builder.Services.AddDbContext<AppDbContext>(options =>
	options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));
```
{% endraw %}

**Migraciones y uso b√°sico:**

{% raw %}
```bash
dotnet ef migrations add InitialCreate
dotnet ef database update
```
{% endraw %}


## Publicaci√≥n y despliegue

ASP.NET Core permite desplegar aplicaciones de m√∫ltiples formas:

* **Contenedores Docker**
* **Servicios cloud (Azure App Service, AWS Elastic Beanstalk)**
* **Kubernetes / microservicios**
* **Publicaci√≥n auto-contenida (`dotnet publish -r`)**

**Ejemplo:**

{% raw %}
```bash
dotnet publish -c Release -o ./publish
```
{% endraw %}

Luego puede subirse a Azure o ejecutarse en un contenedor con:

{% raw %}
```bash
docker build -t myapp .
docker run -p 5000:80 myapp
```
{% endraw %}


## Casos pr√°cticos

### 1. API de gesti√≥n de usuarios

Integrando autenticaci√≥n JWT, controladores REST y Entity Framework.

### 2. Aplicaci√≥n administrativa MVC

Dashboard con gr√°ficos y exportaci√≥n a Excel usando ClosedXML y app para exportar a excel con plantillas angular, net y cell.

### 3. Sistema Blazor con SignalR

App en tiempo real para notificaciones o chats.


## Buenas pr√°cticas

* Usar inyecci√≥n de dependencias (`AddScoped`, `AddTransient`, `AddSingleton`)
* Centralizar configuraci√≥n en `appsettings.json`
* Versionar APIs correctamente
* Habilitar CORS para clientes externos
* Implementar logging con `ILogger<T>`
* Monitorear con Application Insights o Serilog
* Optimizar rendimiento con caching y compresi√≥n


## Recursos adicionales

* [Documentaci√≥n oficial ASP.NET Core](https://learn.microsoft.com/es-es/aspnet/core)
* [Curso gratuito en YouTube](https://youtu.be/28LjewDjaz4)
* .NET Core CLI
* Entity Framework Core
* Middleware Pipeline
* Inyecci√≥n de dependencias
* Blazor Components
* Azure App Service

# ASP.NET Core ‚Äì Avanzado y pr√°cticas profesionales

- [ASP NET](/uncategorized/asp-net/)
- [Backend](/backend/backend/)
- [api](/backend/api/)
- [sql server](/devops/sql-server/)
- Seguridad
- Arquitectura limpia
- [Azure](/cloud/azure/)
- [Testing](/testing/testing/)
- CI/CD


## Middleware y filtros avanzados

### Middleware personalizado

Permite interceptar el pipeline HTTP para aplicar l√≥gica global (logging, auditor√≠a, headers, etc.).

{% raw %}
```csharp
public class RequestTimingMiddleware
{
	private readonly RequestDelegate _next;
	public RequestTimingMiddleware(RequestDelegate next) => _next = next;

	public async Task InvokeAsync(HttpContext context)
	{
		var watch = Stopwatch.StartNew();
		await _next(context);
		watch.Stop();

		Console.WriteLine($"[{context.Request.Path}] ejecutado en {watch.ElapsedMilliseconds}ms");
	}
}
```
{% endraw %}`

**Registro:**

{% raw %}
```csharp
app.UseMiddleware<RequestTimingMiddleware>();
```
{% endraw %}

### Filtros globales en MVC o API

Los **filtros** permiten ejecutar l√≥gica antes o despu√©s de acciones o controladores.

Tipos:

* `ActionFilter` (antes/despu√©s de la acci√≥n)
* `ResultFilter` (antes/despu√©s del resultado)
* `ExceptionFilter` (manejo centralizado de errores)
* `AuthorizationFilter` (control de acceso)

{% raw %}
```csharp
public class GlobalExceptionFilter : IExceptionFilter
{
	public void OnException(ExceptionContext context)
	{
		context.Result = new ObjectResult(new { error = context.Exception.Message })
		{
			StatusCode = 500
		};
	}
}
```
{% endraw %}

**Registro global:**

{% raw %}
```csharp
builder.Services.AddControllers(options =>
{
	options.Filters.Add<GlobalExceptionFilter>();
});
```
{% endraw %}


## Seguridad y autenticaci√≥n

### ASP.NET Core Identity

Proporciona registro, login y roles de usuario listos para usar. Se puede combinar con EF Core y tokens JWT.

### JWT (JSON Web Tokens)

Ideal para APIs REST. El token se firma y se env√≠a en cada petici√≥n.

{% raw %}
```csharp
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
	.AddJwtBearer(options =>
	{
		options.TokenValidationParameters = new TokenValidationParameters
		{
			ValidateIssuer = true,
			ValidateAudience = true,
			ValidateLifetime = true,
			ValidateIssuerSigningKey = true,
			IssuerSigningKey = new SymmetricSecurityKey(
				Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"]))
		};
	});
```
{% endraw %}

**Ejemplo de autorizaci√≥n:**

{% raw %}
```csharp
[Authorize(Roles = "Admin")]
[HttpGet("dashboard")]
public IActionResult GetDashboard() => Ok("Bienvenido administrador");
```
{% endraw %}

### OAuth2 y OpenID Connect

Integraci√≥n con proveedores como **Azure AD**, **Google**, **GitHub** o **Auth0** mediante `AddOpenIdConnect()` o `AddOAuth()`.


## Rendimiento y optimizaci√≥n

### Caching

**En memoria:**

{% raw %}
```csharp
builder.Services.AddMemoryCache();
```
{% endraw %}

{% raw %}
```csharp
public class ProductService
{
	private readonly IMemoryCache _cache;
	public ProductService(IMemoryCache cache) => _cache = cache;

	public async Task<IEnumerable<Product>> GetAll()
	{
		if (!_cache.TryGetValue("products", out IEnumerable<Product> products))
		{
			products = await LoadProductsAsync();
			_cache.Set("products", products, TimeSpan.FromMinutes(5));
		}
		return products;
	}
}
```
{% endraw %}

**Output caching (ASP.NET Core 8+):**

{% raw %}
```csharp
app.UseOutputCache();
app.MapGet("/data", () => "cached data").CacheOutput();
```
{% endraw %}

### Compresi√≥n y respuesta optimizada

{% raw %}
```csharp
builder.Services.AddResponseCompression();
app.UseResponseCompression();
```
{% endraw %}

### Optimizaci√≥n de DI (inyecci√≥n de dependencias)

* Evitar `Singleton` con dependencias que usen `DbContext`
* Usar `Scoped` para servicios transaccionales
* Evitar dependencias circulares
* Registrar interfaces, no implementaciones directas


## Logging y monitoreo

### Logging estructurado con Serilog

{% raw %}
```csharp
builder.Host.UseSerilog((context, config) =>
{
	config.ReadFrom.Configuration(context.Configuration)
		  .Enrich.FromLogContext()
		  .WriteTo.Console()
		  .WriteTo.File("logs/log.txt", rollingInterval: RollingInterval.Day);
});
```
{% endraw %}

**Ventajas:**

* Logs estructurados en JSON
* Enriquecimiento con contexto (usuario, requestId, etc.)
* Integraci√≥n con Application Insights, Seq, [Elasticsearch](/monitoreo/elasticsearch/)

### Health checks y monitoreo

{% raw %}
```csharp
builder.Services.AddHealthChecks()
	.AddSqlServer(builder.Configuration.GetConnectionString("DefaultConnection"));

app.MapHealthChecks("/health");
```
{% endraw %}

Permite que Azure o Kubernetes verifiquen el estado del servicio.


## Arquitectura limpia y modular

ASP.NET Core se adapta perfectamente al enfoque de **Clean Architecture** o **Onion Architecture**.

**Capas recomendadas:**

1. **Domain:** entidades, l√≥gica pura, interfaces.
2. **Application:** casos de uso, CQRS, validaciones.
3. **Infrastructure:** acceso a datos, servicios externos.
4. **Presentation:** controladores o endpoints de API.

**Ejemplo de estructura:**

{% raw %}
```
src/
 ‚îú‚îÄ Domain/
 ‚îú‚îÄ Application/
 ‚îÇ   ‚îú‚îÄ Commands/
 ‚îÇ   ‚îú‚îÄ Queries/
 ‚îú‚îÄ Infrastructure/
 ‚îî‚îÄ WebApi/
```
{% endraw %}

### Inyecci√≥n modular

Cada capa registra sus servicios con un m√©todo de extensi√≥n:

{% raw %}
```csharp
public static class InfrastructureDI
{
	public static IServiceCollection AddInfrastructure(this IServiceCollection services, IConfiguration config)
	{
		services.AddDbContext<AppDbContext>(options =>
			options.UseSqlServer(config.GetConnectionString("Default")));
		return services;
	}
}
```
{% endraw %}


## Testing y calidad

### Unit tests con xUnit o NUnit

{% raw %}
```csharp
public class ProductServiceTests
{
	[Fact]
	public async Task GetAll_ShouldReturnProducts()
	{
		var service = new ProductService(new FakeRepo());
		var result = await service.GetAll();
		Assert.NotEmpty(result);
	}
}
```
{% endraw %}

### Integration tests con `WebApplicationFactory`

Permite probar el pipeline HTTP completo:

{% raw %}
```csharp
var app = new WebApplicationFactory<Program>();
var client = app.CreateClient();
var response = await client.GetAsync("/api/products");
```
{% endraw %}

### Test de performance y carga

Usar herramientas como:

* k6
* [JMeter](/testing/jmeter/)
* Azure Load Testing


## Despliegue e integraci√≥n continua (CI/CD)

### CI/CD con GitHub Actions o Azure DevOps

Ejemplo YAML b√°sico para GitHub Actions:

{% raw %}
```yaml
name: Build and Deploy ASP.NET Core

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x
      - name: Build
        run: dotnet build --configuration Release
      - name: Publish
        run: dotnet publish -c Release -o ./publish
```
{% endraw %}

### Despliegue en Azure App Service

{% raw %}
```bash
az webapp up --runtime "DOTNET:8" --name myapp --resource-group myrg
```
{% endraw %}

O usando un contenedor:

{% raw %}
```bash
docker build -t myapp .
docker run -p 8080:80 myapp
```
{% endraw %}


## Caso pr√°ctico completo

**Proyecto:** *Gesti√≥n de pedidos y usuarios (API + Blazor Admin)*
**Caracter√≠sticas:**

* Clean Architecture + CQRS
* Entity Framework Core con SQL Server
* JWT Authentication
* Serilog + Health Checks
* Despliegue en Azure App Service

**Flujo general:**

1. API REST con `OrdersController` y `UsersController`
2. Autenticaci√≥n JWT para proteger endpoints
3. Blazor Admin consume la API
4. Logging estructurado y health check en `/health`
5. CI/CD automatizado con GitHub Actions


## Buenas pr√°cticas finales

* Activar HTTPS obligatorio (`UseHttpsRedirection`)
* Aplicar pol√≠ticas de CORS espec√≠ficas, no globales
* Versionar APIs correctamente (`v1`, `v2`)
* Usar `CancellationToken` en m√©todos async
* Validar entrada de usuario siempre (FluentValidation)
* Configurar entorno (`Development`, `Staging`, `Production`)
* Monitorear rendimiento y errores con Application Insights


## Recursos complementarios

* [Documentaci√≥n avanzada de ASP.NET Core](https://learn.microsoft.com/es-es/aspnet/core/fundamentals)
* Clean Architecture .NET
* CQRS y Mediator
* JWT Authentication
* Serilog Logging
* Azure DevOps Pipelines
* Testing en .NET


