---
date: 2024-02-18 17:50
title: SMBRELAY
Parent: "[[Area-Sistemas]]"
keywords:
source:
status: üåü
public_note: "true"
category: ciberseguridad
tags:
  - Hacking
  - smbrelay
---
# SMBRELAY
`$= dv.current().file.tags.join(" ")`

- [Pentesting](/ciberseguridad/pentesting/)
- [vulnerabilidades](/ciberseguridad/vulnerabilidades/)

## Concepto y Funcionamiento
SMB Relay es una t√©cnica de ataque basada en **capturar y reutilizar credenciales de autenticaci√≥n SMB** sin necesidad de crackearlas inicialmente.
- Escucha hashes de autenticaci√≥n SMB en la red
- Reenv√≠a (relay) esos hashes a otros sistemas vulnerables
- Permite autenticaci√≥n como la v√≠ctima si el destino acepta SMB sin firma
- Ataque de tipo **Man-in-the-Middle (MITM)** mediante envenenamiento de resoluciones de nombres

## Requisitos y Limitaciones
- Solo funciona en sistemas con **SMB Signing deshabilitado**
- Muy com√∫n en entornos Windows mal segmentados
- Altamente dependiente de:
	- Configuraci√≥n del dominio
	- Protocolos legacy habilitados
	- Confianza impl√≠cita entre sistemas

## [Protocolos](/redes/protocolos/) Vulnerables
### LLMNR y NBNS
- Protocolos de resoluci√≥n de nombres locales
- Permiten envenenamiento para redirigir tr√°fico SMB al atacante
- Deben deshabilitarse en entornos seguros

## Flujo General del Ataque
- Envenenamiento de LLMNR/NBNS
- Captura de hashes de autenticaci√≥n
- Reenv√≠o del hash a otro host SMB vulnerable
- Autenticaci√≥n exitosa sin conocer la contrase√±a
- Acceso remoto o ejecuci√≥n de comandos

## Herramientas Relacionadas
- [Responder](https://github.com/SpiderLabs/Responder)
	- Envenena LLMNR, NBT-NS y MDNS
	- Captura hashes NTLM
	- Muy utilizado junto a SMB Relay
- Mimikatz
	- Extracci√≥n de credenciales
	- Dump de memoria para hashes y tickets
	- Especialmente efectivo tras acceso inicial

## SMB Relay y Active Directory
- Ataque frecuente en ACTIVE DIRECTORY ATTACS
- Impacto cr√≠tico cuando se relaya contra:
	- Controladores de dominio
	- Servidores con permisos elevados
- Permite:
	- Movimiento lateral
	- Escalada de privilegios
	- Acceso a recursos cr√≠ticos

## Enumeraci√≥n sin Credenciales
### NULL Sessions
- Uso de RPC y SMB sin autenticaci√≥n
- Permite:
	- Enumerar usuarios del dominio
	- Obtener informaci√≥n de pol√≠ticas
	- Identificar shares accesibles
- Herramienta RPS client (Microsoft Remote Protocol)
	- Acceso remoto sin credenciales en configuraciones d√©biles

## Enumeraci√≥n SMB y RPC
- [Enumerating SMB, RPC, and NetBIOS for Pentesting](https://infinitelogins.com/2020/06/17/enumerating-smb-for-pentesting/)
- [rpcenum](https://github.com/s4vitar/rpcenum)
	- Script en Bash
	- Extrae informaci√≥n relevante v√≠a rpcclient
	- Ideal para reconocimiento inicial del dominio

## Ataques Relacionados con Kerberos
- [Kerberos](/autenticacion/kerberos/)
### AS-REP Roasting
- Dominios que no requieren pre-autenticaci√≥n Kerberos
- Permite:
	- Solicitar AS-REP
	- Obtener hash equivalente
	- Fuerza bruta offline
- Muy efectivo contra cuentas de servicio mal configuradas

## Post-Explotaci√≥n
### Dump de Memoria
- Dumpear informaci√≥n de la memoria del sistema
- Recuperar:
	- Credenciales en texto claro
	- Hashes NTLM
	- Tickets Kerberos

## Crackeo Offline
- Los hashes capturados pueden crackearse offline
- No genera tr√°fico adicional en red
- Reduce detecci√≥n por IDS/IPS

## Mitigaciones y Defensa
- Habilitar SMB Signing obligatorio
- Deshabilitar LLMNR y NBNS
- Filtrar tr√°fico SMB innecesario
- Limitar cuentas de administrador del dominio
- Aplicar segmentaci√≥n de red estricta
- Monitorear tr√°fico de autenticaci√≥n an√≥malo

## Impacto en Seguridad
- Compromiso total del dominio en escenarios d√©biles
- Ataque silencioso y altamente efectivo
- Frecuente en auditor√≠as internas y Red Team

# SMBRELAY ‚Äî Conceptos Avanzados y Temas No Cubiertos

## Variantes de SMB Relay
- SMB ‚Üí SMB
	- Rel√© cl√°sico contra servicios SMB
	- Permite acceso a shares, ejecuci√≥n remota y autenticaci√≥n interactiva
- SMB ‚Üí HTTP
	- Relay hacia servicios web que aceptan NTLM
	- Com√∫n en:
		- IIS
		- Paneles de administraci√≥n internos
- SMB ‚Üí LDAP / LDAPS
	- Ataque cr√≠tico en dominios modernos
	- Permite:
		- Modificar atributos de AD
		- Agregar m√°quinas al dominio
		- Delegaci√≥n de permisos

## SMB Relay contra LDAP
- Muy relevante en ACTIVE DIRECTORY ATTACS modernos
- Permite abusar de:
	- ACLs
	- Permisos delegados
- Escenarios comunes:
	- Agregar usuario a grupos privilegiados
	- Habilitar RBCD (Resource-Based Constrained Delegation)

## Resource-Based Constrained Delegation (RBCD)
- Abuso avanzado post-SMB Relay
- Permite:
	- Impersonar usuarios contra servicios espec√≠ficos
	- Escalar hasta Domain Admin
- Requiere:
	- Control de una cuenta de m√°quina
	- Relay exitoso contra LDAP

## NTLM Relay vs NTLM Pass-the-Hash
- NTLM Relay
	- No requiere conocer el hash
	- Se reutiliza la autenticaci√≥n en tiempo real
- Pass-the-Hash
	- Requiere hash NTLM
	- Uso directo del hash para autenticarse
- SMB Relay es preferible en:
	- Redes internas
	- Entornos con tr√°fico frecuente de autenticaci√≥n

## SMB Relay y IPv6
- Redes IPv6 mal configuradas ampl√≠an la superficie de ataque
- Uso de:
	- DHCPv6 spoofing
	- DNS spoofing
- Permite forzar tr√°fico de autenticaci√≥n hacia el atacante
- Muy com√∫n en dominios que ‚Äúno usan IPv6‚Äù pero lo tienen habilitado

## Coerci√≥n de Autenticaci√≥n
- T√©cnicas para forzar que una m√°quina se autentique contra el atacante
- Ejemplos:
	- Peticiones RPC maliciosas
	- Acceso a recursos inexistentes
- Complementa SMB Relay cuando no hay tr√°fico espont√°neo

## SMB Relay y Servicios Vulnerables
- Servicios comunes que aceptan NTLM:
	- SMB
	- HTTP
	- MSSQL
	- LDAP
	- WinRM
- El relay no se limita a SMB exclusivamente

## Detecci√≥n y Telemetr√≠a
- Eventos de seguridad relevantes:
	- Autenticaciones NTLM an√≥malas
	- Uso de NTLM en lugar de Kerberos
- Indicadores de ataque:
	- M√∫ltiples intentos de autenticaci√≥n cruzada
	- Tr√°fico LLMNR/NBNS inesperado
	- Autenticaciones desde estaciones no habituales

## SMB Relay en Red Team
- Uso estrat√©gico:
	- Obtener primer acceso sin explotaci√≥n directa
	- Movimiento lateral silencioso
- Ideal en:
	- Auditor√≠as internas
	- Suposiciones de insider threat

## Relaci√≥n con Segmentaci√≥n de Red
- Segmentaci√≥n deficiente:
	- Amplifica el impacto del relay
	- Permite llegar a sistemas cr√≠ticos
- Segmentaci√≥n correcta:
	- Limita alcance del ataque
	- Reduce superficie lateral

## Hardening Espec√≠fico contra Relay
- Forzar Kerberos siempre que sea posible
- Bloquear NTLMv1 y NTLMv2 cuando no sea necesario
- Restringir autenticaciones NTLM entrantes
- Revisar permisos de cuentas de m√°quina
- Auditor√≠a de servicios que aceptan NTLM

## Casos de Uso Reales
- Compromiso de controlador de dominio v√≠a LDAP relay
- Elevaci√≥n de privilegios sin exploit
- Persistencia mediante modificaci√≥n de objetos AD

## Relaci√≥n con Dumping de Credenciales
- SMB Relay facilita acceso inicial
- Dump de memoria posterior permite:
	- Persistencia
	- Ataques h√≠bridos (Relay + PtH + Kerberos)

## Encaje en la Kill Chain
- Reconocimiento
- Envenenamiento
- Relay de autenticaci√≥n
- Movimiento lateral
- Escalada de privilegios
- Dominio comprometido

# Recursos y Tools para SMB Relay & Ataques Relacionados (2025)

## Herramientas Esenciales para Pentesting
- **Impacket**
	- Conjunto de scripts Python para protocolos Windows: SMB, MSRPC, Kerberos, LDAP, NTLM
	- Scripts √∫tiles:
		- `ntlmrelayx.py`: automatiza **NTLM Relay** hacia SMB, LDAP, HTTP, MSSQL
		- `smbclient.py`: cliente SMB ligero para enumerar y transferir archivos
		- `secretsdump.py`: extrae hashes de SAM y credenciales de LSASS
		- `wmiexec.py`, `psexec.py`: ejecuci√≥n remota de comandos
		- Kerberos tools: `GetTGT.py`, `GetNPUsers.py` para ataques a tickets
	- Muy relevante en 2025 para *identity-centric testing* y validaci√≥n de SMB Signing, LDAP Signing y Channel Binding
	- [Impacket GitHub](https://github.com/fortra/impacket)

- **Metasploit Framework**
	- M√≥dulos NTLM/SMB Relay mantenidos y ampliados
	- Soporte para vectores avanzados como **SMB ‚Üí MSSQL Relay**
	- Permite ejecuci√≥n de comandos y queries tras relay exitoso
	- Uso combinado con coerci√≥n de autenticaci√≥n
	- [Metasploit Framework](https://www.metasploit.com)

- **Responder**
	- Envenenamiento de LLMNR, NBNS y MDNS
	- Captura hashes NTLMv1/NTLMv2
	- Herramienta clave para iniciar ataques SMB Relay
	- (Repositorio: github SpiderLabs Responder)

- **Pentest Service Enumeration**
	- Enumeraci√≥n y ejecuci√≥n de acciones por servicio/protocolo
	- Centraliza flujos SMB, LDAP, MSSQL, WinRM
	- √ötil para automatizar fases de reconocimiento y post-explotaci√≥n
	- [Pentest Service Enumeration](https://github.com/ssstonebraker/Pentest-Service-Enumeration)

## T√©cnicas y Frameworks Vinculados
- **Reflective Kerberos Relay Attack**
	- Variante avanzada descubierta en 2025
	- Permite escalar privilegios hasta `NT AUTHORITY\SYSTEM`
	- Basado en coerci√≥n Kerberos y relay hacia el mismo host
	- Vulnerabilidad asociada: CVE-2025-33073 (parcheada en 2025)
	- [RedTeam Pentesting Advisory](https://www.redteam-pentesting.de/en/advisories/rt-sa-2025-002)

- **Coerci√≥n de Autenticaci√≥n NTLM/Kerberos**
	- T√©cnicas para forzar autenticaciones hacia el atacante
	- Fundamental cuando no existe tr√°fico espont√°neo
	- Casos conocidos:
		- PetitPotam
		- Printer Bug
		- RPC coercion
	- [NTLM Relay Attacks Overview](https://www.helpnetsecurity.com/2025/07/04/ntlm-relay-attacks)

## Protocolos y Configuraciones Cr√≠ticas
- **SMB Signing / LDAP Signing / Channel Binding**
	- Mitigaciones clave contra ataques de relay
	- SMB Signing obligatorio reduce ataques laterales
	- LDAP Signing + Channel Binding bloquea relay hacia AD
	- Relevante en Windows Server 2022, 2025 y Windows 11
	- [Microsoft NTLM Mitigations](https://learn.microsoft.com/en-us/windows/security/identity-protection/ntlm-blocking)

## Herramientas Auxiliares y Ecosistema
- **Kali Linux ‚Äî Toolset Actualizado**
	- Incluye Impacket, Responder, Metasploit y herramientas de coerci√≥n
	- Ideal para laboratorios y auditor√≠as internas
	- [Kali Linux Tools](https://www.kali.org/tools)

- **Enumeraci√≥n y Automatizaci√≥n**
	- Proyectos emergentes complementarios al pentesting cl√°sico
	- Uso de agentes aut√≥nomos para automatizar tareas repetitivas
	- Integrables con scripts SMB, LDAP y Kerberos
	- [ARACNE Paper](https://arxiv.org/abs/2502.18528)

## Repositorios y Demos
- `impacket` ‚Äî [https://github.com/fortra/impacket](https://github.com/fortra/impacket)
- `Responder` ‚Äî [https://github.com/SpiderLabs/Responder](https://github.com/SpiderLabs/Responder)
- `Pentest-Service-Enumeration` ‚Äî [https://github.com/ssstonebraker/Pentest-Service-Enumeration](https://github.com/ssstonebraker/Pentest-Service-Enumeration)

## Recursos de Aprendizaje y Documentaci√≥n
- Whitepaper t√©cnico sobre Reflective Kerberos Relay Attack (2025)
	- [Reflective Kerberos Relay ‚Äì RedTeam Pentesting](https://www.redteam-pentesting.de/publications/2025-06-11-Reflective-Kerberos-Relay-Attack_RedTeam-Pentesting.pdf)
- Gu√≠as actualizadas sobre NTLM Relay y mitigaciones modernas
	- [Help Net Security ‚Äì NTLM Relay](https://www.helpnetsecurity.com/2025/07/04/ntlm-relay-attacks)

## Consejos Pr√°cticos de Uso
- Validar SMB Signing, LDAP Signing y Channel Binding antes de explotar
- Priorizar relay contra LDAP para impacto en dominio
- Combinar coerci√≥n + relay para maximizar √©xito
- Usar exclusivamente en entornos autorizados
- Cadena t√≠pica en 2025:
	- Responder ‚Üí ntlmrelayx ‚Üí LDAP abuse ‚Üí Kerberos abuse ‚Üí escalada de dominio
