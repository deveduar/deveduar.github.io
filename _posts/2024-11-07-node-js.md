---
date: 2024-11-07 03:13
title: node.js
tags:
  - nodejs
  - express
  - backend
keywords:
source:
status: üåü
Parent: "[[Area-Prog]]"
cssclasses:
  - hide-embedded-header1
  - wide
categories:
  - Backend
aliases:
  - nodejs
public_note: "true"
category: Backend
---
# Node.js  
`$= dv.current().file.tags.join(" ")`  

- [Backend](/uncategorized/backend/)  
- [javascript](/desarrollo%20web/javascript/)  
- [Testing](/testing/testing/)
## Conceptos Fundamentales de Node.js

### Workers y Multithreading
Node.js utiliza un modelo de ejecuci√≥n **single-threaded**, pero soporta **multithreading** mediante el uso de *Worker Threads* o el *Cluster Module* para aprovechar m√∫ltiples n√∫cleos del procesador.

- **Workers**
	- Permiten ejecutar c√≥digo JavaScript en hilos separados del *main thread*.
	- Se comunican con el hilo principal mediante **ports** y **mensajes** (`postMessage`, `onmessage`).
- **Performance**
	- Aumenta el rendimiento en tareas CPU-bound (procesamiento intensivo, c√°lculos, compresi√≥n).
	- No mejora el rendimiento en tareas I/O-bound (lectura de archivos o red).
- **Data Transfer**
	- Se pueden transferir datos entre hilos usando objetos serializados o **buffers compartidos**.
- **Shared Memory**
	- Con `SharedArrayBuffer`, los hilos pueden acceder al mismo bloque de memoria, reduciendo copias innecesarias.
- **Buffer**
	- Objeto global de Node.js usado para manejar datos binarios. Es esencial para operaciones con streams, archivos, sockets o APIs binarios.

### Core Concepts: CORS, Middleware, Request & Response
Node.js con express utiliza middleware para interceptar y procesar peticiones.

- **CORS**
	- Controla el acceso de dominios cruzados.
	- Configurable mediante `cors()` middleware.
- **Middleware**
	- Funciones que interceptan `req`, `res`, y `next()`.
	- Se pueden usar para autenticaci√≥n, logging, validaci√≥n o manejo de errores.
- **Request & Response**
	- `req` contiene informaci√≥n del cliente, par√°metros, body, headers.
	- `res` maneja la respuesta (status, json, send, render).

### ORM (Object Relational Mapping)
Permite interactuar con bases de datos relacionales usando objetos JS.
- Ejemplo: [Sequelize](/backend/sequelize/), Prisma.
- Simplifica la escritura de queries SQL, facilita migraciones y modelos de datos.

---

## express üî•
- [Direccionamiento de Express](https://expressjs.com/es/guide/routing.html)

### Ejemplo b√°sico
```js
const express = require('express')
const app = express()

app.get('/', (req, res) => {
	res.send('Hello Node.js!')
})

app.listen(3000, () => console.log('Servidor corriendo en puerto 3000'))
````

---

## Cursos y Recursos de Aprendizaje

* JS-nodejs-old
* JS-nodejs-first-app
* 
* nodejs-instalacion en linux
* nodejs-Instalar librer√≠as y borrar node modules
* 
* REST API Design Best Practices Handbook ‚Äì How to Build a REST API with JavaScript, Node.js, and E...
* Gu√≠a definitiva de Node.js- Introducci√≥n para desarrolladores - Evolve Academy
* 
* [Curso Fundamentos de Node.js - jonmircha - YouTube](https://youtu.be/0f26_Enlv38)
* [GitHub - jonmircha/youtube-nodejs](https://github.com/jonmircha/youtube-nodejs)
* [API REST con NODE.js || GU√çA de BUENAS PR√ÅCTICAS - YouTube](https://youtu.be/qFmwRriNJWs)
* 

---

## Configuraci√≥n y Buenas Pr√°cticas

### Linter y Formateo
- [linters](/testing/linters/)
* [Use ESLint in Your Project](https://eslint.org/docs/latest/use/)
* [Getting Started with ESLint](https://eslint.org/docs/latest/use/getting-started)
* [What is Prettier? ¬∑ Prettier](https://prettier.io/docs/en/)

### Configuraci√≥n del Entorno de Node y Express

* [How I Set up Production Node.js Project (2024) - YouTube](https://youtu.be/GTDYsV5pyZU)
* [GitHub - alexrusin/node-template-2024](https://github.com/alexrusin/node-template-2024)
* [GitHub - alexrusin/node-template-2024 at add-sequelize](https://github.com/alexrusin/node-template-2024/tree/add-sequelize)

### GitHub Actions [devops](/uncategorized/devops/)

* Workflows para automatizar CI/CD.
* **Trigger events:** ejecuci√≥n de acciones (ej. test, deploy).
* Archivos **`.yml`** para definir pipelines.

### Herramientas y Configuraci√≥n

* **nodemon** ‚Üí recarga autom√°tica de servidor en desarrollo.
* **Env de `AppDebug`** ‚Üí configurar `NODE_ENV`, `PORT`, y variables globales.
* **Config centralizada**
  * Crear objeto de configuraci√≥n que cargue envs solo una vez.
  * Usar `process.loadEnvFile()` y exportar como constantes.

### Tareas Pendientes

* [ ] Crear estructura de archivos y entorno de debug.
* [ ] Instalar DB con Docker ‚Üí [hub.docker.com/_/mysql](https://hub.docker.com/_/mysql) [devops](/uncategorized/devops/)
* [ ] Usar [Sequelize](/backend/sequelize/) ORM con TypeScript


---

## Buenas Pr√°cticas en React, JS y Node.js

### Variables de entorno

* Usar `process.env` de forma eficiente para evitar overhead.
* Cargar `.env` antes de iniciar el servidor y no en cada funci√≥n.
* Configurar entornos (`development`, `production`, `test`) en un √∫nico archivo de configuraci√≥n exportado.

### Importaciones y Rutas

* Usar rutas relativas limpias con alias `@` configurado en `jsconfig.json` o `tsconfig.json`.

### React y Asincron√≠a

* Carga din√°mica de componentes con `lazy()` y `Suspense`.
* Evitar condicionales excesivos (`if`) en animaciones usando callbacks (`onClose`).
* Asegurar que las promesas se gestionan correctamente con `Promise.try()` en `useEffect`.

### Optional Chaining

* Operador `?.` para evitar errores por `undefined`.
* Optional chaining (.) - JavaScript  MDN-Optional_chaining

```js
const userName = user?.profile?.name ?? 'Invitado'
```

### Alternativas a Nodemon

* Usar **`what`** o **`ts-node-dev`** para un reinicio m√°s r√°pido y ligero.

---

## Ejemplo: Configuraci√≥n Base del Proyecto Node.js

```bash
# Instalaci√≥n de dependencias
npm init -y
npm install express cors dotenv nodemon

# Estructura de carpetas
src/
	app.js
	routes/
	controllers/
	config/
	models/

# Script en package.json
"scripts": {
	"dev": "nodemon src/app.js",
	"start": "node src/app.js"
}
```

```js
// src/app.js
import express from 'express'
import cors from 'cors'
import dotenv from 'dotenv'

dotenv.config()
const app = express()
app.use(cors())
app.use(express.json())

app.listen(process.env.PORT || 3000, () =>
	console.log(`Servidor en puerto ${process.env.PORT}`)
)
```

---

## Resumen

Node.js es un entorno eficiente para desarrollar aplicaciones escalables orientadas a eventos. Su integraci√≥n con express, su ecosistema de herramientas (ORM, ESLint, Prettier, Docker, GitHub Actions) y sus capacidades de paralelizaci√≥n mediante *Workers* lo convierten en una base s√≥lida tanto para proyectos monol√≠ticos como microservicios modernos.

# Node.js ‚Äì Internals, Rendimiento y Arquitectura Avanzada
`$= dv.current().file.tags.join(" ")`

- [Backend](/uncategorized/backend/)
- [node.js](/backend/node-js/)
- [javascript](/desarrollo%20web/javascript/)
- [Testing](/testing/testing/)
- [devops](/uncategorized/devops/)
## Event Loop y Asincron√≠a Avanzada

El **Event Loop** es el coraz√≥n de Node.js. Gestiona la ejecuci√≥n no bloqueante del c√≥digo, delegando operaciones a la API del sistema y atendiendo callbacks en diferentes fases.

### Fases del Event Loop
1. **Timers:** ejecuta callbacks de `setTimeout` y `setInterval`.
2. **Pending Callbacks:** callbacks de operaciones I/O diferidas.
3. **Idle & Prepare:** tareas internas del sistema.
4. **Poll:** espera eventos nuevos de I/O, ejecuta sus callbacks.
5. **Check:** ejecuta callbacks de `setImmediate`.
6. **Close callbacks:** cierra sockets o handles (ej. `socket.on('close')`).

### Microtasks y Macrotasks
- **Microtasks:** Promesas, `process.nextTick()`.
- **Macrotasks:** Timers, I/O, `setImmediate`.
- Node prioriza siempre las *microtasks* entre fases del loop.

```js
console.log('start')

setTimeout(() => console.log('timeout'), 0)
setImmediate(() => console.log('immediate'))
process.nextTick(() => console.log('nextTick'))
Promise.resolve().then(() => console.log('promise'))

console.log('end')
````

---

## Streams y Manejo de Datos Masivos

Los **Streams** permiten procesar datos de forma continua y eficiente, evitando cargar todo en memoria.

### Tipos de Streams

* **Readable:** leen datos (archivos, sockets).
* **Writable:** escriben datos (archivos, consola).
* **Duplex:** lectura y escritura (sockets TCP).
* **Transform:** manipulan datos en tr√°nsito (compresi√≥n, cifrado).

### Ejemplo: Lectura y Escritura con Streams

```js
import fs from 'fs'

const read = fs.createReadStream('input.txt')
const write = fs.createWriteStream('output.txt')

read.pipe(write)
```

* `pipe()` conecta streams sin bloquear el event loop.
* Ideal para grandes archivos o transferencias HTTP.

---

## Cluster y Procesos Hijos

### Cluster

Permite aprovechar m√∫ltiples n√∫cleos del sistema para escalar horizontalmente una app Node.js.

```js
import cluster from 'cluster'
import os from 'os'
import http from 'http'

if (cluster.isPrimary) {
	const cpus = os.cpus().length
	for (let i = 0; i < cpus; i++) cluster.fork()
} else {
	http.createServer((req, res) => {
		res.end(`Worker ${process.pid}`)
	}).listen(3000)
}
```

* Cada worker ejecuta una copia del servidor.
* El proceso primario maneja balanceo de carga interno.

### Procesos Hijos

* M√≥dulo `child_process` ejecuta scripts o comandos externos.
* Ideal para tareas aisladas: backups, cron jobs, CLI tools.

```js
import { exec } from 'child_process'
exec('ls', (err, stdout) => console.log(stdout))
```

---

## EventEmitter y Eventos Personalizados

El m√≥dulo `events` implementa el **patr√≥n Observer** interno de Node.js.

```js
import { EventEmitter } from 'events'
const emitter = new EventEmitter()

emitter.on('user:login', user => console.log(`Login: ${user}`))
emitter.emit('user:login', 'admin')
```

* Base de muchos sistemas de notificaci√≥n y middleware interno.
* Se puede extender en clases personalizadas.

---

## Manejo de Errores, Logs y Observabilidad

### Tipos de errores

* **S√≠ncronos:** se capturan con `try/catch`.
* **As√≠ncronos:** requieren `Promise.catch` o `process.on('uncaughtException')`.

### Logging estructurado

Usar librer√≠as como **Winston** o **Pino** para trazabilidad.

```js
import pino from 'pino'
const logger = pino({ level: 'info' })

logger.info('Server started')
logger.error({ err }, 'Unhandled exception')
```

### Observabilidad

* Integrar m√©tricas con **Prometheus**, **OpenTelemetry**, o **Grafana**.
* Monitorizar:

  * Latencia
  * Tiempo de respuesta
  * Uso de CPU/RAM
  * Ciclos del Event Loop

---

## Seguridad en Node.js

### Reglas b√°sicas

* Validar entradas ‚Üí usar `validator` o `joi`.
* Evitar `eval()` o `Function()` din√°micos.
* Sanitizar input antes de queries SQL o NoSQL.
* Activar **helmet** para cabeceras seguras en Express.

```js
import helmet from 'helmet'
app.use(helmet())
```

### Rate Limiting

```js
import rateLimit from 'express-rate-limit'
app.use(rateLimit({ windowMs: 60_000, max: 100 }))
```

### Dependencias

* Auditar con `npm audit` y `npm outdated`.
* Fijar versiones en `package-lock.json` o `pnpm-lock.yaml`.

---

## Testing Avanzado

### Herramientas

* **Jest / Vitest:** unit tests.
* **Supertest:** pruebas HTTP.
* **Sinon:** mocks, spies, stubs.

```js
import request from 'supertest'
import app from '../src/app.js'

describe('GET /', () => {
	it('should return 200', async () => {
		await request(app).get('/').expect(200)
	})
})
```

### Cobertura

Usar `--coverage` para medir rutas y m√≥dulos no testeados.

### Tests de Integraci√≥n

* Testear flujo real de API (con DB mockeada o Docker).
* Integrar en GitHub Actions [devops](/uncategorized/devops/).

---

## Performance y Profiling

### Optimizaci√≥n

* Reusar conexiones DB.
* Evitar loops bloqueantes.
* Usar `Promise.all()` para concurrencia.

### Profiling

```bash
node --inspect app.js
```

Abrir en Chrome DevTools (`chrome://inspect`) ‚Üí analizar CPU, memoria, leaks.

### Herramientas de diagn√≥stico

* **clinic.js**
* **0x**
* **node --prof**

---

## Distribuci√≥n y Arquitectura

### Patrones comunes

* **Microservicios:** separaci√≥n por dominios.
* **Message Queue:** Redis, RabbitMQ, NATS.
* **Workers distribuidos:** ejecutar tareas as√≠ncronas.
* **CQRS / Event Sourcing:** separar lectura y escritura.

### Ejemplo: Worker con RabbitMQ

```js
import amqplib from 'amqplib'

const queue = 'tasks'
const connection = await amqplib.connect('amqp://localhost')
const channel = await connection.createChannel()

await channel.assertQueue(queue)
channel.consume(queue, msg => {
	console.log('Tarea:', msg.content.toString())
	channel.ack(msg)
})
```

---

## Depuraci√≥n y CLI de Node.js

### Herramientas CLI

* `node inspect app.js`
* `--trace-warnings`, `--trace-deprecation`
* `console.table`, `console.group`, `console.count`

### Debugger Visual

* Integraci√≥n con VSCode usando `.vscode/launch.json`.
* Breakpoints, variables locales y profiling visual.

---

## Conclusi√≥n

Node.js no es solo un entorno de ejecuci√≥n de JavaScript, sino una plataforma robusta para construir aplicaciones modernas escalables y observables. Comprender su **Event Loop**, el sistema de **Streams**, el manejo de **procesos**, y aplicar pr√°cticas de **seguridad, pruebas y profiling** permite crear soluciones distribuidas listas para producci√≥n.

# Node.js ‚Äì Ecosistema Profesional y Arquitectura en Producci√≥n
`$= dv.current().file.tags.join(" ")`

- [Backend](/uncategorized/backend/)
- [node.js](/backend/node-js/)
- [javascript](/desarrollo%20web/javascript/)
- [devops](/uncategorized/devops/)
- [Testing](/testing/testing/)
## Gesti√≥n de Dependencias y Versionado

### npm, pnpm y Yarn
Node.js permite varios gestores de dependencias. Su elecci√≥n impacta en la velocidad, reproducibilidad y tama√±o del proyecto.

- **npm**
	- Predeterminado.  
	- Usa `package-lock.json` para bloqueo de versiones.  
	- Comando √∫til: `npm ci` (instalaci√≥n limpia, ideal para CI/CD).

- **pnpm**
	- Usa almacenamiento global de dependencias compartidas.  
	- Ahorra espacio y mejora la velocidad de instalaci√≥n.  
	- Comando √∫til: `pnpm recursive install`.

- **Yarn**
	- Foco en rapidez y cacheo.  
	- Usa `yarn.lock` para versiones deterministas.  

### nvm (Node Version Manager)
Permite cambiar entre versiones de Node.js sin conflictos.

```bash
nvm install 20
nvm use 20
nvm alias default 20
````

* Ideal para mantener compatibilidad entre proyectos o entornos CI.
* Recomendado para flujos [devops](/uncategorized/devops/).

---

## Modularidad y Patrones de Dise√±o

### ESM vs CommonJS

* **CommonJS (CJS):** usa `require()` y `module.exports`.
* **ESM (ECMAScript Modules):** usa `import` y `export`.

```js
// CJS
const express = require('express')

// ESM
import express from 'express'
```

* ESM soporta top-level await y tree-shaking.
* En proyectos modernos usar `"type": "module"` en `package.json`.

### Patrones Relevantes

* **Factory Pattern:** crear objetos seg√∫n tipo o contexto.
* **Dependency Injection:** desacoplar dependencias y facilitar testing.
* **Repository Pattern:** aislar la l√≥gica de persistencia.
* **Clean Architecture:** separar capas ‚Üí `controller`, `useCase`, `repository`, `infra`.

```js
// ejemplo de inyecci√≥n de dependencias
class UserService {
	constructor(userRepository) {
		this.repo = userRepository
	}
	async createUser(dto) {
		return this.repo.save(dto)
	}
}
```

---

## Node.js con TypeScript

El tipado est√°tico mejora la robustez y mantenibilidad de proyectos grandes.

### Configuraci√≥n

```bash
npm install typescript ts-node @types/node --save-dev
npx tsc --init
```

### Tipado b√°sico

```ts
interface User {
	id: number
	name: string
	email?: string
}

const getUser = (id: number): Promise<User> => fetchUser(id)
```

### Integraci√≥n con Express

```ts
import express, { Request, Response } from 'express'
const app = express()

app.get('/', (req: Request, res: Response) => res.json({ ok: true }))
```

* Permite detectar errores antes de ejecutar.
* Se integra f√°cilmente con ORM tipo [Sequelize](/backend/sequelize/) o Prisma.

---

## Colas de Trabajo y Procesamiento As√≠ncrono

### BullMQ

Framework para procesar tareas en segundo plano sobre Redis.

```js
import { Queue, Worker } from 'bullmq'

const queue = new Queue('emails')
await queue.add('send', { to: 'user@example.com' })

new Worker('emails', job => {
	console.log('Enviando a', job.data.to)
})
```

* Reintentos, prioridades, y gesti√≥n de concurrencia.
* Ideal para tareas como notificaciones, pagos, generaci√≥n de reportes.

### Agenda.js

Usa MongoDB para agendar trabajos recurrentes.

```js
import Agenda from 'agenda'
const agenda = new Agenda({ db: { address: 'mongodb://localhost/agenda' } })

agenda.define('say hello', job => console.log('Hello'))
agenda.every('5 minutes', 'say hello')
```

### Worker Threads Coordinados

Ideal para CPU-bound sin bloquear el loop principal.

---

## Escalabilidad y Balanceo

### Escalabilidad Vertical

* Aumentar recursos del servidor (CPU/RAM).
* Menos eficiente a largo plazo.

### Escalabilidad Horizontal

* Multiplicar instancias usando Cluster o **PM2**.

```bash
pm2 start app.js -i max
pm2 monit
```

* PM2 maneja reinicios autom√°ticos, logs y m√©tricas.

### Cacheo y Optimizaci√≥n

* Usar Redis para cachear peticiones frecuentes.
* Implementar TTL y estrategias LRU.

```js
await redis.setex('user:1', 60, JSON.stringify(user))
```

* Comprimir respuestas (`compression` middleware).
* Evitar consultas repetidas en DB.

---

## Integraci√≥n con APIs y Protocolos Modernos

### REST y GraphQL

* REST ‚Üí rutas predecibles (`/users/:id`).
* GraphQL ‚Üí consultas flexibles, ideal para frontends complejos.

```js
import { ApolloServer, gql } from 'apollo-server-express'
const typeDefs = gql`type User { id: ID name: String }`
```

### WebSockets

Para comunicaci√≥n bidireccional (chat, notificaciones).

```js
import { Server } from 'socket.io'
const io = new Server(3001)

io.on('connection', socket => {
	socket.emit('welcome', 'Conectado!')
})
```

### gRPC

Comunicaci√≥n binaria r√°pida entre microservicios.

```js
import grpc from '@grpc/grpc-js'
import protoLoader from '@grpc/proto-loader'
```

---

## Despliegue Profesional y CI/CD

### Docker y Contenedores

Dockeriza aplicaciones para asegurar consistencia.

```dockerfile
FROM node:20
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
CMD ["node", "src/app.js"]
```

* Usar **docker-compose** para servicios DB + API.
* Integrar [devops](/uncategorized/devops/) pipelines con GitHub Actions.

### CI/CD

Pipeline `.yml` b√°sico:

```yaml
name: Node CI
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm test
```

### [PM2](/backend/pm2/) y Supervisi√≥n

* Clusterizaci√≥n + auto-restart.
* Monitorizaci√≥n con `pm2 monit`.
* Integraci√≥n con Keymetrics o Datadog.

---

## Serverless y Edge Functions

### Node.js en la Nube

* **AWS Lambda**, **Vercel**, **Netlify**, **Cloudflare Workers**.
* Ejecuci√≥n bajo demanda sin servidores persistentes.

### Ejemplo AWS Lambda

```js
export const handler = async (event) => {
	return {
		statusCode: 200,
		body: JSON.stringify({ msg: 'Hola desde Lambda!' })
	}
}
```

* R√°pido escalado autom√°tico.
* Facturaci√≥n por ejecuci√≥n.
* Ideal para microservicios peque√±os o endpoints event-driven.

---

## Observabilidad y Mantenimiento en Producci√≥n

### Logs centralizados

* Usar **Elastic Stack (ELK)** o **Grafana Loki**.
* Enviar logs de PM2 o Winston v√≠a HTTP o UDP.

### M√©tricas y Health Checks

```js
app.get('/health', (req, res) => res.json({ ok: true, uptime: process.uptime() }))
```

* Integrar **Prometheus client** para m√©tricas personalizadas.
* Monitorear tiempos de respuesta y heap usage.

### Profiling continuo

* Usar `clinic flame` o `0x` en entorno de staging.
* Detectar memory leaks y funciones bloqueantes.

---

## Conclusi√≥n

El ecosistema profesional de Node.js va mucho m√°s all√° del desarrollo de APIs.
Dominar **versionado, modularidad, tipado, colas, escalabilidad, seguridad, despliegue y observabilidad** permite construir arquitecturas s√≥lidas, eficientes y preparadas para entornos distribuidos o serverless, unificando el ciclo completo de desarrollo [Backend](/uncategorized/backend/) ‚Üí [devops](/uncategorized/devops/) ‚Üí [Testing](/testing/testing/) ‚Üí Producci√≥n.


# omnivore node js
```base
type: list
name: "Notas con #nodejs en Omnivore"
order:
  - property: date_saved
    direction: desc
columns:
  - file.name
  - date_saved
filters:
  and:
    - file.inFolder("Omnivore")
    - file.hasTag("nodejs")
views:
  - type: table
    name: Table
    sort:
      - property: file.mtime
        direction: DESC

```




