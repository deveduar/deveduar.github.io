---
date: 2024-11-16 17:40
title: Redux
tags:
keywords:
source:
status: üåü
Parent: "[[Area-Prog]]"
cssclasses:
public_note: "true"
category: redux
categories:
  - redux
  - react
  - angular
  - hide-embedded-header1
  - wide
  - Frontend
---
# Redux
`$= dv.current().file.tags.join(" ")`

- [Frontend](/uncategorized/frontend/)
- gestion de estado
- context api
- docs
	- [Documentaci√≥n oficial Redux](https://es.redux.js.org/)
	- [Herencia en Redux](https://es.redux.js.org/docs/introduccion/herencia.html)
- Comparativas:
	- redux vs akita
	- [redux vs context](https://github.com/academind/react-redux-vs-context) 
- alternativas
	- zustand

## Tareas Pendientes
-  **Redux** con **Next.js** siguiendo la gu√≠a:  
	- [Getting Started with Redux](https://redux.js.org/introduction/getting-started)
-  Redux con Angular usando **NgRx**
- [NgRx Store](https://ngrx.io/guide/store)
- [Uso de Redux](https://redux.js.org/usage/)
- [Redux + Next.js](https://redux.js.org/usage/nextjs)
## Fundamentos de Redux

Redux es un **contenedor predecible de estado** para aplicaciones JavaScript, basado en un flujo unidireccional y en la **inmutabilidad** del estado.

Redux trabaja sobre tres principios fundamentales:

1. **Store √∫nico**
- Una √∫nica fuente de la verdad que contiene el estado global.
- Estado inmutable: s√≥lo puede cambiarse mediante *actions* procesadas por *reducers*.
1. **Actions**
- Objetos simples `{ type: string, payload?: any }`.
- Describen *qu√© ocurri√≥*, no *c√≥mo cambia el estado*.
1. **Reducers**
- Funciones puras `(state, action) => newState`.
- Nunca mutan el estado directamente.
- Permiten mantener trazabilidad y reproducibilidad.

---

## Flujo Unidireccional
- Los componentes disparan **actions**.
- Las **actions** viajan al **store**.
- El **store** ejecuta los **reducers**.
- Los reducers generan un **nuevo estado**.
- Los componentes reciben la actualizaci√≥n mediante *suscripci√≥n*.

---

## Manejo Avanzado de Estado
### Middleware
- A√±aden capacidades entre el dispatch y el reducer.
- Ejemplos: *redux-thunk*, *redux-saga*, *redux-observable*.
- Permiten:
	- Control de flujos as√≠ncronos
	- Side-effects controlados
	- Logging, m√©tricas, seguridad y auditor√≠a

### Normalizaci√≥n de estado
- Evita estructuras anidadas dif√≠ciles de mantener.
- Se recomienda usar patrones tipo *entity store* o herramientas como **createEntityAdapter** (Redux Toolkit).

### Rehidrataci√≥n / Persistencia
- Permite restaurar estado desde localStorage o APIs.
- Complementos comunes: *redux-persist*.

---

## Redux DevTools
- Extensi√≥n para inspeccionar el store en tiempo real.
- Permite:
	- Ver actions disparadas
	- Ver la evoluci√≥n del estado
	- Time-travel debugging
	- Exportar y reproducir sesiones

---

## Redux Toolkit (RTK)
- API oficial recomendada.
- Simplifica:
	- Creaci√≥n de reducers con **createSlice**
	- Configuraci√≥n del store con **configureStore**
	- L√≥gica as√≠ncrona con **createAsyncThunk**
	- Inmutabilidad autom√°tica v√≠a *Immer*
- Reduce ceremonia y errores comunes.
- Integra buenas pr√°cticas por defecto.

### Conceptos clave de Redux Toolkit
- **Slices**: estado + reducers + actions en un mismo m√≥dulo.
- **Thunks**: funciones async que env√≠an actions antes/despu√©s.
- **RTK Query**: sistema integrado de fetch + caching para APIs.

---

## Integraciones y Ecosistema
### React
- Biblioteca est√°ndar: **react-redux**
- Hooks modernos:
	- `useSelector()`
	- `useDispatch()`
	- `useStore()`
- Recursos:
	- [Getting Started with Redux](https://redux.js.org/introduction/getting-started)
	- [Uso de Redux](https://redux.js.org/usage/)
	- [Redux + Next.js](https://redux.js.org/usage/nextjs)
	- [react](/frontend/react/), [nextjs](/frontend/nextjs/)

### Angular
- Implementaci√≥n recomendada: **NgRx**
- Basado en Redux pero adaptado a RxJS:
	- Stores reactivos
	- Effects (similar a sagas)
	- Reducers + actions al estilo Redux
- Recurso:
	- [NgRx - @ngrx/store](https://ngrx.io/guide/store)

### Comparaci√≥n: Redux vs Context API
- Context es adecuado para:
	- Estado simple o de alcance local
	- Theming, user session, peque√±os flags
- Redux es preferible cuando:
	- Hay m√∫ltiples flujos de estado complejos
	- Necesitas herramientas avanzadas (DevTools)
	- Control estricto del ciclo de estado
	- Sincronizaci√≥n con APIs complejas
- Recurso comparativo:  
	[Redux vs React Context](https://github.com/academind/react-redux-vs-context)

---


# Redux ‚Äî Conceptos Avanzados y Arquitecturas Modernas (2025)

## Arquitecturas basadas en Redux
### Feature-Based Architecture
- Organizaci√≥n del c√≥digo por **funcionalidades** en lugar de tipos (reducers, actions).
- Cada feature contiene:
	- Su slice (RTK)
	- Selectores
	- Componentes asociados
	- Side-effects
- Ventajas:
	- Escalabilidad
	- F√°cil mantenimiento
	- Menos coupling entre m√≥dulos

### Domain-Driven Redux
- Enfoque basado en el dominio, alineando Redux con los *bounded contexts* definidos en DDD.
- Cada dominio tiene:
	- Store propio (o slice)
	- Modelos de estado normalizados
	- Acciones espec√≠ficas del dominio
- √ötil para sistemas complejos (ERP, marketplaces, apps financieras).

---

## State Modeling en Redux
### Estado derivado (Derived State)
- Datos calculados a partir del estado primario usando **selectores**.
- Evita duplicaciones innecesarias.
- Se recomienda usar:
	- Selectores memoizados (ej.: `createSelector` de Reselect).
	- Selectores compuestos para c√°lculos pesados.

### Estado local vs Global
- Criterios para decidir si algo merece estar en Redux:
	- ¬øSe comparte entre multiple componentes?
	- ¬øNecesita persistencia?
	- ¬øRequiere trazabilidad?
	- ¬øEs necesario debugear su evoluci√≥n?

---

## Selectores Avanzados
- Memoizaci√≥n profunda para evitar renders innecesarios.
- Composici√≥n de selectores para reducir l√≥gica en componentes.
- Patrones:
	- Selector factories: selectores que aceptan par√°metros.
	- Encapsular selectores por feature.

---

## Patrones de Side Effects
### Redux Thunk Avanzado
- Thunks secuenciales y dependientes.
- Encadenamiento de side-effects.
- Cancelaci√≥n manual mediante se√±ales.

### Redux Saga
- Efectos as√≠ncronos declarativos:
	- `takeLatest`, `takeEvery`, `debounce`, `throttle`
- Adecuado para flujos complejos: pagos, transacciones, sockets.

### Redux Observable (RxJS)
- Para Angular o apps orientadas a streams.
- Manejo superior de flujos event-driven.

---

## Testing en Redux
### Reducers
- Pruebas puras: input del state anterior + action ‚Üí output esperado.

### Selectores
- Pruebas con estados simulados.
- Garantizar memoizaci√≥n.

### Middleware y l√≥gica as√≠ncrona
- Mock de APIs
- Fake timers
- Testing aislado del store

### RTK Query Testing
- Mock de endpoints
- Validaci√≥n del cache y estados: `pending ‚Üí fulfilled ‚Üí error`

---

## Patrones de Optimizaci√≥n
### Reducir Re-renders
- Uso adecuado de `useSelector` + memoizaci√≥n.
- Evitar selectores que devuelvan nuevas referencias.
- Slices peque√±os ‚Üí menor √°rea de notificaci√≥n.

### State Partitioning
- Divisi√≥n del estado global en dominios m√°s peque√±os.
- Permite lazy-loading de slices.

### Lazy Loading de Reducers
- Reducers que se inyectan din√°micamente.
- Ideal para aplicaciones con microfrontends o rutas cargadas bajo demanda.

---

## Redux en Aplicaciones Escalables (2025)
### Microfrontends
- Stores aislados por microfrontend.
- Sincronizaci√≥n mediante eventos o message bus.
- Adopci√≥n creciente de:
	- Module Federation + Redux
	- Web Components + stores locales sincronizados

### SSR y Streaming con Next.js
- Hidratar el store en servidor y enviarlo al cliente.
- RTK Query compatible con:
	- SSR
	- ISR
	- Rutas h√≠bridas

### Offline First
- Integraci√≥n con service workers.
- Persistencia del cache de RTK Query.
- Manejo de colas de acciones offline.

---

## Cu√°ndo No Usar Redux
- Estado estrictamente local.
- Funciones UI puras que no necesitan sincronizaci√≥n.
- Apps peque√±as sin side-effects complejos.
- Casos donde *signals* (Preact, Angular, Solid.js) ofrecen mejor granularidad reactiva.

---

## Nuevos Temas para Explorar
- Redux con **WebSockets** v√≠a Sagas u Observables.
- Patrones para sincronizar Redux con:
- IndexedDB
- BroadcastChannel
- Migraci√≥n a Redux Toolkit desde Redux cl√°sico.
- Dise√±o de stores para apps con IA embebida (contextos din√°micos).
- Aplicaci√≥n de Zod/TypeScript para validar payloads globales.

# Glosario de Redux (2025)

## Conceptos Fundamentales
- **Store**  
	Contenedor √∫nico del estado global de la aplicaci√≥n. Inmutable, solo se modifica mediante acciones procesadas por reducers.
- **State**  
	√Årbol de datos que representa el estado actual de la aplicaci√≥n.
- **Action**  
	Objeto plano que describe un evento: `{ type, payload }`.
- **Reducer**  
	Funci√≥n pura `(state, action) => newState` que devuelve un nuevo estado sin mutar el anterior.
- **Dispatch**  
	Mecanismo para enviar acciones al store.
- **Flujo Unidireccional**  
	Patr√≥n donde los datos siempre fluyen: View ‚Üí Action ‚Üí Reducer ‚Üí New State ‚Üí View.

---

## Redux Toolkit (RTK)
- **createSlice**  
	Crea reducers + actions asociados en un mismo m√≥dulo.
- **configureStore**  
	Utilidad para crear un store con middleware y devtools preconfigurados.
- **createAsyncThunk**  
	Genera thunks para l√≥gica as√≠ncrona con estados `pending / fulfilled / rejected`.
- **Immer**  
	Librer√≠a incluida en RTK que permite escribir ‚Äúc√≥digo mutable‚Äù produciendo estados inmutables.
- **RTK Query**  
	Sistema integrado para data fetching y caching con endpoints declarativos.

---

## Selectores
- **Selector**  
	Funci√≥n que obtiene una parte del estado: `(state) => state.user`.
- **Memoizaci√≥n**  
	T√©cnica para evitar recalcular valores derivados si el estado no cambi√≥.
- **createSelector (Reselect)**  
	Crea selectores memoizados eficientes.
- **Selector Factory**  
	Selector que recibe par√°metros: `(id) => createSelector(...)`.

---

## Middleware
- **Middleware**  
	Funciones que interceptan acciones antes de llegar al reducer.
- **redux-thunk**  
	Permite actions as√≠ncronas basadas en funciones.
- **redux-saga**  
	Manejo de side-effects declarativos mediante *generators* `function*`.
- **redux-observable**  
	Side-effects basados en RxJS (streams).
- **Logger Middleware**  
	Registra cada action y estado resultante.

---

## Manejo Avanzado del Estado
- **Estado Normalizado**  
	Estructura plana donde entidades se guardan por id. Facilita updates y evita duplicaci√≥n.
- **Entidad**  
	Unidad de datos con un identificador √∫nico (ej. usuario, producto).
- **createEntityAdapter**  
	Herramienta RTK para manejar colecciones normalizadas.
- **Derived State**  
	Estado que se calcula desde otros datos, no se guarda en el store.
- **Rehidrataci√≥n**  
	Proceso de restaurar el estado desde almacenamiento persistente.

---

## Integraci√≥n con Frameworks
### React
- **react-redux**  
	Biblioteca oficial para conectar componentes con el store.
- **Provider**  
	Componente que expone el store al √°rbol de componentes.
- **useSelector**  
	Hook para leer estado desde el store.
- **useDispatch**  
	Hook para despachar acciones.
- **useStore**  
	Acceso directo al store (poco habitual).

### Angular con NgRx
- **Actions**  
	Igual concepto que Redux cl√°sico pero con typings estrictos.
- **Reducers**  
	Mismo principio: funciones puras.
- **Effects**  
	Side-effects basados en RxJS streams.
- **Selectors Memoizados**  
	Fundamentales por naturaleza de Angular.

---

## Arquitectura y Organizaci√≥n
- **Feature-based Structure**  
	Organizaci√≥n del c√≥digo por funcionalidades.
- **Domain-driven Redux**  
	Store estructurado por dominios del negocio.
- **State Partitioning**  
	Divisi√≥n del estado en slices independientes.
- **Lazy Reducers**  
	Reducers cargados din√°micamente (√∫til en microfrontends).
- **Bounded Context**  
	Sub-dominios aut√≥nomos dentro del store global.

---

## Debug y Herramientas
- **Redux DevTools**  
	Extensi√≥n para inspeccionar acciones y estados.
- **Time Travel Debugging**  
	Permite navegar entre acciones para reproducir estados previos.
- **Action Replay**  
	Repetir acciones para reproducir un bug.

---

## Testing
- **Pruebas de Reducers**  
	Validan que `(state, action) ‚Üí newState` funcione correctamente.
- **Pruebas de Selectores**  
	Comprueban salidas con diferentes estados; verifican memoizaci√≥n.
- **Mock de Store**  
	Para probar componentes o l√≥gica aislada.
- **Testing de Thunks**  
	Mock de APIs y verificaci√≥n de dispatches.

---

## RTK Query
- **Endpoint**  
	Funci√≥n declarativa que define c√≥mo se obtiene o muta un recurso remoto.
- **Query**  
	Fetch de datos con caching autom√°tico.
- **Mutation**  
	Actualizar datos en el servidor.
- **Cache Tags**  
	Etiquetas que controlan invalidaciones autom√°ticas.
- **Auto-fetching**  
	Refetch autom√°tico seg√∫n reglas de invalidaci√≥n.

---

## Ecosistema y Casos Especiales
- **SSR con Next.js**  
	Hidrataci√≥n del estado entre servidor y cliente.
- **Persistencia**  
	Integraci√≥n con localStorage/IndexedDB (ej: redux-persist).
- **BroadcastChannel**  
	Sincronizaci√≥n de estado entre pesta√±as.
- **WebSockets + Redux**  
	Side-effects con sagas u observables para tiempo real.
- **Feature Toggles**  
	Flags de funcionalidades controlados desde Redux.
- **Offline First**  
	Colas de acciones, reintentos y cache persistente.

# Redux ‚Äî Ejemplos de C√≥digo (2025)

## Setup b√°sico de Redux (sin Toolkit)
### Store, Actions y Reducer
{% raw %}
```js
import { createStore } from "redux";

// Estado inicial
const initialState = {
	count: 0
};

// Actions
const INCREMENT = "INCREMENT";
const DECREMENT = "DECREMENT";

const increment = () => ({ type: INCREMENT });
const decrement = () => ({ type: DECREMENT });

// Reducer
function counterReducer(state = initialState, action) {
	switch (action.type) {
		case INCREMENT:
			return { ...state, count: state.count + 1 };
		case DECREMENT:
			return { ...state, count: state.count - 1 };
		default:
			return state;
	}
}

// Crear Store
const store = createStore(counterReducer);

// Usar el store
store.subscribe(() => console.log(store.getState()));

store.dispatch(increment());
store.dispatch(decrement());
```
{% endraw %}`

---

## Setup con Redux Toolkit (RTK)

### createSlice + configureStore

{% raw %}
```js
import { configureStore, createSlice } from "@reduxjs/toolkit";

const counterSlice = createSlice({
	name: "counter",
	initialState: { value: 0 },
	reducers: {
		increment: (state) => {
			state.value++;
		},
		decrement: (state) => {
			state.value--;
		},
		incrementBy: (state, action) => {
			state.value += action.payload;
		}
	}
});

export const { increment, decrement, incrementBy } = counterSlice.actions;

export const store = configureStore({
	reducer: {
		counter: counterSlice.reducer
	}
});
```
{% endraw %}

---

## Redux + React (React Redux)

### Provider

{% raw %}
```jsx
import React from "react";
import ReactDOM from "react-dom/client";
import { Provider } from "react-redux";
import { store } from "./store";
import App from "./App";

ReactDOM.createRoot(document.getElementById("root")).render(
	<Provider store={store}>
		<App />
	</Provider>
);
```
{% endraw %}

### Uso con `useSelector` y `useDispatch`

{% raw %}
```jsx
import { useSelector, useDispatch } from "react-redux";
import { increment, decrement, incrementBy } from "./store";

export default function Counter() {
	const count = useSelector((state) => state.counter.value);
	const dispatch = useDispatch();

	return (
		<div>
			<p>Valor actual: {count}</p>
			<button onClick={() => dispatch(increment())}>+1</button>
			<button onClick={() => dispatch(decrement())}>-1</button>
			<button onClick={() => dispatch(incrementBy(5))}>+5</button>
		</div>
	);
}
```
{% endraw %}

---

## Thunks con Redux Toolkit

### createAsyncThunk

{% raw %}
```js
import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";

export const fetchUser = createAsyncThunk(
	"user/fetch",
	async (id, thunkAPI) => {
		const res = await fetch(`https://jsonplaceholder.typicode.com/users/${id}`);
		return await res.json();
	}
);

const userSlice = createSlice({
	name: "user",
	initialState: {
		data: null,
		status: "idle",
		error: null
	},
	extraReducers: (builder) => {
		builder
			.addCase(fetchUser.pending, (state) => {
				state.status = "loading";
			})
			.addCase(fetchUser.fulfilled, (state, action) => {
				state.status = "succeeded";
				state.data = action.payload;
			})
			.addCase(fetchUser.rejected, (state, action) => {
				state.status = "failed";
				state.error = action.error.message;
			});
	}
});

export default userSlice.reducer;
```
{% endraw %}

---

## RTK Query ‚Äî Ejemplo completo

### API Service

{% raw %}
```js
import { createApi, fetchBaseQuery } from "@reduxjs/toolkit/query/react";

export const usersApi = createApi({
	reducerPath: "usersApi",
	baseQuery: fetchBaseQuery({ baseUrl: "https://jsonplaceholder.typicode.com" }),
	endpoints: (builder) => ({
		getUsers: builder.query({
			query: () => "/users"
		}),
		getUserById: builder.query({
			query: (id) => `/users/${id}`
		})
	})
});

export const { useGetUsersQuery, useGetUserByIdQuery } = usersApi;
```
{% endraw %}

### Integrar API en el Store

{% raw %}
```js
import { configureStore } from "@reduxjs/toolkit";
import { usersApi } from "./usersApi";

export const store = configureStore({
	reducer: {
		[usersApi.reducerPath]: usersApi.reducer
	},
	middleware: (getDefaultMiddleware) =>
		getDefaultMiddleware().concat(usersApi.middleware)
});
```
{% endraw %}

### Uso en un componente

{% raw %}
```jsx
import { useGetUsersQuery } from "./usersApi";

export default function UsersList() {
	const { data, isLoading, error } = useGetUsersQuery();

	if (isLoading) return <p>Cargando...</p>;
	if (error) return <p>Error: {error.message}</p>;

	return (
		<ul>
			{data.map((user) => (
				<li key={user.id}>{user.name}</li>
			))}
		</ul>
	);
}
```
{% endraw %}

---

## Selectores Memoizados con Reselect

{% raw %}
```js
import { createSelector } from "reselect";

const selectProducts = (state) => state.products.list;
const selectFilter = (state) => state.products.filter;

export const selectFilteredProducts = createSelector(
	[selectProducts, selectFilter],
	(products, filter) => {
		return products.filter((p) => p.category === filter);
	}
);
```
{% endraw %}

---

## Lazy Loading de Reducers

{% raw %}
```js
export function injectReducer(store, key, reducer) {
	if (!store.asyncReducers) store.asyncReducers = {};

	if (!store.asyncReducers[key]) {
		store.asyncReducers[key] = reducer;
		store.replaceReducer(
			combineReducers({
				...store.initialReducers,
				...store.asyncReducers
			})
		);
	}
}
```
{% endraw %}

---

## Middleware personalizado

{% raw %}
```js
const loggerMiddleware = (store) => (next) => (action) => {
	console.log("Dispatching:", action.type);
	const result = next(action);
	console.log("Next state:", store.getState());
	return result;
};

export const store = configureStore({
	reducer: rootReducer,
	middleware: (getDefaultMiddleware) =>
		getDefaultMiddleware().concat(loggerMiddleware)
});
```
{% endraw %}

# Redux ‚Äî Ejemplos Avanzados (2025)

## WebSockets + Redux (con Redux Saga)
### Configuraci√≥n del canal WebSocket
{% raw %}
```js
import { eventChannel } from "redux-saga";
import { call, take, put, takeEvery } from "redux-saga/effects";

function createSocketChannel(socket) {
	return eventChannel((emit) => {
		socket.onmessage = (event) => {
			emit(JSON.parse(event.data));
		};

		return () => socket.close();
	});
}

function* listenWebSocket() {
	const socket = new WebSocket("wss://example.com/events");
	const channel = yield call(createSocketChannel, socket);

	while (true) {
		const payload = yield take(channel);
		yield put({ type: "WS_MESSAGE_RECEIVED", payload });
	}
}

export function* rootSaga() {
	yield takeEvery("WS_CONNECT", listenWebSocket);
}
```
{% endraw %}`

---

## Microfrontends ‚Äî Injectar reducers din√°micamente

### Host cargando reducers remotos

{% raw %}
```js
export function injectRemoteReducer(store, sliceName, reducer) {
	if (!store.asyncReducers) store.asyncReducers = {};

	if (!store.asyncReducers[sliceName]) {
		store.asyncReducers[sliceName] = reducer;

		store.replaceReducer(
			combineReducers({
				...store.staticReducers,
				...store.asyncReducers
			})
		);
	}
}

// Ejemplo: microfrontend remoto expone un reducer
import remoteOrdersReducer from "remote/ordersSlice";

injectRemoteReducer(store, "orders", remoteOrdersReducer);
```
{% endraw %}

---

## SSR con Next.js + Redux Toolkit

### Store Hydration

{% raw %}
```js
// store.js
import { configureStore } from "@reduxjs/toolkit";
import counterReducer from "./counterSlice";

export function makeStore(preloadedState = {}) {
	return configureStore({
		reducer: { counter: counterReducer },
		preloadedState
	});
}
```
{% endraw %}

### Uso en getServerSideProps

{% raw %}
```js
// pages/index.js
import { makeStore } from "../store";
import { increment } from "../counterSlice";

export async function getServerSideProps() {
	const store = makeStore();
	store.dispatch(increment());

	return {
		props: {
			initialReduxState: store.getState()
		}
	};
}
```
{% endraw %}

### Hidratar en el cliente

{% raw %}
```js
// _app.js
import { Provider } from "react-redux";
import { makeStore } from "../store";

export default function App({ Component, pageProps }) {
	const store = makeStore(pageProps.initialReduxState);

	return (
		<Provider store={store}>
			<Component {...pageProps} />
		</Provider>
	);
}
```
{% endraw %}

---

## Redux + IndexedDB / Persistencia Offline

### Guardar y cargar estado

{% raw %}
```js
export const persistMiddleware = (store) => (next) => async (action) => {
	const result = next(action);

	const state = store.getState();
	await indexedDBInstance.save("state", state);

	return result;
};

export async function loadInitialState() {
	return (await indexedDBInstance.get("state")) || undefined;
}
```
{% endraw %}

### Inicializar el store con estado persistido

{% raw %}
```js
const preloaded = await loadInitialState();
const store = configureStore({ reducer, preloadedState: preloaded });
```
{% endraw %}

---

## RTK Query ‚Äî Actualizaci√≥n optimista (Optimistic Updates)

### Optimistic update usando `onQueryStarted`

{% raw %}
```js
import { createApi, fetchBaseQuery } from "@reduxjs/toolkit/query/react";

export const todosApi = createApi({
	reducerPath: "todosApi",
	baseQuery: fetchBaseQuery({ baseUrl: "/api" }),
	endpoints: (builder) => ({
		updateTodo: builder.mutation({
			query: (todo) => ({
				url: `/todos/${todo.id}`,
				method: "PUT",
				body: todo
			}),
			async onQueryStarted(todo, { dispatch, queryFulfilled }) {
				const patch = dispatch(
					todosApi.util.updateQueryData("getTodos", undefined, (draft) => {
						const item = draft.find((i) => i.id === todo.id);
						Object.assign(item, todo);
					})
				);

				try {
					await queryFulfilled;
				} catch {
					patch.undo();
				}
			}
		})
	})
});
```
{% endraw %}

---

## Redux Saga ‚Äî Retry, Debounce y Flujo Complejo

### Ejemplo con `retry` + `debounce`

{% raw %}
```js
import { debounce, retry, call, put } from "redux-saga/effects";

function* fetchSearch(action) {
	try {
		const data = yield retry(3, 1000, fetch, `/search?q=${action.payload}`);
		yield put({ type: "SEARCH_SUCCESS", payload: data });
	} catch (e) {
		yield put({ type: "SEARCH_ERROR", error: e.message });
	}
}

export function* searchSaga() {
	yield debounce(400, "SEARCH_REQUEST", fetchSearch);
}
```
{% endraw %}

---

## Patrones Event-Driven (Redux Observable)

### Transformar streams con RxJS

{% raw %}
```ts
import { ofType } from "redux-observable";
import { map, mergeMap, debounceTime } from "rxjs/operators";
import { ajax } from "rxjs/ajax";

export const searchEpic = (action$) =>
	action$.pipe(
		ofType("SEARCH_TERM_CHANGED"),
		debounceTime(300),
		mergeMap((action) =>
			ajax.getJSON(`/search?q=${action.payload}`).pipe(
				map((response) => ({ type: "SEARCH_SUCCESS", payload: response }))
			)
		)
	);
```
{% endraw %}

---

## Normalizaci√≥n de Datos (EntityAdapter)

### Ejemplo completo

{% raw %}
```js
import { createSlice, createEntityAdapter } from "@reduxjs/toolkit";

const productsAdapter = createEntityAdapter({
	selectId: (product) => product.id,
	sortComparer: (a, b) => a.name.localeCompare(b.name)
});

const productsSlice = createSlice({
	name: "products",
	initialState: productsAdapter.getInitialState(),
	reducers: {
		setProducts: productsAdapter.setAll,
		addProduct: productsAdapter.addOne,
		updateProduct: productsAdapter.updateOne,
		removeProduct: productsAdapter.removeOne
	}
});

export const productsSelectors = productsAdapter.getSelectors(
	(state) => state.products
);
```
{% endraw %}

---

## Redux Middleware Avanzado ‚Äî Eventos Globales

### BroadcastChannel para sincronizar pesta√±as

{% raw %}
```js
const bc = new BroadcastChannel("redux-sync");

export const syncMiddleware = (store) => (next) => (action) => {
	const result = next(action);
	bc.postMessage(action);
	return result;
};

bc.onmessage = (ev) => {
	store.dispatch(ev.data);
};
```
{% endraw %}

---

## Middleware de Auditor√≠a (traza de acciones)

{% raw %}
```js
const auditMiddleware = (store) => (next) => (action) => {
	const start = performance.now();

	const result = next(action);

	const duration = performance.now() - start;
	console.log(`[AUDIT] Action: ${action.type} (${duration.toFixed(2)}ms)`);

	return result;
};
```
{% endraw %}

---

## Automatizaci√≥n de Flujos con createListenerMiddleware

### Escuchar acciones sin Sagas/Thunks

{% raw %}
```js
import { createListenerMiddleware } from "@reduxjs/toolkit";

const listener = createListenerMiddleware();

listener.startListening({
	actionCreator: loginSuccess,
	effect: async (action, listenerApi) => {
		await listenerApi.delay(300);
		listenerApi.dispatch(fetchUserData(action.payload.id));
	}
});

const store = configureStore({
	reducer,
	middleware: (gdm) => gdm().prepend(listener.middleware)
});
```
{% endraw %}

{% raw %}
```

Si quieres, puedo generarte otra nota con **patrones arquitect√≥nicos avanzados**, **microfrontends + Redux Toolkit**, **SSR extremo**, o **RTK Query + WebSockets**.
```
{% endraw %}



# Omnivore Redux
{% raw %}
```base
type: list
name: "Notas con #powershell en redux"
order:
  - property: date_saved
    direction: desc
columns:
  - file.name
  - date_saved
filters:
  and:
    - file.inFolder("Omnivore")
    - file.hasTag("redux", "Redux")
views:
  - type: table
    name: Table
    sort:
      - property: file.mtime
        direction: DESC

```
{% endraw %}



