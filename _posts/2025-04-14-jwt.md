---
date: 2025-04-14 19:45
title: JWT
keywords:
source:
status: üöÄ
Parent: "[[Area-Sistemas]]"
public_note: "true"
category: autenticacion
tags:
  - JWT
  - autenticacion
  - criptografia
---
# JWT
`$= dv.current().file.tags.join(" ")`

- [autenticacion](/uncategorized/autenticacion/)
- [criptografia](/autenticacion/criptografia/)

## Concepto General
- JSON Web Tokens: mecanismo compacto para **compartir data**, transportar identidades y claims entre partes de forma segura.
- Basados en el est√°ndar **JOSE** (JSON Object Signing and Encryption).
- Usan **clave p√∫blica/privada** o **claves sim√©tricas** seg√∫n el tipo de firma o cifrado.
- Componentes:
	- **JOSE Header**: metadatos sobre algoritmo, tipo y par√°metros.
	- **JWS Payload**: claims (est√°ndar, p√∫blicos, privados).
	- **JWS Signature**: validaci√≥n de integridad frente a alteraciones.

Enlaces:
- [JSON Web tokens (JWT): claves para usarlos de manera segura | BBVA](https://www.bbva.com/es/innovacion/json-web-tokens-jwt-claves-para-usarlos-de-manera-segura/)  
- [Qu√© es Json Web Token y c√≥mo funciona | OpenWebinars](https://openwebinars.net/blog/que-es-json-web-token-y-como-funciona/)  
- [¬øQu√© es JSON Web Token? | KeepCoding](https://keepcoding.io/blog/que-es-json-web-token/)  
- [RFC 7515 - JSON Web Signature (JWS)](https://datatracker.ietf.org/doc/html/rfc7515)

## Estructura del JWT
- **Header**
	- algoritmo (`alg`)
	- tipo (`typ`: "JWT")
	- par√°metros JOSE adicionales (`kid`, `cty`, etc.)
- **Payload**
	- claims est√°ndar (iss, sub, aud, exp, nbf, iat, jti)
	- claims personalizados para negocio
	- evitar incluir data sensible sin cifrado
- **Signature**
	- firmada usando JWS
	- garantiza integridad y autenticidad

## Seguridad y Buenas Pr√°cticas
- Usar **algoritmos seguros**: ES256/ES384/ES512, RS256/RS512, PS256/PS512.
- Evitar **HS256** para escenarios de alta exposici√≥n cuando sea posible.
- Rotaci√≥n de claves con **JWK / JWKS**.
- Tokens deben tener:
	- `exp` corto
	- `nbf` y `iat`
	- `aud` y `iss` verificados siempre
- Almacenamiento:
	- evitar localStorage en navegadores sensibles al XSS
	- preferir cookies **HttpOnly + Secure + SameSite**
- Validar siempre:
	- firma
	- algoritmo permitido
	- expiraci√≥n
	- emisor y audiencia
- Para data sensible ‚Üí usar **JWE** en lugar de JWT plano.

## Modos JOSE Relacionados
- What is JWT, JWS, JWE, and JWK

## JWS ‚Äî Signature
- Mecanismo para **firmar data**.
- Garantiza integridad y autenticidad sin cifrado.
- JSON Web Signature permite tokens firmados con algoritmos:
	- HMAC (HS256‚Ä¶)
	- RSA (RS256‚Ä¶)
	- ECDSA (ES256‚Ä¶)
	- RSA-PSS (PS256‚Ä¶)
- Recursos:
	- [JSON Web Signature - Wikipedia](https://es.wikipedia.org/wiki/JSON_Web_Signature)
	- [JSON Web Signature (JWS)](https://blog.pleets.org/article/es/json-web-signature)
	- [Creaci√≥n de una firma JWS - IBM](https://www.ibm.com/docs/es/datapower-gateway/10.5.x?topic=encryption-creating-jws-signature)
	- [jwe-jws](https://developer.visa.com/pages/encryption_guide/jwe-jws)

## JWE ‚Äî Encryption
- JSON Web Encryption: **cifrado + integridad**.
- Adecuado para transmitir informaci√≥n sensible dentro del JWT.
- Soporta cifrado h√≠brido (clave de contenido + clave p√∫blica del receptor).
- Recursos:
	- [JSON Web Encryption - Wikipedia](https://en.wikipedia.org/wiki/JSON_Web_Encryption)
	- [What are JWT, JWS, JWE, JWK, and JWA?](https://www.loginradius.com/blog/engineering/guest-post/what-are-jwt-jws-jwe-jwk-jwa/)

## JWK ‚Äî Key Set
- Formato JSON para representar claves p√∫blicas/privadas.
- **JWKS**: conjunto de JWKs que se expone v√≠a HTTPS para permitir rotaci√≥n y descubrimiento autom√°tico.
- Usado para:
	- verificar firmas de JWT
	- distribuir claves de confianza
	- facilitar Key Rotation sin afectar a clientes
- Recursos:
	- [RFC 7517 - JSON Web Key (JWK)](https://datatracker.ietf.org/doc/html/rfc7517)

## Opciones Avanzadas
- **Token Binding**: asociar el token a un canal TLS.
- **Detecci√≥n de Replay**: jti + persistencia de IDs + exp cortos.
- **Signed + Encrypted (Nested JWT)**: combinaci√≥n JWE(JWS(payload)).
- **Proof-of-Possession JWT (PoP-JWT)**: el token requiere demostrar posesi√≥n de una clave.
- **Detached JWS**: firma separada del payload para grandes cargas.

# JWT Avanzado ‚Äî Extensi√≥n de Conceptos
`$= dv.current().file.tags.join(" ")`

## JWA ‚Äî JSON Web Algorithms
- Est√°ndar que define **algoritmos de firma, cifrado y hashing** usados en todo el ecosistema JOSE.
- Categor√≠as clave:
	- Algoritmos de firma: RSASSA, ECDSA, RSA-PSS.
	- Algoritmos de cifrado: A128GCM, A256CBC-HS512.
	- Algoritmos de intercambio de claves: ECDH-ES.
- Importancia:
	- Determina compatibilidad multiplataforma.
	- Define seguridad m√≠nima y algoritmos permitidos.
	- Base para pol√≠ticas de hardening de JWT.

Enlace: **RFC 7518**.

## JWK Thumbprint
- Hash √∫nico (digest SHA-256 usualmente) que representa una clave JWK.
- Permite:
	- Identificaci√≥n inequ√≠voca de una clave sin exponerla.
	- Asociar tokens a claves espec√≠ficas.
	- Firmar objetos que incluyan el thumbprint como claim (ej. PoP).
- √ötil en:
	- Integraciones federadas.
	- Rotaci√≥n agresiva de claves (Key Cycling).
	- Validaciones de cliente en OAuth2 y OpenID Connect.

## Estrategias Profesionales con `jti` (Unique Token ID)
- Evita **replay attacks** en sistemas sensibles.
- Patrones de uso:
	- Persistencia en Redis con TTL = exp del token.
	- Bloqueo temporal por jti para flujos cr√≠ticos de corta duraci√≥n.
	- Revocaci√≥n selectiva sin invalidar sesi√≥n completa.
- Extensiones:
	- jti + fingerprint del cliente
	- jti + binding del canal TLS
	- jti para correlaci√≥n en auditor√≠a distribuida

## Nested JWT (JWE(JWS(payload)))
- Combinaci√≥n de firma + cifrado.
- Uso:
	- Firmar el contenido para garantizar autenticidad.
	- Cifrar el token completo para ocultar claims sensibles.
- Ventaja:
	- Transferencia segura en entornos con m√∫ltiples hops y proxies.
- Relevante en:
	- banca
	- eIDAS
	- sistemas regulados (PCI, HIPAA)

## PoP Tokens (Proof-of-Possession)
- El token requiere demostrar que el cliente posee una clave secreta adicional.
- Diferencias con los Bearer Tokens:
	- No basta con robar el token.
	- Requiere prueba criptogr√°fica asociada.
- Casos:
	- APIs de alta criticidad.
	- Transacciones firmadas de forma independiente.
	- Microservicios con identidad fuerte.

## DPoP ‚Äî Demonstrating Proof of Possession
- Est√°ndar emergente para OAuth2.
- El cliente firma cada request HTTP con una clave privada.
- Previene:
	- replay entre endpoints
	- tokens robados en clientes p√∫blicos
- Estructura:
	- DPoP Header (alg + jwk)
	- DPoP Payload (htm, htu, jti, iat)
	- Firma JWS

## JWT Profile for OAuth2 / OIDC (IETF)
- Perfiles que definen:
	- C√≥mo estructurar claims obligatorios.
	- Qu√© algoritmos deben usarse.
	- Pol√≠ticas para `aud`, `iss`, `exp`, `nbf`, `sub`.
- Importante para:
	- interoperabilidad
	- cumplimiento de est√°ndares
	- evitar configuraciones d√©biles

## Authorization Server Metadata
- Descubrimiento autom√°tico v√≠a:
	- `/.well-known/openid-configuration`
	- `/.well-known/oauth-authorization-server`
- Expone:
	- JWKS endpoint
	- Algoritmos soportados
	- Pol√≠ticas de token
	- M√©todos de autenticaci√≥n de cliente
- Habilita:
	- Rotaci√≥n autom√°tica de claves
	- Validaci√≥n basada en metadatos
	- Integraci√≥n sin configuraci√≥n manual

## JWT en Arquitecturas Zero-Trust
- Rol clave:
	- Identidad verificable por cada hop.
	- Firmas fuertes con validaci√≥n descentralizada.
- Pr√°cticas:
	- TTL muy corto + Refresh Tokens fuera del per√≠metro.
	- PoP o DPoP para servicios internos.
	- Validaci√≥n estricta de `aud` para microservicios.

## Signed HTTP Requests (JWS over HTTP)
- Sustituye a API keys est√°ticas.
- Cada request va firmada:
	- m√©todo
	- path
	- fecha
	- cuerpo (hash)
- Beneficios:
	- No repudio
	- No captura de credenciales
	- Mensajes autenticados punto a punto
- Relaci√≥n con JWS:
	- Se usa JWS Detached (solo firma, sin embed del payload completo).

## JWT en WebAuthn / FIDO2
- WebAuthn usa COSE, pero interoperan con ecosistemas JWT mediante:
	- assertions firmadas
	- claves p√∫blicas almacenadas en JWKS
	- validadores basados en JOSE
- Se usa en:
	- autenticaci√≥n passwordless
	- acceso fuerte sin secretos compartidos

## Ataques Modernos Espec√≠ficos a JWT
- **Algorithm Confusion (alg=none / casper attacks)**
- **Key Injection en JWKs p√∫blicos**
- **Mix-Up attacks entre Authorization Servers**
- **Key-ID Spoofing (kid traversal)**
- **Replay en entornos multihop sin binding**
- **Cross-tenant key confusion en nubes**

## Protecci√≥n Avanzada
- Validar que `kid` existe en el JWKS.
- Validar que el algoritmo del header coincide con el esperado.
- Usar JWK Thumbprints para detectar claves alteradas.
- Rotaci√≥n continua con:
	- `x5t#S256`
	- `jkt`
	- `kid` din√°micos
- Cifrado de claims sensibles con JWE incluso dentro de entornos internos.

## JWT en Integraciones Empresariales
- Patrones:
	- Delegaci√≥n entre microservicios (Service-to-Service JWT)
	- JWT exchange (RFC 8693)
	- JWT assertion grants para autenticaci√≥n de cliente
- Uso en:
	- pagos
	- verificaci√≥n de identidad
	- auditor√≠a con no repudio

## Monitorizaci√≥n y Observabilidad
- M√©tricas √∫tiles:
	- ratio de tokens expirados
	- fallo en validaci√≥n por aud/iss
	- uso de claves rotadas
	- revocaciones por jti
- Trazabilidad:
	- incluir `jti` y `sub` en correlaci√≥n de logs
	- an√°lisis de anomal√≠as en firmas

## Hardening Operativo
- Pol√≠ticas:
	- deshabilitar HS256 si no hay razones fuertes
	- permitir solo PS256/ES256
	- expiraciones < 15 minutos en entornos web
	- refresh tokens en canales reforzados
- Mitigaciones:
	- Enforced TLS 1.3
	- Token Binding opcional
	- Nested JWT en entornos de terceros

