---
date: 2024-09-03 21:11
title: nextjs
keywords:
source:
status: üöÄ
Parent: "[[Area-Prog]]"
public_note: "true"
category: Frontend
tags:
  - JS
  - nextjs
  - React
---
# nextjs

- [Software engineering](/software%20engineering/software-engineering/)
- [react](/frontend/react/)
- [devops](/devops/devops/)
- [Backend](/backend/backend/)
- [Computer Science](/computer%20science/computer-science/)
- [javascript](/desarrollo%20web/javascript/)
- [Vercel](/cloud/vercel/)

- 
-  
-  üíª
- 

# Next.js 16 ‚Äî Arquitectura Avanzada y Patrones Modernos

## 1. Arquitectura Interna del Runtime en Next.js 16
Next.js 16 consolida varios runtimes:
- **Node.js Runtime**
	- Ideal para l√≥gica pesada, conexiones largas, ORMs, colas, workers.
- **Edge Runtime**
	- Para l√≥gica superligera, cach√© global, auth tokens, A/B testing.
- **Web Runtime**
	- C√≥digo del cliente y server components en build.

### Selecci√≥n del runtime (patr√≥n recomendado)
- Colocar en **server actions** la mutaci√≥n + validaci√≥n.
- Colocar l√≥gica global de auth en **proxy.ts** (antes middleware).
- Procesamiento intensivo ‚áí Node.js Runtime.
- Respuestas micro-cacheadas ‚áí Edge Runtime.

Referencia oficial:
- [Next.js Runtime Docs](https://nextjs.org/docs/app/building-your-application/routing/route-handlers#runtime-options)

---

## 2. Patr√≥n ‚ÄúFront + Actions + Services‚Äù
Patr√≥n moderno para aplicaciones grandes:

### 2.1 Componentes (UI)
- Server/Client components.
- Minimizar client components (coste en bundle + hydration).

### 2.2 Server Actions
- Validaci√≥n, mutaciones, persistencia.
- Desacoplarlos del UI exportando funciones puras.

### 2.3 Capa de Servicios
- Clases o funciones puras donde vive la l√≥gica de dominio.
- √ötil para:
	- Testing
	- Reutilizaci√≥n cross-rutas
	- Microservicios h√≠bridos

Ejemplo:
{% raw %}
```ts
// app/actions/create-user.ts
'use server'
import { userService } from '@/services/user-service'
export async function createUser(data) {
return userService.create(data)
}
```
{% endraw %}`

---

## 3. Arquitectura de Datos en Next.js 16

El modelo recomendado para 2025:

### 3.1 Acceso a DB con Runtimes M√∫ltiples

- Node.js Runtime para ORMs: Prisma, Drizzle, Kysely.
- Edge Runtime con:
- PlanetScale
- Neon (Postgres serverless)
- Upstash Redis
- LibSQL/Turso

### 3.2 Capa de Cach√© Multinivel

- Cach√© declarativa (`use cache`)
- Revalidaciones granulares (`revalidateTag`, `revalidatePath`)
- Edge cach√© con Vercel Edge

### 3.3 Streaming de Datos (React 19 + Next 16)

- Ideal para feeds, dashboards, reporting
- Mantiene TTFB bajo

---

## 4. Arquitectura de Rutas y Dominios de Contexto

Patr√≥n recomendado para proyectos grandes en App Router:

{% raw %}
```
/app
(auth) ‚Üí layouts y acciones de autenticaci√≥n
(dashboard)
	analytics/
	billing/
	users/
	api/‚Ä¶
```
{% endraw %}

Principios:
- Rutas agrupadas por **contexto**, no por tipo de archivo.
- Cada grupo con su propio layout + loading + error.
- Servicios compartidos debajo de `/lib` o `/services`.

---

## 5. Edge Patterns Modernos en Next.js 16

Next 16 mejora el modelo de **proxy.ts**, que centraliza el "network boundary":

Casos recomendados:
- Rate limiting
- Token refresh
- Redirecciones inteligentes
- Internationalizaci√≥n basada en geolocalizaci√≥n
- A/B testing + Feature flags

Documentaci√≥n base:
- [Next.js Middleware / Proxy](https://nextjs.org/docs/app/building-your-application/routing/middleware)

---

## 6. Renderizaci√≥n Estrat√©gica (SSR + ISR + PPR)

Next.js 16 habilita estrategias m√°s granulares:

### 6.1 SSR H√≠brido con Server Actions

{% raw %}
```
- Uso para dashboards con datos frescos.
```
{% endraw %}

### 6.2 ISR + `revalidateTag`

{% raw %}
```
- Revalidaci√≥n selectiva seg√∫n dominios de datos.
- Ideal para ecommerce, blogs, contenido masivo.
```
{% endraw %}

### 6.3 PPR (Partial Pre-Rendering)

{% raw %}
```
- Divide p√°gina en fragmentos precalculados + runtime.
- Reduce TTFB y coste din√°mico.
```
{% endraw %}

---

## 7. Colas, Jobs y Procesamiento As√≠ncrono

Next.js 16 funciona con colas externas usando Server Actions:

### Patrones comunes

- Webhooks + Server Actions
- Colas:
- Inngest
- Trigger.dev
- Upstash Queues

### Buenas pr√°cticas

- Delegar trabajos pesados a workers
- No bloquear server actions
- Cachear resultados intermedios con tags

---

## 8. Observabilidad, Logging y Monitorizaci√≥n

Moderna arquitectura para producci√≥n:

### Recomendado en Next.js 16

- Vercel Observability Layer
- Logging estructurado con Pino
- Trazas distribuidas (OpenTelemetry integrado)
- Uso de `server-timing` headers y anal√≠tica nativa

Docs:
- [Next.js Observability](https://nextjs.org/docs/app/building-your-application/optimizing/observability)

---

## 9. Arquitectura de CI/CD y Contenedores

### 9.1 CI/CD

- Tests en server actions
- Pruebas de rutas `route.js`
- Bundling con Turbopack en CI para detectar fallos

### 9.2 Contenedores

Patr√≥n recomendado para Next.js 16:
- Build multi-stage (Node 20+)
- Adaptar runtime detectado por Next para evitar errores edge/node.

---

## 10. DX Avanzado: Monorepos, Workspaces y Generadores

### Monorepo con Turborepo

- Capa de servicios compartidos
- Reutilizaci√≥n de UI components en librer√≠as internas

### Generadores modernos

- Plop.js
- Hygen
- Create fuzzy-templates para scaffolding

---

## 11. Seguridad 2025 en Next.js 16

- Protecci√≥n de Server Actions (validaci√≥n estricta)
- Sanitizaci√≥n con Zod o Valibot
- Tokens firmados en Edge Runtime
- Cabeceras de seguridad autom√°ticas en Vercel
- Autorizaci√≥n contextual por layout/routes

---

## 12. Lista de Recursos (formato Obsidian)

- [Next.js 16 Overview](https://nextjs.org/blog/next-16)
- [Next.js Runtime Options](https://nextjs.org/docs/app/building-your-application/routing/route-handlers#runtime-options)
- [Next.js Middleware / Proxy](https://nextjs.org/docs/app/building-your-application/routing/middleware)
- [React 19 + Server Actions Reference](https://react.dev/reference/react)


# Apuntes Next.js 16 ‚Äî Arquitectura y Fundamentos

---

## 1. Panorama General de Next.js 16
- Next.js 16 introduce mejoras en rendimiento, DX y cach√© expl√≠cita.
- Anuncio oficial:
	- [Next.js 16 ‚Äì Blog](https://nextjs.org/blog/next-16)

---

## 2. Bundler: Turbopack por Defecto
- Turbopack ahora es el bundler oficial:
	- Builds hasta **5√ó m√°s r√°pidas**
	- HMR hasta **10√ó m√°s r√°pido**
- Recursos:
	- [Next.js 16 ‚Äì Blog](https://nextjs.org/blog/next-16)
	- [Next.js 16: Major step forward for performance](https://medium.com/@badcaptain0001/next-js-16-is-here-a-major-step-forward-for-performance-dx-full-stack-architecture-77aa0bcb91f7)
	- [Next.js 16 Deep Dive](https://medium.com/@rtsekov/next-js-16-deep-dive-performance-caching-the-future-of-react-apps-76c1e55c583a)

---

## 3. Cach√© Expl√≠cita con Cache Components
Next.js 16 introduce un sistema de cach√© **manual y predecible**, basado en componentes cacheables con una directiva especial:

{% raw %}
```js
'use cache'
```
{% endraw %}`

### Activaci√≥n

{% raw %}
```ts
const nextConfig = {
  cacheComponents: true,
}
export default nextConfig
```
{% endraw %}

### Recursos oficiales

* [Next.js 16 ‚Äì Cache Components](https://nextjs.org/blog/next-16)
* [Next.js 16 Beta ‚Äì PPR & Caching](https://nextjs.org/blog/next-16-beta)

### Nuevas APIs relacionadas

* `revalidateTag()`
* [Rovidx ‚Äì Next 16 New Features](https://www.rovidx.com/blog/nextjs-16-new-features)
* `updateTag()`
* [Next.js 16 Performance Overview](https://medium.com/@badcaptain0001/next-js-16-is-here-a-major-step-forward-for-performance-dx-full-stack-architecture-77aa0bcb91f7)

---

## 4. Enrutamiento y Prefetching Mejorados

* Mejoras en tiempos de navegaci√≥n y deduplicaci√≥n de layouts.
* Prefetch inteligente basado en heur√≠sticas.
* Recursos:
  * [Next.js 16 Beta ‚Äì Routing changes](https://nextjs.org/blog/next-16-beta)
  * [Next.js 16 New Features](https://www.rovidx.com/blog/nextjs-16-new-features)

---

## 5. Reemplazo de `middleware.ts` ‚Üí `proxy.ts`

* Nuevo archivo **`proxy.ts`** que sustituye a `middleware.ts`.
* Modelo m√°s claro basado en ‚Äúnetwork boundary‚Äù.
* Recursos:

  * [Next.js 16 ‚Äì Blog](https://nextjs.org/blog/next-16)
  * [Next.js 16 Release Summary](https://talent500.com/blog/nextjs-16-release-features-benefits/)
  * [Next.js 16 ‚Äì What‚Äôs New (LogRocket)](https://blog.logrocket.com/next-js-16-whats-new/)

---

## 6. Next.js DevTools MCP

* Nueva integraci√≥n con el est√°ndar **Model Context Protocol (MCP)**.
* Permite a agentes/AI acceder a:

  * info del proyecto
  * rutas
  * estado del build
  * logs
* Recurso:

  * [Next.js DevTools MCP](https://nextjs.org/blog/next-16#nextjs-devtools-mcp)

---

## 7. Mejoras en Server Actions

* Rendimiento optimizado.
* Menos sobrecarga en el servidor.
* Mutaciones m√°s r√°pidas.
* Integraci√≥n con cach√© y PPR.
* Recurso:

  * [Next.js 16 ‚Äì Release Notes](https://nextjs.org/blog/next-16)

---

## 8. Partial Pre-Rendering (PPR)

* Sistema h√≠brido:
  * partes renderizadas estaticamente
  * partes que se resuelven bajo demanda
* Reduce TTFB y mejora cach√© granular.
* Recurso:

  * [Next.js 16 Beta ‚Äì PPR](https://nextjs.org/blog/next-16-beta)

---

## 9. Mejoras DX (Developer Experience)

* Turbopack Dev Server m√°s estable.
* Errores con stacktrace mejorado.
* Renderizado m√°s consistente entre server/client.
* Recurso:

  * [Next.js 16 Overview](https://medium.com/@rtsekov/next-js-16-deep-dive-performance-caching-the-future-of-react-apps-76c1e55c583a)

---

## 10. Resumen de Cambios Clave en Next.js 16

* Turbopack por defecto ‚Üí velocidades enormes.
* Cach√© expl√≠cita con `use cache`.
* Sistema de tags para revalidaci√≥n manual.
* Nuevo `proxy.ts` reemplaza `middleware.ts`.
* DevTools integrados con MCP.
* Mejoras en enrutamiento y prefetch.
* PPR m√°s estable y eficiente.
* Server Actions m√°s r√°pidas.

---

## 11. Lecturas Recomendadas

* [Next.js 16 ‚Äì Release Notes](https://nextjs.org/blog/next-16)
* [Next.js 16 Beta ‚Äì Technical Breakdown](https://nextjs.org/blog/next-16-beta)
* [Deep Dive: Performance & Caching](https://medium.com/@rtsekov/next-js-16-deep-dive-performance-caching-the-future-of-react-apps-76c1e55c583a)
* [Next.js 16: New Features Summary](https://www.rovidx.com/blog/nextjs-16-new-features)


# Apuntes Next.js 14 ‚Äî Arquitectura, Fundamentos y Recursos

---

## 1. Introducci√≥n a Next.js
Next.js es un framework React moderno optimizado para:
- **Renderizado h√≠brido** (SSR, SSG, ISR)
- **Server Components** por defecto
- **Server Actions**
- **Rutas avanzadas** con App Router
- **Optimizaciones autom√°ticas**
- **Integraci√≥n profunda con Vercel**

---

## 2. Comandos Esenciales
- Crear proyecto:
	{% raw %}
```
	npx create-next-app@latest
	```
{% endraw %}

---

## 3. Plantillas y Ejemplos Oficiales
### 3.1 Repositorio de ejemplos
- [ ] [Next.js examples ‚Äî GitHub](https://github.com/vercel/next.js/tree/canary/examples)

### 3.2 Plantillas de Vercel
- [MongoDB Starter](https://vercel.com/templates/next.js/mongodb-starter)
- [Tailwind Blog Starter](https://vercel.com/templates/next.js/tailwind-css-starter-blog)
- [M√°s plantillas Next + Tailwind](https://vercel.com/templates/tailwind)

---

## 4. Starters y Boilerplates √∫tiles
- [Relivator Next.js Starter (revalidator)](https://github.com/blefnk/relivator-nextjs-starter)
- [Sass Starter (Rapidlaunch)](https://github.com/alifarooq9/rapidlaunch)

---

## 5. [Testing](/testing/testing/) en Next.js
- Test unitarios con React Testing Library, Jest o Vitest  

---

## 6. Fundamentos y Conceptos Modernos de Next.js
### 6.1 Server Components
- Renderizados en el servidor por defecto.
- Evitan enviar JS al cliente salvo cuando se usa `"use client"`.

### 6.2 Server Actions
- Acceso a:
	- cookies
	- headers
	- mutaciones en server
	- m√∫ltiples acciones en un mismo formulario
	- revalidaci√≥n autom√°tica
- Integraci√≥n sencilla con formularios.

### 6.3 Hooks Modernos recomendados
- `useTransition` ‚Üí para estados concurrentes.
- `useReducer` ‚Üí estados complejos.
- Evitar el uso excesivo de `useEffect`.

### 6.4 Buenas pr√°cticas
- Priorizar **Server Components**.
- Evitar fetch en el cliente salvo necesario.
- Reducir estados globales (usar server actions + fetch).
- Integraci√≥n simple con Firebase, Prisma, Convex, etc.

---

## 7. Plantillas y Ejemplos Destacados 

### 7.1 E-commerce con Next.js
- [Next Amazona v2 (Next eCommerce)](https://github.com/basir/next-amazona-v2)

### 7.2 Blog con MongoDB
- [Next Blog ‚Äî Repo completo](https://github.com/safak/next-blog/tree/completed)
- [Diagrama arquitectura DB](https://app.eraser.io/workspace/aSshPSKlaKr8XiddBdlv)

### 7.3 Clones de Notion (Next.js + Prisma + Tailwind)
- https://github.com/aafrzl/nextion
- https://github.com/abdallaamin/jotion
- https://github.com/konstantinmuenster/notion-clone
- https://github.com/dj1samsoe/notion-clone

### 7.4 App Threads Clone
- [Repo oficial (adrianhajdin)](https://github.com/adrianhajdin/threads)

### 7.5 App Gestor de Contrase√±as ‚Äî Next 14 + PWA
- [GitHub tarredev-password](https://github.dev/ratasi/tarredev-password)
- Incluye:
	- autenticaci√≥n
	- rutas protegidas
	- Prisma + DB
	- PWA

---

## 8. Integraciones y Stacks √∫tiles con Next.js
- **Convex + Tailwind + React + Next.js**
	- Uso recomendado para BaaS reactivo.
- **Firebase (Auth, Firestore, Storage)**  
- **Prisma ORM + PlanetScale / Neon / Supabase**
- **Auth.js (NextAuth)** para autenticaci√≥n moderna.

## 9. Recursos
- [Next.js Official Learn ‚Äî Foundations](https://nextjs.org/learn/foundations/about-nextjs/what-is-nextjs)

- NEXT.JS COOKBOOK
	- NEXT.JS COOKBOOK > Introduction



# Curso de Next 13 (2023) 

## Netflix Clone üéà
- [github nextflix](https://github.com/rajput-hemant/nextflix)
- Tecnolog√≠as usadas: framer motion, authentication, css modules, ISR, login sin password, GraphQL, authentication SDK Hasura, deploy en Vercel
- Integraci√≥n avanzada con animaciones, optimizaci√≥n de UI/UX y pipelines de despliegue

## Coffee Shop App ‚úî
- npx: instalaci√≥n temporal, prueba de paquetes, npm vs npx ‚Äî ¬øCu√°l es la Diferencia-
- Gu√≠as de actualizaci√≥n:
	- [guia de actualizaciones de next](https://nextjs.org/docs/pages/building-your-application/upgrading)
	- `npm audit`, `npm audit fix`, `npm install next@latest`
	- [webpack 5](https://nextjs.org/docs/messages/webpack5)
	- `--force`, actualizar react y react-dom
- [github coffee store](https://github.com/BernieTv/Coffee-Connoisseur/blob/main/pages/index.js)
- Localizador de stores de caf√©
- Workspace: 

## Features

### Tecnolog√≠as
- Node.js, SEO, Static Site Generation, Server Side Rendering, Incremental Site Regeneration
- Hydration, Serverless Functions, Airtable, SWR, React Hooks
- React 18, [react server components](https://nextjs.org/docs/app/building-your-application/rendering/server-components)
- Server side streaming: [loading ui and streaming](https://nextjs.org/docs/app/building-your-application/routing/loading-ui-and-streaming)
- ES Modules, importaci√≥n desde CDNs
- [ISR](https://nextjs.org/docs/pages/building-your-application/data-fetching/incremental-static-regeneration): revalidate, fallback
- Edge functions, Using Next.js‚Äô middleware and Edge Functions - LogRocket Blog, [edge runtime api](https://www.framer.com/motion/)
- Comparaci√≥n: Next.js vs Create React App
- SWC compiler, *websockets*

### Middleware
- Configuraciones entre API call y request
- Autenticaci√≥n, protecci√≥n de bots, redirects/rewrites, soporte para navegadores antiguos
- Flags, tests A/B, anal√≠tica, logging
- `pages/_middleware.js`
- Middleware API

### Serverless Functions
- Guardar credenciales en el lado del servidor
- API key, carpeta `/api`
- Funcionan bajo demanda: el servidor se enciende al recibir un request

### Entry Point: `_app`
- Componentes compartidos globalmente
- Afecta el body
- Cabezal con `<Head>` separado es posible

### Rendimiento
- Code splitting, `next build`, chunks
- Minificaci√≥n sin necesidad de webpack
- Image optimization: carga lazy
- Prefetching de assets

### SEO
- Metadata, bots
- `<Head>` component
- Ranking, crawling, indexing
- Meta tags, alt en im√°genes, sem√°ntica HTML
- An√°lisis de base de datos para contenido din√°mico

### Renderizado y Data Fetching

#### Static Site Generation (SSG)
- Generaci√≥n en build time
- Static data + external API
- Data almacenada en CDN
- `getStaticProps`

#### Server Side Rendering (SSR)
- Generado en cada request
- `getServerSideProps`
- Ideal para data que cambia r√°pido (ej: news feed)

#### Incremental Static Regeneration (ISR)
- Mezcla SSG + SSR
- Intervalos de regeneraci√≥n
- Primera request stale, segunda fresh
- `getStaticProps` con `revalidate`

#### Client Side Rendering (CSR)
- Render con React en el cliente
- Prerender parcial + data fetching client
- [client side fetching](https://nextjs.org/docs/pages/building-your-application/data-fetching/client-side)
- Ideal para dashboards

#### Pre-rendering y Hydration
- HTML est√°tico previo a React
- Bots y SEO
- Server rendering previo a hydration

### Routing
- File-system routing
- History API
- Rutas:
	- `index.js`: ruta ra√≠z
	- Nested routes
	- Dynamic routes: `[id].js`
		- `import { useRouter } from 'next/router'`
		- Router query object
- Linking:
	- `next/link` ‚Äî [link component](https://nextjs.org/docs/pages/api-reference/components/link)
	- Prop `scroll`: diferencias entre rutas din√°micas y no din√°micas
- API folder: backend logic + SSR

## Intro Componentes
- [x] [video curso](https://www.bilibili.com/video/BV1Um4y187Mz/?spm_id_from=333.337.search-card.all.click)
- [x] [video curso 2](https://www.bilibili.com/video/BV1Gc411N7ft/?spm_id_from=333.788.recommend_more_video.0)
- [x] [video cuso 3](https://www.bilibili.com/video/BV1Ss4y1M7HS/?p=11&spm_id_from=pageDriver)
- [ ] [video curso 4](https://www.bilibili.com/video/BV1Bs4y1M7nR/?spm_id_from=333.999.0.0)
- [ ] [video curso 5](https://www.bilibili.com/video/BV1Gh411F7BA/?spm_id_from=333.788.recommend_more_video.1)
- [x] crear app con next API y wireframe üî∫
- [ ] editar p√°gina 404 personalizada
- [ ] footer component
- [ ] fondo con [gradiente](https://meshgradient.com/)
- [ ] componente banner:
	- Props: buttonText, handleOnClick ‚Üí `handleOnBannerBtnClick`
- Head component de Next
- useRouter: [next useRouter](https://nextjs.org/docs/pages/api-reference/functions/use-router)
- `next/link`
- `next/image`: [image component](https://nextjs.org/docs/pages/api-reference/components/image)
- [ ] A√±adir fuentes:
	- En `_document.js` usando `<Head>`
	- Extender document model: [custom document](https://nextjs.org/docs/pages/building-your-application/routing/custom-document)
	- [Font Optimization](https://nextjs.org/docs/pages/building-your-application/optimizing/fonts)
- [ ] card component:
	- Props din√°micas `name` y `href`

### Otros y Refactor
- Condiciones de render: `stores.length > 0 &&`
- Error al acceder al JSON: nested arrays
- Destructuring y fallback: `router.fallback`
- Generaci√≥n de paths din√°micos:
	- `{ params: { id: coffeeStore.id.toString() }}`
- Funci√≥n de voto: `{handleUpVoteButton}`
- `/lib` directory:
	- `fetchCoffeeStores()`
	- `getUrlForCoffeeStores(latLong, 'coffee stores', limit)`
- Fetch para obtener ID de API
- `async` en `getStaticPaths`
- Fallback de im√°genes:
	- `imgUrl={coffeeStore.imgUrl || 'url'}`

## CSS Confs
- CSS variables: `--var`, declarar en `:root {}`
- Mobile first, media queries, breakpoints
- [ ] Layout home con grid:
	- [CSS-Guia completa > 13-CSS Grid](/uncategorized/css-guia-completa/#13-css-grid)
	- columnas, containers, cardLayout
- Generar CSS tipo glass: [css glass generator](https://ui.glass/generator/)
- Clases CSS din√°micas que no colisionan
- Combinar clases con classNames:
	- `import cls from "classnames"`
- Icons SVG desde [google fonts icons](https://fonts.google.com/icons)



## getStaticProps
- [ ] [getStaticProps](https://nextjs.org/docs/pages/building-your-application/data-fetching/get-static-props)
- Recibir props en **Home** desde el servidor.
- Guardar contenido de cada card en la CDN; posible integrar una API.
- Devuelve **static data**.
- Usado en rutas din√°micas: ``[id].js``.
- Props como key/value; la key suele ser el **id**.
- Se ejecuta **solo en el servidor**, nunca en el cliente.
- Corre en **build time**, excepto en dev mode que corre en client/server.
- Devolver data como props y usar ``find()``:
	- Comparar un id din√°mico con ``params.id``.
	- Convertir ``store.id`` mediante ``toString()``.
- ``useRouter()`` para acceder al id: ``router.query.id``.
- Usar ``params`` directamente o desde ``staticProps.params``.

### Ejemplo getStaticProps
{% raw %}
```js
export async function getStaticProps(context) {
const { params } = context;
const stores = await fetchStores();
const store = stores.find((s) => s.id.toString() === params.id);

return {
	props: {
		coffeeStore: store || null,
	},
};
}
```
{% endraw %}`

---

## getStaticPaths

- [ ] [getStaticPaths](https://nextjs.org/docs/pages/api-reference/functions/get-static-paths)
- Genera p√°ginas est√°ticas para **rutas din√°micas**.
- Define los paths prerenderizados.
- Solo se exporta en **pages din√°micas**.
- Se usa junto con **getStaticProps**.
- Solo corre en **build time**.
- Devuelve array de **paths** y un **fallback**.

### fallback key

- **fallback: false**
- Si la ruta no existe ‚Üí **404**.
- **fallback: true**
- Descarga la p√°gina bajo demanda.
- √ötil para muchas rutas.
- Si el ``find()`` devuelve undefined ‚Üí error en carga.
- **router.fallback == true**
- Indica que la p√°gina est√° gener√°ndose.

### Ejemplo getStaticPaths

{% raw %}
```js
export async function getStaticPaths() {
const stores = await fetchStores();

const paths = stores.map((store) => ({
	params: { id: store.id.toString() },
}));

return {
	paths,
	fallback: true,
};
}
```
{% endraw %}

---

## Obtener data de JSON o APIs

- Usar id en href para rutas din√°micas.
- Importar JSON y mapear contenido.
- Configurar dominio de im√°genes en ``next.config.js``.

### API Foursquare

- [ ] [Foursquare Docs](https://docs.foursquare.com/developer/reference/place-search)
- Place Search API para localizar stores.
- Query de tiendas por coordenadas.
- Limitar resultados + control de rate limiting.
- Integrar en ``getStaticProps`` como funci√≥n async:
- ``fetch(url, options)``
- ``response.json()``
- ``props: { coffeeStores: data.results }``

### Variables de entorno

- [ ] [Environment variables](https://nextjs.org/docs/pages/building-your-application/configuring/environment-variables)
- Guardar keys en ``process.env``.
- En options:  
``Authorization: process.env.NEXT_PUBLIC_FOURSQUARE_API_KEY``

### API Unsplash

- [ ] [Unsplash API](https://unsplash.com/documentation#search-photos)
- Obtener im√°genes din√°micas para cada store.
- SDK: https://github.com/unsplash/unsplash-js
- Funci√≥n ``search.getPhotos()``.
- Keys en env.
- Mapear urls e integrarlas en ``fetchCoffeeStores``.
- Condicionales:
- Si neighborhood vac√≠o ‚Üí `''`
- Si imgUrl vac√≠a ‚Üí `null`

### Buscar tiendas cercanas ‚Äî geolocation API

- [ ] [Geolocation API](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API)
- Crear hook: ``useTrackLocation``.
- Obtener lat/long del usuario.
- Solicitar permisos.
- Manejar errores y estado:
- ``isFindingLocation``
- ``setLocationErrorMsg('')``

### Ejemplo Hook

{% raw %}
```js
const useTrackLocation = () => {
const [latLong, setLatLong] = useState('');
const [errorMsg, setErrorMsg] = useState('');

function success(position) {
	const latitude = position.coords.latitude;
	const longitude = position.coords.longitude;
	setLatLong(`${latitude},${longitude}`);
	setErrorMsg('');
}

function error() {
	setErrorMsg('No se pudo obtener la ubicaci√≥n');
}

return { latLong, errorMsg };
};
```
{% endraw %}

---

## Context y Reducer

- fetch async a ``fetchCoffeeStores`` con limit.
- useEffect + try/catch en Home.
- Crear state global con Context API.
- En env usar ``NEXT_PUBLIC_``.
- ``[coffeeStores, setCoffeeStores]`` para stores cercanas.
- Extraer desde context:  ``const { coffeeStores, latLong } = state``  
- Manejar errores:
- ``coffeeStoresError``
- Problemas con props est√°ticas en ``[id].js`` + fallback.
- fallback false garantiza 404 si no existe store.

### Context API

- Using React Context for State Management with Next.js
- ``StoreProvider`` en ``_app.js``.
- Proveer: ``<StoreContext.Provider value={{ state, dispatch }}>``

### Reducer

- Extracting State Logic into a Reducer ‚Äì React
- Manejo de m√∫ltiples estados.
- ``ACTION_TYPES`` para dispatch.
- ``storeReducer`` aplica cambios via payload.

### Ejemplo Reducer

{% raw %}
```js
export const storeReducer = (state, action) => {
switch (action.type) {
	case ACTION_TYPES.SET_LAT_LONG:
		return { ...state, latLong: action.payload.latLong };
	case ACTION_TYPES.SET_COFFEE_STORES:
		return { ...state, coffeeStores: action.payload.coffeeStores };
	default:
		return state;
}
};
```
{% endraw %}

---

## Data no prerenderizada + fallback en ``[id].js``

- Combinar props est√°ticas + context + SWR (opcional).
- Acceder al id:   ``const { id } = router.query``  
- Obtener stores:  ``const { state: { coffeeStores } } = useContext(StoreContext)``  
- Usar ``initialProps``.
- Comprobar en useEffect:
- Si hay stores.
- Si initialProps est√° vac√≠o ‚Üí usar context.
- async ``handleCreateCoffeeStore`` para crear store en DB si no existe.

### Declarar props de store

{% raw %}
```js
const { id, name, voting, imgUrl, neighbourhood, address } = coffeeStore;
```
{% endraw %}

### Dependencias del useEffect

{% raw %}
```js
[id, initialProps.coffeeStore, coffeeStores, initialProps]
```
{% endraw %}

---

## Utilidad isEmpty

- Crear ``utils/index.js``.
- Comprobar si un objeto no tiene keys.
- Usado para decidir si usar fallback o props est√°ticas.

### C√≥digo isEmpty

{% raw %}
```js
export const isEmpty = (obj) => {
return Object.keys(obj).length === 0;
};
```
{% endraw %}

---

## Evitar circular dependencies

- Guardar context en carpeta dedicada: ``store-context.js``.
- Importar solo desde `_app.js` o componentes que lo usen.

## API Routes y Serverless Functions
- [API Routes](https://nextjs.org/docs/pages/building-your-application/routing/api-routes)
- Arquitectura h√≠brida: **server-side + client-side** en el mismo proyecto.
- Directorio: ``/pages/api/*.js`` ‚Üí c√≥digo backend dentro de Next.
- Cada file exporta **una √∫nica funci√≥n** como ``export default``.
- Firma est√°ndar:
	{% raw %}
```js
	export default function handler(req, res) {
		res.status(200).json({ message: 'OK' });
	}
	```
{% endraw %}
- El archivo define la **ruta din√°mica**:
	- ``pages/api/coffee-store.js`` ‚Üí ``/api/coffee-store``
	- ``pages/api/[slug].js`` ‚Üí rutas capturadas autom√°ticamente.
	- ``pages/api/[...slug].js`` ‚Üí capturar *todas las rutas* (catch-all).
- Orden de prioridades del enrutado basado en el filesystem.

### REST y m√©todos HTTP
- GET ‚Üí obtener recursos.
- POST ‚Üí crear.
- PUT ‚Üí actualizar.
- DELETE ‚Üí eliminar.
- La forma final de la API depende de la ruta definida en el filesystem.

### Serverless Functions
- Lambdas ejecutadas bajo demanda (Vercel / Netlify).
- Infraestructura manejada por el proveedor.
- Timeout, cold starts, rate limits.
- Ideal para:
	- Ops ligeras.
	- Integraci√≥n a DBs o APIs externas.
	- Auth + operaciones CRUD.

---

## Obtener stores por geolocaci√≥n usando API Routes
- Crear endpoint: ``/api/getCoffeeStoresByLocation``.
- Reutilizar ``fetchCoffeeStores`` dentro de la API route.
- Ejemplo:
	{% raw %}
```js
	const getCoffeeStoresByLocation = async (req, res) => {
		try {
			const { latLong, limit } = req.query;
			const stores = await fetchCoffeeStores(latLong, limit);
			res.status(200).json(stores);
		} catch (error) {
			res.status(500).json({ message: 'Error fetching', error });
		}
	};
	```
{% endraw %}
- **Importante**: si no se hace ``return`` o ``res.end()`` ‚Üí la funci√≥n se queda pendiente.

### Llamar a la API en Home con useEffect
{% raw %}
```js
const fetchedCoffeeStores = await fetch(
`/api/getCoffeeStoresByLocation?latLong=${latLong}&limit=30`
);
const data = await fetchedCoffeeStores.json();
setCoffeeStores(data);
setCoffeeStoresError('');
```
{% endraw %}`

### Integraci√≥n con getStaticProps

- A√±adir ``fetchCoffeeStores`` para cargar data inicial.
- Next permite ejecutarlo en servidor en build:
{% raw %}
```js
const coffeeStores = await fetchCoffeeStores();
return { props: { coffeeStores } };
```
{% endraw %}


---

## Arquitectura + Persistencia en Airtable

- CSR: obtener stores cercanas v√≠a API Routes.
- SSG: stores por ciudad pre-generadas.
- Flujo mixto:
1. SSG carga stores iniciales.
2. Context transmite la data.
3. Airtable persiste cada store si no existe.
- Problema: **al refrescar**, el context se pierde ‚Üí usar DB.

### Configuraci√≥n de Airtable

- Crear base:
- id (string)
- name
- voting (number)
- address
- neighbourhood
- Docs:
- https://airtable.com/developers/web/api/introduction  
- https://github.com/Airtable/airtable.js
- Variables:
- API key
- Base ID
- En ``.env.local``:
	``AIRTABLE_API_KEY=...``  
	``AIRTABLE_BASE_ID=...``

### Crear Coffee Store (POST)

- Endpoint: ``/api/createCoffeeStore``
- Pasos:
1. Leer ``req.method``
2. Validar ``req.body``
3. Buscar si existe ID con ``findRecordByFilter``
4. Crear si no existe
5. Minificar resultado

{% raw %}
```js
const records = await table.create([
{
	fields: {
		id,
		name,
		voting: voting || 0,
		address: address || '',
		neighbourhood: neighbourhood || '',
	},
},
]);
```
{% endraw %}

### Minificaci√≥n de registros

{% raw %}
```js
const getMinifiedRecord = (record) => ({
recordId: record.id,
...record.fields,
});

const getMinifiedRecords = (records) => {
return records.map(getMinifiedRecord);
};
```
{% endraw %}

### Usar Postman para probar

- GET: ``/api/getCoffeeStoreById?id=123``
- POST: ``/api/createCoffeeStore``
- PUT: ``/api/favouriteCoffeeStoreById`` (para votar)

---

## Integraci√≥n en `[id].js`

- Componentes manejan data combinada:
1. initialProps (SSG)
2. Context (CSR)
3. Airtable DB

### Flujo createCoffeeStore en frontend

{% raw %}
```js
const handleCreateCoffeeStore = async (coffeeStore) => {
try {
	const res = await fetch('/api/createCoffeeStore', {
		method: 'POST',
		body: JSON.stringify({
			...coffeeStore,
			neighbourhood: coffeeStore.neighbourhood || '',
		}),
	});
	await res.json();
} catch (error) {}
};
```
{% endraw %}

- Asegurar que IDs son strings.
- Se√±al: **votos no incrementan con SSG** ‚Üí depende de la DB.

---

## SWR ‚Äî Stale While Revalidate

- https://swr.vercel.app/es-ES
- Sincronizar votaciones entre UI y DB.
- Soluciona actualizaci√≥n as√≠ncrona + cache.

### Implementaci√≥n SWR

- Hook:
{% raw %}
```js
const { data, error } = useSWR(
	`/api/getCoffeeStoreById?id=${id}`,
	fetcher
);
```
{% endraw %}
- *useEffect* escucha cambios:
{% raw %}
```js
useEffect(() => {
	if (data && data.length > 0) {
		setCoffeeStore(data[0]);
		setVotingCount(data[0].voting);
	}
}, [data]);
```
{% endraw %}
- Si error ‚Üí mostrar mensaje.
{% raw %}
```

### Upvote (PUT)

```
{% endraw %}
- Endpoint: ``/api/favouriteCoffeeStoreById``
- L√≥gica:
1. Validar ID
2. Buscar registro con ``findRecordByFilter``
3. Incrementar voto:
	{% raw %}
```js
	const calculateVoting = parseInt(record.voting) + 1;
	```
{% endraw %}
4. Actualizar:
	{% raw %}
```js
	const updateRecord = await table.update([
		{
			id: record.recordId,
			fields: { voting: calculateVoting },
		},
	]);
	```
{% endraw %}
5. Devolver minificado

### Efecto colateral

- La app genera nuevos inserts cuando encuentra stores cercanas desde Foursquare ‚Üí se escriben en Airtable.

---

## Deploy: Vercel + Netlify

### Build

- ``npm run build`` ‚Üí ``next build``
- ``next start`` ‚Üí producci√≥n local
- Output con iconos para saber si las p√°ginas son:
- SSG
- ISR
- SSR

### Vercel

- Deploy autom√°tico con Git.
- Logs de serverless functions.
- Envs separadas para dev/prod.
- CDNs sirven las p√°ginas pre-generadas.

### Netlify

- Next.js plugin autom√°tico.
- Serverless functions soportadas.
- Imagenes:
- Requiere configuraci√≥n extra si Next < 13.5
- ``next.config.js``:
	{% raw %}
```js
	images: {
		domains: ['images.unsplash.com'],
	}
	```
{% endraw %}
- Si falla ‚Üí usar ``<img />`` HTML en vez de ``next/image``.

### Optimizaciones

- Comprobar con Pagespeed / Lighthouse.
- Asegurar:
- ``alt`` en im√°genes.
- ``<Head>`` con metas por p√°gina.
- Meta description din√°mica.

---

## Coffee Store ‚Äî Snippets √∫tiles

- `const Footer = () => {`
- `export default function Post({ postData, allPostsData }) {}`
- `import Document, { Html, Head, Main, NextScript } from 'next/document'`
- `class MyDocument extends Document {}`
- `className={cls("glass", styles.container)}`
- `module.exports = { images: { domains: ['...'], } }`
- `const getListOfCoffeeStorePhotos = async () => {}`
- `return unsplashResults.map(r => r.urls['small'])`
- `const [locationErrorMsg, setLocationErrorMsg] = useState('')`
- `const [isFindingLocation, setIsFindingLocation] = useState(false)`
- `const [coffeeStore, setCoffeeStore] = useState(initialProps.coffeeStore)`

- Airtable utils:
	- `const table = base('coffee-stores');`
	- `const findRecordByFilter = async (id) => {}`
	- `const createRecords = await table.create([ ... ])`
	- `return records.map(getMinifiedRecord)`
	- `const { id, name, neighbourhood, address, imgUrl, voting } = req.body`
# Omnivore Nextjs
{% raw %}
```base
type: list
name: "Notas con #nextjs en Omnivore"
order:
  - property: date_saved
    direction: desc
columns:
  - file.name
  - date_saved
filters:
  and:
    - file.inFolder("Omnivore")
    - file.hasTag("nextjs")
views:
  - type: table
    name: Table
    sort:
      - property: file.mtime
        direction: DESC

```
{% endraw %}



# Omnivore React

{% raw %}
```base
type: list
name: "Notas con #react en Omnivore"
order:
  - property: date_saved
    direction: desc
columns:
  - file.name
  - date_saved
filters:
  and:
    - file.inFolder("Omnivore")
    - file.hasTag("react", "React")
views:
  - type: table
    name: Table
    order:
      - file.name
      - source_domain
    sort:
      - property: file.mtime
        direction: DESC

```
{% endraw %}


# Omnivore next js highlights
{% raw %}
```dataviewjsc
// Configuraciones
const tagName = "nextjs";
const headName = "Highlights";

// Crear un array para almacenar las p√°ginas que contienen el tag "nextjs"
let pagesWithNextjs = [];

// Filtrar y recopilar las p√°ginas que tienen el tag "nextjs"
dv.pages('"Omnivore"').forEach(page => {
    if (page.tags && page.tags.includes(tagName)) {
        pagesWithNextjs.push(page);
    }
});

// Ordenar las p√°ginas por 'date_saved' en orden descendente
pagesWithNextjs.sort((a, b) => {
    return b.date_saved.localeCompare(a.date_saved);
});

// Iterar sobre cada p√°gina filtrada y ordenada
for (const page of pagesWithNextjs) {
    const content = await dv.io.load(page.file.path);
    const lines = content.split('\n');
    let output = [];
    let insideHead = false;

    // Recorrer cada l√≠nea del contenido
    for (const line of lines) {
        if (line.startsWith("## " + headName)) {
            insideHead = true;
        } else if (line.startsWith("# ") && insideHead) {
            insideHead = false;
            break;  // Salir del bucle cuando se encuentra el pr√≥ximo encabezado
        } else if (insideHead) {
            output.push(line);
        }
    }

    // Mostrar el contenido dentro del encabezado "Highlights" si hay contenido
    if (output.length > 0) {
        // Mostrar el enlace a la p√°gina arriba del contenido de "Highlights"
        dv.el('p', page.file.link).addClass("page-link");

        // Mostrar el contenido dentro del encabezado "Highlights"
        dv.paragraph(output.join('\n')).addClass("omni-pr");
    }
}

```
{% endraw %}


