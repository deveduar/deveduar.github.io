creation date: 2024-11-30 18:46
tags:
  - grafana
  - devops
  - data-science
  - monitoreo
keywords:
source:
status: üåü
Parent: "Area-Sistemas"
cssclasses:
  - hide-embedded-header1
  - wide
categories: "[monitoreo](/monitoreo/monitoreo/)"
public_note: "true"
# grafana

- [devops](/devops/devops/)
- [monitoreo](/monitoreo/monitoreo/)
- [prometheus](/monitoreo/prometheus/)
- [Data Science](/data%20science/data-science/)
- [Docker](/software%20engineering/docker/)
	- [hub.docker.com/r/grafana/grafana](https://hub.docker.com/r/grafana/grafana)
## Introducci√≥n
Grafana es una plataforma de **observabilidad** dise√±ada para visualizar, correlacionar y analizar datos provenientes de m√©tricas, logs, trazas y sistemas externos. Su principal fortaleza es la capacidad de construir dashboards avanzados y unificar m√∫ltiples fuentes de datos en un mismo panel. Forma parte de un ecosistema modular que incluye herramientas como **Prometheus**, **Loki**, **Mimir**, **Tempo**, y **Alloy**, lo que permite construir soluciones de monitoreo completas, escalables y adaptadas a arquitecturas modernas como microservicios y Kubernetes.

Ofrece:
- Integraci√≥n con decenas de or√≠genes de datos.
- Dashboards altamente personalizables.
- Consultas avanzadas mediante PromQL / LogQL.
- Alertas integradas.
- F√°cil despliegue mediante Docker o Kubernetes.
## Conceptos Clave
- **M√©tricas**
	- Datos num√©ricos que representan el estado y rendimiento de un servicio, sistema o aplicaci√≥n.
	- Se suelen capturar mediante **Prometheus**, **Grafana Agent**, **Alloy**, etc.
	- √ötiles para dashboards, alertas y an√°lisis de tendencias.
- **Telemetr√≠a**
	- Conjunto de m√©tricas, logs y trazas.
	- Permite observabilidad completa.
	- Suele gestionarse mediante el stack: **Grafana + Prometheus + Loki + Tempo** (incluir si lo usas).
- **Logging**
	- Registros textuales generados por aplicaciones y servicios.
	- Grafana se integra con **Loki** para ofrecer consulta eficiente y escalable.
- **Puertos habituales**
	- **3000** ‚Üí Interfaz web de Grafana.
	- **9090** ‚Üí Prometheus (si formas stack con √©l).
	- **3100** ‚Üí Loki (ingesti√≥n/query logs).
	- **9009 / 8080+** ‚Üí Servicios anexos (Mimir, Tempo, Alloy seg√∫n despliegue).

## Componentes y Servicios del Ecosistema Grafana
- **Mimir** (M√©tricas)
	- Sistema de almacenamiento horizontalmente escalable para m√©tricas de Prometheus.
	- Permite ingesti√≥n de alto volumen, retenci√≥n prolongada y clustering distribuido.
	- Ideal para ambientes multi-tenant o infra de gran escala.
		- [Grafana Mimir documentation | Grafana Mimir documentation](https://grafana.com/docs/mimir/latest/)
		- [Get started with Grafana Mimir | Grafana Mimir documentation](https://grafana.com/docs/mimir/latest/get-started/)
- **Loki** (Logs)
	- Sistema de logs indexado por etiquetas, altamente eficiente en almacenamiento.
	- Dise√±o inspirado en Prometheus.
	- Soporta consultas mediante **LogQL**.
		- [Logs Grafana Loki](https://industry40.systems/98)
		- [Get started with Grafana Loki | Grafana Loki documentation](https://grafana.com/docs/loki/latest/get-started/)
- **Alloy** (Agente)
	- Agente moderno de observabilidad que reemplaza y unifica funciones de Promtail, Agent y otros.
	- Permite pipelines personalizadas para logs, m√©tricas y telemetr√≠a.
	- Soporta ingesti√≥n, transformaci√≥n y env√≠o hacia Loki, Mimir, Prometheus u otros.
	- Ideal para despliegues en contenedores y Kubernetes.
		- [Grafana Alloy | Grafana Alloy documentation](https://grafana.com/docs/alloy/latest/)
		- [Run Grafana Alloy in a Docker container | Grafana Alloy documentation](https://grafana.com/docs/alloy/latest/set-up/install/docker/)

## Deploy con Docker
### docker-compose b√°sico para Grafana
{% raw %}
```yaml
services:
	grafana:
		image: grafana/grafana:latest
		container_name: grafana
		ports:
			- "3000:3000"
		volumes:
			- grafana_data:/var/lib/grafana
		environment:
			- GF_SECURITY_ADMIN_USER=admin
			- GF_SECURITY_ADMIN_PASSWORD=admin
volumes:
	grafana_data:
```
{% endraw %}`

### docker-compose para Loki + Promtail + Grafana

{% raw %}
```yaml
services:
	loki:
		image: grafana/loki:latest
		command: -config.file=/etc/loki/local-config.yaml
		ports:
			- "3100:3100"

	promtail:
		image: grafana/promtail:latest
		volumes:
			- /var/log:/var/log
			- ./promtail-config.yaml:/etc/promtail/config.yaml
		command: -config.file=/etc/promtail/config.yaml

	grafana:
		image: grafana/grafana:latest
		ports:
			- "3000:3000"
		depends_on:
			- loki
```
{% endraw %}

### docker-compose para Mimir (m√≠nimo)

{% raw %}
```yaml
services:
	mimir:
		image: grafana/mimir:latest
		ports:
			- "9009:9009"
		volumes:
			- ./mimir.yaml:/etc/mimir/mimir.yaml
		command: -config.file=/etc/mimir/mimir.yaml
```
{% endraw %}

## Consultas y Lenguajes

* **PromQL**
	* Lenguaje de consultas para m√©tricas en Prometheus/Mimir.
	* Permite consultas temporales, agregaciones y c√°lculos derivados.
* **LogQL**
	* Lenguaje de Loki para consultar logs.
	* Similar a PromQL pero adaptado a flujos de texto.
* **Grafana dashboards JSON**
	* Dashboards versionables mediante Git.
	* Permiten importar/exportar definiciones completas en JSON.

## Integraciones Comunes

* [Kubernetes](/virtualizacion/kubernetes/) (K8s)
	* Mimir + Loki + Alloy como stack de observabilidad moderno.
	* Dashboards listos en Grafana para nodos, pods, ingress, redes.
* Nube
	* AWS CloudWatch, Azure Monitor, GCP Monitoring.
	* Pipelines CI/CD
* Alertas automatizadas basadas en m√©tricas de performance o uso.
## Videos
* [Logs: Grafana LOKI, instalaci√≥n y configuraci√≥n - YouTube](https://youtu.be/rMvu5lUK7-I)

# Gu√≠a de C√≥digo para Lenguajes y Consultas en Grafana (PromQL, LogQL y JSON de Dashboards)

## Introducci√≥n
Esta gu√≠a re√∫ne ejemplos pr√°cticos de los lenguajes m√°s utilizados dentro del ecosistema de Grafana:  
- **PromQL** para consultar m√©tricas.  
- **LogQL** para consultas de logs en Loki.  
- **Dashboards JSON** para versionado e infraestructura como c√≥digo.

Todos los bloques de c√≥digo est√°n separados por headings propios para facilitar la lectura.


## PromQL ‚Äî Consultas de M√©tricas

### Selecci√≥n B√°sica de M√©tricas
{% raw %}
```promql
# M√©trica simple
node_cpu_seconds_total

# Filtrar por etiquetas
node_cpu_seconds_total{mode="idle"}

# Filtrar por m√∫ltiples etiquetas
http_requests_total{job="api", status="500"}
```
{% endraw %}`

### Agregaciones

{% raw %}
```promql
# Promedio de uso de CPU por instancia
avg(rate(node_cpu_seconds_total{mode!="idle"}[5m])) by (instance)

# Suma total de peticiones HTTP
sum(rate(http_requests_total[1m]))

# M√°ximo de uso de memoria por servicio
max(node_memory_Active_bytes) by (service)
```
{% endraw %}

### Rangos Temporales

{% raw %}
```promql
# CPU idle en los √∫ltimos 10m
node_cpu_seconds_total{mode="idle"}[10m]

# Tasa de peticiones por minuto
rate(http_requests_total[1m])
```
{% endraw %}

### Alertas en PromQL (para Alertmanager)

{% raw %}
```promql
# Alerta: CPU sobre el 90%
avg(rate(node_cpu_seconds_total{mode!="idle"}[5m])) by (instance) > 0.9
```
{% endraw %}


## LogQL ‚Äî Consultas de Logs en Loki

### Selecci√≥n B√°sica

{% raw %}
```logql
# Logs sin filtros
{job="nginx"}

# Filtrar por etiqueta + substring
{job="backend"} |= "error"

# Filtro negativo
{job="backend"} != "debug"
```
{% endraw %}

### Expresiones con Operadores

{% raw %}
```logql
# Contiene "timeout" o "failed"
{app="api"} |= "timeout" |= "failed"

# Filtra logs que NO contienen una palabra
{app="payments"} != "INFO"
```
{% endraw %}

### B√∫squeda con Expresiones Regulares

{% raw %}
```logql
# Coincidencia de patr√≥n de IP
{job="nginx"} |~ "(\\d+\\.){3}\\d+"
```
{% endraw %}

### Parsing y Extracci√≥n

{% raw %}
```logql
# Extraer valores usando patrones
{app="api"} 
| json 
| line_format "user={.user_id} status={.status}"
```
{% endraw %}

### M√©tricas Derivadas desde Logs

{% raw %}
```logql
# Contar errores por minuto
sum(rate({app="backend"} |= "error" [1m])) by (instance)

# Latencia promedio analizada desde logs JSON
avg_over_time(({app="api"} | json | unwrap duration)[5m])
```
{% endraw %}


## Dashboards JSON ‚Äî Infraestructura como C√≥digo

### Ejemplo de Panel Sencillo

{% raw %}
```json
{
	"title": "Uso de CPU",
	"type": "timeseries",
	"targets": [
		{
			"expr": "avg(rate(node_cpu_seconds_total{mode!=\"idle\"}[5m])) by (instance)",
			"legendFormat": "{{instance}}"
		}
	]
}
```
{% endraw %}

### Dashboard Completo M√≠nimo

{% raw %}
```json
{
	"dashboard": {
		"id": null,
		"title": "Dashboard de Ejemplo",
		"panels": [
			{
				"type": "timeseries",
				"title": "CPU por instancia",
				"targets": [
					{
						"expr": "rate(node_cpu_seconds_total{mode!=\"idle\"}[2m])",
						"legendFormat": "{{instance}}"
					}
				],
				"gridPos": { "x": 0, "y": 0, "w": 12, "h": 8 }
			}
		]
	},
	"overwrite": true
}
```
{% endraw %}

### Variables de Dashboard

{% raw %}
```json
{
	"name": "instance",
	"type": "query",
	"query": "label_values(node_cpu_seconds_total, instance)",
	"includeAll": true
}
```
{% endraw %}


## Ejemplos Combinados en Paneles

### M√©trica + LogQL como series superpuestas

{% raw %}
```json
{
	"type": "timeseries",
	"title": "Errores vs Requests",
	"targets": [
		{
			"expr": "sum(rate(http_requests_total{status=\"500\"}[5m]))",
			"legendFormat": "Errores 500"
		},
		{
			"expr": "sum(rate({app=\"api\"} |= \"error\" [5m]))",
			"legendFormat": "Errores LogQL"
		}
	]
}
```
{% endraw %}


## Plantillas √ötiles

### Plantilla para Panel de Logs

{% raw %}
```json
{
	"type": "logs",
	"title": "Logs del Backend",
	"targets": [
		{
			"expr": "{app=\"backend\"}"
		}
	]
}
```
{% endraw %}

### Panel de Estado (Stat)

{% raw %}
```json
{
	"type": "stat",
	"title": "Requests por minuto",
	"targets": [
		{
			"expr": "sum(rate(http_requests_total[1m]))"
		}
	]
}
```
{% endraw %}


## Referencias R√°pidas

- **PromQL:** Selecciona m√©tricas, filtra por etiquetas, aplica funciones ‚Üí dashboards/alertas.
- **LogQL:** Filtra logs, aplica parsers, deriva m√©tricas desde logs.
- **Dashboards JSON:** Infra as code, versionable, reproducible.
