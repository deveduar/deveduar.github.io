---
date: 2024-09-04T03:13:00
title: PHP
status: üåü
Parent: "[[Area-Prog]]"
public_note: "true"
category: Backend
tags:
  - PHP
  - WP
  - wordpress
---
# PHP

## Ecosistema General
- [CMS](/desarrollo%20web/cms/)
- [Moodle](/desarrollo%20web/moodle/)
- [Wordpress](/desarrollo%20web/wordpress/)
- PHP-mysql-old
- nixonLearningPHPMySQL2021
- [apache](/backend/apache/)
- [composer](/backend/composer/)

## Motores de Plantillas
- motor de plantillas
- [mustache](/motor%20de%20plantillas/mustache/)  
	- Motor de plantillas minimalista que separa completamente l√≥gica y presentaci√≥n.
	- √ötil en entornos donde se busca mantener control estricto sobre la vista sin a√±adir complejidad adicional.
	- Compatible con m√∫ltiples frameworks y sistemas como [Moodle](/desarrollo%20web/moodle/).

## Frameworks PHP
- [laravel](/backend/laravel/)
	- Framework moderno con enfoque en productividad, arquitectura limpia (MVC), Eloquent ORM, migraciones, colas, eventos y ecosistema s√≥lido.
	- Ideal para proyectos medianos y grandes con necesidades de escalabilidad y organizaci√≥n.
- CodeIgniter
	- Framework ligero, r√°pido y muy sencillo.
	- Ideal para proyectos peque√±os o APIs simples.
- Symfony
	- Framework robusto y modular.
	- Base de componentes utilizados incluso por [laravel](/backend/laravel/).
	- Enfoque empresarial, escalable y orientado a arquitectura limpia.

## Testing en PHP
### Conceptos
- [Testing](/testing/testing/)
	- Pruebas unitarias, de integraci√≥n, funcionales y end-to-end aplicadas al desarrollo en PHP.
	- Integraci√≥n con CI/CD y est√°ndares modernos de calidad.
	- Mejores pr√°cticas: alta cobertura, test aislados, mocks, fixtures y uso correcto del ciclo AAA (Arrange‚ÄìAct‚ÄìAssert).

### PHPUnit
- [PHPUnit](/testing/phpunit/)
	- Framework de testing est√°ndar en PHP.
	- Permite pruebas unitarias, test-driven development (TDD) y mocks integrados.
- Agregar PHPUnit a tu proyecto PHP con composer-agregar-phpunit-a-tu-proyecto-php-con-composer-53f7
	- Gu√≠a para integrar PHPUnit mediante [composer](/backend/composer/).
- Repositorio de ejemplo:
	- [GitHub - javleds/inicio-php-composer](https://github.com/javleds/inicio-php-composer/tree/master)

## Debug y Herramientas
- debug
	- Uso com√∫n de herramientas como `var_dump`, `dump()`, `dd()` en [laravel](/backend/laravel/), o depuraci√≥n avanzada con Xdebug.
	- Integraci√≥n con editores y an√°lisis de stack trace.
- PhpStorm
	- IDE completo para desarrollo PHP con integraci√≥n nativa con Xdebug, PHPUnit, composer, bases de datos y herramientas de refactorizaci√≥n.
	- Facilita la inspecci√≥n, debugging remoto y est√°ndares de calidad (PSR).

## Recursos y Aprendizaje
### Videos y Cursos
- videos php
	- [üî• 10 PROYECTOS COMPLETOS CON PHP - YouTube](https://youtu.be/w8CZFQZV_8Y)

# Gu√≠a Completa de PHP en 2025

## 1. Estado Actual de PHP (2025)

* PHP sigue siendo uno de los lenguajes backend m√°s usados gracias a su enorme ecosistema ([Wordpress](/desarrollo%20web/wordpress/), [Moodle](/desarrollo%20web/moodle/), e-commerce, APIs).
* PHP 8.3/8.4 ofrecen:

  * JIT mejorado.
  * Tipado m√°s estricto y √∫til.
  * Fibers + coroutines en frameworks modernos.
  * Performance muy superior al PHP 7.
* Composer es el est√°ndar absoluto de gesti√≥n de dependencias.

---

## 2. Fundamentos Modernos de PHP

### Sintaxis esencial y buenas pr√°cticas

* Tipos estrictos (`declare(strict_types=1)`).
* Clases y objetos como est√°ndar de dise√±o.
* Funciones puras y minimizaci√≥n de efectos secundarios.
* Namespaces obligatorios en cualquier c√≥digo profesional.
* Est√°ndares PSR:
  * PSR-1/PSR-12: estilo.
  * PSR-4: autoloading.
  * PSR-6/PSR-16: cach√©.
  * PSR-7/PSR-15: HTTP middleware.

### Ejemplo moderno minimalista

{% raw %}
```php
<?php
declare(strict_types=1);

namespace App;

class User {
	public function __construct(
		private string $name,
		private int $age
	) {}

	public function greet(): string {
		return "Hola, soy {$this->name}";
	}
}
```
{% endraw %}

---

## 3. Ecosistema y Herramientas

### Composer

* Est√°ndar de dependencias.
* Permite autoloading (PSR-4), paquetes, scripts y workflows.

### Servidores

* [apache](/backend/apache/) + PHP-FPM
* Nginx (mucho m√°s habitual en producci√≥n)
* Swoole / RoadRunner para PHP as√≠ncrono (2025 cada vez m√°s usado)

### IDE y debugging

* PhpStorm (l√≠der absoluto).
* Xdebug para profiling, tracing y debugging paso a paso.
* Integraci√≥n con Docker y testing.

---

## 4. Frameworks Modernos

### [laravel](/backend/laravel/)

* Ecosistema gigante, APIs, colas, broadcasting, migraciones, Eloquent ORM, Horizon, Sail.
* Arquitectura orientada a componentes.

### Symfony

* Framework empresarial, modular y base de Laravel.
* Ideal para arquitecturas hexagonales y c√≥digo mantenible a largo plazo.

### CodeIgniter / Slim / Lumen

* Microframeworks para APIs ligeras.

### Elecci√≥n del framework en 2025

* Proyectos grandes: Symfony o Laravel.
* Microservicios/API: Slim, Lumen, Mezzio.
* Moodle/WordPress: desarrollo por plugins ‚Üí PHP puro + frameworks internos.

---

## 5. Desarrollo Frontend + PHP en 2025

* PHP sigue siendo backend, pero integra f√°cilmente:

  * Vue/React/Next.js.
  * Inertia.js (Laravel).
  * Livewire/HTMX para componentes interactivos sin JS complejo.

---

## 6. Testing en PHP (2025)

### Herramientas clave

* [PHPUnit](/testing/phpunit/) (est√°ndar).
* PestPHP (2025: muy popular por su sintaxis minimalista).
* Mockery para mocks avanzados.
* Testing automatizado v√≠a CI/CD (GitHub Actions, GitLab CI).

### Ejemplo PHPUnit

{% raw %}
```php
<?php
use PHPUnit\Framework\TestCase;

class MathTest extends TestCase {
	public function test_sum() {
		$this->assertSame(10, 5 + 5);
	}
}
```
{% endraw %}

---

## 7. Arquitectura y Buenas Pr√°cticas

### Patrones modernos

* DDD (Domain Driven Design)
* CQRS + Event Sourcing
* Patr√≥n repositorio
* Arquitectura hexagonal
* SOLID aplicado realmente

### C√≥digo limpio en PHP

* Tipos siempre definidos.
* Clases por responsabilidad.
* Evitar funciones globales.
* Tests desde el d√≠a uno.
* Documentaci√≥n con PHPDoc solo cuando es necesario.

---

## 8. Bases de Datos y ORM

### Opciones comunes

* MySQL/MariaDB (PHP-mysql-old si lo necesitas por legacy).
* PostgreSQL (preferido en 2025).
* Redis para cach√© y colas.
* MongoDB para documentos.

### ORM modernos

* Eloquent (Laravel).
* Doctrine ORM (Symfony).

---

## 9. PHP As√≠ncrono en 2025

* RoadRunner 3 (muy r√°pido, producci√≥n real).
* Swoole + coroutines.
* Fibers integradas desde PHP 8 para concurrencia controlada.
* Ideal para:

  * websockets
  * scraping masivo
  * microservicios de alto rendimiento

---

## 10. Seguridad Moderna en PHP

* Escapar siempre salida en HTML (Twig, Blade, [mustache](/motor%20de%20plantillas/mustache/)).
* Sanitizaci√≥n de entrada.
* Hashing seguro: `password_hash()`.
* CSRF tokens.
* Headers de seguridad: CSP, HSTS.
* Uso obligatorio de HTTPS.
* Validaci√≥n estricta con DTOs.

---

## 11. PHP en Producci√≥n en 2025

### Stack recomendado

* Docker + PHP-FPM + Nginx.
* Supervisi√≥n:

  * Prometheus
  * Grafana
  * OpenTelemetry (tracing)
* Caching:

  * Opcache (obligatorio)
  * Redis
* CDNs para assets.

### Ejemplo Dockerfile moderno

{% raw %}
```dockerfile
FROM php:8.3-fpm

RUN apt-get update && apt-get install -y \
	git unzip libpq-dev \
	&& docker-php-ext-install pdo pdo_mysql pdo_pgsql

COPY . /var/www
WORKDIR /var/www

CMD ["php-fpm"]
```
{% endraw %}

---

## 12. PHP Legacy vs PHP Moderno

### PHP Legacy

* C√≥digo sin namespaces.
* Variables globales.
* Mezcla de HTML + l√≥gica.
* Sin composer.

### PHP Moderno (2025)

* PSR-4.
* Code style obligatorio.
* Testing.
* Inyecci√≥n de dependencias.
* Frameworks actualizados.
* Arquitectura limpia.

---
## 14. Mini Roadmap de Aprendizaje (2025)

1. Fundamentos del lenguaje (tipado, funciones, OOP).
2. Composer.
3. Framework actual (Laravel o Symfony).
4. Bases de datos y ORM.
5. Testing (PHPUnit / Pest).
6. Arquitectura limpia.
7. Seguridad.
8. Docker + despliegue.
9. Async PHP para tareas avanzadas.


## PHP para APIs Modernas (REST, GraphQL, JSON)
- Uso de controladores ligeros orientados a DTOs y validadores.
- Serializaci√≥n estandarizada con JSON:API.
- GraphQL: resolver din√°mico con Lighthouse (Laravel) o API Platform (Symfony).
- Middlewares PSR-7/15 para autenticaci√≥n, rate limit, logging y trazabilidad.

## Autenticaci√≥n y Autorizaci√≥n en PHP 2025
- JWT con rotaci√≥n segura de tokens y expiraci√≥n segmentada.
- OAuth2 y OpenID Connect para SSO corporativo.
- Implementaci√≥n de roles RBAC y permisos ABAC.
- Sistemas de refresh tokens basados en Redis para invalidez inmediata.

## PHP en Arquitecturas Distribuidas y Microservicios
- Integraci√≥n con colas: RabbitMQ para garant√≠as fuertes, Redis Streams para rapidez.
- Kafka para eventos de alta escala.
- Implementaci√≥n de patrones: Saga, Outbox, Event Choreography.
- Comunicaci√≥n interna mediante HTTP lightweight o mensajer√≠a as√≠ncrona.

## Programaci√≥n Avanzada en PHP
- Atributos nativos para definir metadata, rutas, validaci√≥n o acceso a servicios.
- Traits: reutilizaci√≥n controlada sin romper cohesi√≥n.
- Enums como reemplazo seguro de constantes.
- Generadores (`yield`) para procesar millones de registros sin agotar memoria.
- Fibers: concurrencia cooperativa para IO no bloqueante.

## CLI Profesional en PHP
- Uso de Symfony Console para crear herramientas internas y scripts de automatizaci√≥n.
- Comandos con autocompletado, prompts interactivos y validaci√≥n.
- Integraci√≥n con CRON o supervisores como systemd/dokku.

### Ejemplo m√≠nimo de CLI
{% raw %}
```php
<?php
use Symfony\Component\Console\Application;

$app = new Application();
$app->add(new MyCommand());
$app->run();
```
{% endraw %}`

## PHP para Alta Escala y Performance
- Preloading para cargar clases cr√≠ticas en memoria compartida.
- Opcache configurado con invalidate manual.
- Uso de Swoole/RoadRunner para servidores sin bloqueo.
- Estrategias de caching multi-capa: Redis, response caching, microcaching en Nginx.

## PHP Internals (Nivel Experto)
- Conceptos de zval y reference counting para entender performance real.
- Optimizaci√≥n de opcodes mediante JIT.
- Hooks internos para extensiones personalizadas.
- Ciclo de vida: interpretaci√≥n, compilaci√≥n, ejecuci√≥n y caching.

## Observabilidad en PHP con OpenTelemetry
- Instrumentaci√≥n de inicio-v√≠a-PSR.
- Exportaci√≥n a Grafana Tempo, Jaeger o Honeycomb.
- M√©tricas t√©cnicas: tiempo por request, fallas, throughput.
- Logs estructurados en JSON para correlaci√≥n autom√°tica.

## Integraci√≥n de PHP con Infraestructura Moderna
- Uso de Docker multi-stage para builds ligeros.
- Automatizaci√≥n con GitHub Actions o GitLab CI.
- Pipelines con an√°lisis est√°tico (PHPStan, Psalm).
- Deploys blue/green y canary.

# Arquitectura y Fundamentos de PHP

## Fundamentos Modernos de PHP
PHP 8.3+ establece un lenguaje orientado a tipado estricto, arquitectura limpia y c√≥digo mantenible.

### Tipado y Declaraciones Modernas
- `declare(strict_types=1)` obligatorio para garantizar integridad.
- Tipos escalares y objetos en par√°metros y retornos.
- Tipos compuestos (union types), tipos nullables y enums.
- Promoted properties en constructores para clases concisas.

### Estructura del Lenguaje
- Namespaces para evitar colisiones y organizar m√≥dulos.
- Autoloading mediante PSR-4 y [composer](/backend/composer/).
- Traits para reutilizar comportamiento sin herencia innecesaria.
- Enums como alternativa segura a constantes.

### Buenas Pr√°cticas
- Seguir PSR-12 (estilo), PSR-4 (autoloading) y PSR-3 (logging).
- Utilizar objetos inmuebles donde aplique.
- Uso de interfaces y clases finales para reducir acoplamiento.
- Separaci√≥n estricta de l√≥gica, datos y presentaci√≥n.
- Evitar concatenaci√≥n de strings ‚Üí usar interpolaci√≥n y sanitizaci√≥n.

## Arquitectura en PHP (2025)
La arquitectura moderna en PHP se centra en la escalabilidad, la desacoplaci√≥n y la mantenibilidad. La base es combinar PSR, patrones robustos y frameworks s√≥lidos como [laravel](/backend/laravel/) o Symfony.

### Arquitectura en Capas
- **Presentaci√≥n**: controladores, vistas (Blade, Twig, Mustache [mustache](/motor%20de%20plantillas/mustache/)).
- **Aplicaci√≥n**: casos de uso y flujos de negocio.
- **Dominio**: entidades, value objects, servicios de dominio.
- **Infraestructura**: repositorios, conectores externos, adaptadores.

### Arquitectura Hexagonal (Ports & Adapters)
- Los **puertos** representan interfaces del dominio.
- Los **adaptadores** conectan el mundo exterior (DB, APIs, colas).
- Aporta independencia del framework y facilita testing.
- Encaja perfectamente con Symfony y Laravel + repositorios.

### Domain Driven Design (DDD)
- Modelar el dominio con Entities y Value Objects claros.
- Contextos delimitados (bounded contexts).
- Servicios de dominio puros, sin dependencias externas.
- Evitar ‚Äúanemia del modelo‚Äù ‚Üí l√≥gica dentro del dominio, no en controladores.

### Patrones de Dise√±o Aplicados
- **Repository**: desacopla persistencia de dominio.
- **Service Layer**: orquesta casos de uso.
- **Factory**: crea objetos complejos.
- **Strategy**: para reglas de negocio intercambiables.
- **Decorator**: envolver servicios (cache, logging, tracing).
- **Command‚ÄìQuery Separation (CQS)**: claridad entre escribir y leer.

## Ciclo de Datos en PHP Moderno
- Entrada ‚Üí Request PSR-7.
- Middlewares PSR-15 aplican seguridad, logging y validaci√≥n.
- Controlador interpreta la acci√≥n.
- Caso de uso ejecuta reglas y dominio.
- Repositorio almacena y recupera datos.
- Respuesta estandarizada en JSON/HTML.

## Integraci√≥n con Frameworks
- [laravel](/backend/laravel/): arquitectura MVC refinada + servicios, jobs, events.
- Symfony: micro-kernel + servicios DI + componentes desacoplados.
- Adaptable tanto para monolitos modulares como microservicios.

## Renderizado y Plantillas
- [mustache](/motor%20de%20plantillas/mustache/): plantillas l√≥gicas cero.
- Blade (Laravel): plantillas expresivas.
- Twig (Symfony): seguro y estandarizado.
- Buenas pr√°cticas:
	- Nada de l√≥gica de negocio en las vistas.
	- Solo loops, condiciones b√°sicas, y sanitizaci√≥n.

## Testing y Mantenibilidad Arquitect√≥nica
- Tests del dominio sin bases de datos.
- Tests de infraestructura con mocks.
- Pruebas de integraci√≥n con [PHPUnit](/testing/phpunit/) y entornos containers.
- Contratos claros para evitar dependencias acopladas.

## Herramientas Esenciales
- [composer](/backend/composer/) para autoloading y dependencias.
- Xdebug para debugging profundo.
- PhpStan / Psalm para an√°lisis est√°tico.
- Monolog para logging estructurado.
- Contenedores de Inversi√≥n de Dependencias (DI) propios de frameworks.

## Arquitectura de APIs en PHP
- Controladores delgados ‚Üí l√≥gica fuera del controlador.
- Serializaci√≥n est√°ndar (JSON:API, DTOs).
- Middlewares para:
	- Autenticaci√≥n
	- Rate limiting
	- Logging
	- OpenTelemetry (tracing)
- Versionado real: `/v1`, `/v2`, o versionado impl√≠cito por media-type.

## PHP y el Servidor
- PHP-FPM como manejador principal.
- Opcache para performance cr√≠tico.
- Extensions y m√≥dulos para features (intl, gd, sodium).
- [apache](/backend/apache/) o Nginx + PHP-FPM en despliegues modernos.

## Ejemplo de Estructura Moderna de Proyecto
{% raw %}
```text
src/
	App/
		Domain/
		Application/
		Infrastructure/
		Shared/
config/
tests/
vendor/
public/
```
{% endraw %}`

## Ejemplo Base de Clase de Dominio

{% raw %}
```php
<?php
declare(strict_types=1);

namespace App\Domain\User;

class User {
	public function __construct(
		private string $id,
		private string $email
	) {}

	public function email(): string {
		return $this->email;
	}
}
```
{% endraw %}

## Ejemplo de Controlador Minimalista

{% raw %}
```php
<?php

use App\Application\GetUserHandler;

class UserController {
	public function show(string $id, GetUserHandler $handler) {
		$user = $handler->handle($id);
		return ['email' => $user->email()];
	}
}
```
{% endraw %}

# PHP ‚Äî Ejemplos de C√≥digo y Casos de Uso Pr√°ctico

## CRUD B√°sico con PHP Moderno (8.3+)
Ejemplo pr√°ctico de un flujo t√≠pico: crear, leer, actualizar y eliminar datos usando PDO y tipado estricto.

### Conexi√≥n a Base de Datos (PDO)
{% raw %}
```php
<?php
declare(strict_types=1);

function db(): PDO {
return new PDO('mysql:host=localhost;dbname=app', 'user', 'pass', [
	PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
	PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
]);
}
```
{% endraw %}`

### Crear Usuario

{% raw %}
```php
<?php
function createUser(string $email, string $name): int {
$stmt = db()->prepare("INSERT INTO users (email, name) VALUES (:email, :name)");
$stmt->execute(['email' => $email, 'name' => $name]);
return (int) db()->lastInsertId();
}
```
{% endraw %}

### Obtener Usuario

{% raw %}
```php
<?php
function getUser(int $id): ?array {
$stmt = db()->prepare("SELECT * FROM users WHERE id = :id");
$stmt->execute(['id' => $id]);
return $stmt->fetch() ?: null;
}
```
{% endraw %}

### Actualizar Usuario

{% raw %}
```php
<?php
function updateUser(int $id, string $email): bool {
$stmt = db()->prepare("UPDATE users SET email = :email WHERE id = :id");
return $stmt->execute(['email' => $email, 'id' => $id]);
}
```
{% endraw %}

### Eliminar Usuario

{% raw %}
```php
<?php
function deleteUser(int $id): bool {
$stmt = db()->prepare("DELETE FROM users WHERE id = :id");
return $stmt->execute(['id' => $id]);
}
```
{% endraw %}

---

## API REST Muy Simple (Sin Framework)

{% raw %}
```
Ejemplo realista de endpoint `/users/{id}` usando JSON y enrutamiento b√°sico.
```
{% endraw %}

### index.php

{% raw %}
```php
<?php
declare(strict_types=1);

header('Content-Type: application/json');

// Router muy b√°sico
$path = explode('/', trim($_SERVER['REQUEST_URI'], '/'));
$resource = $path[0] ?? null;
$id = (int) ($path[1] ?? 0);

if ($resource === 'users' && $id !== 0) {
echo json_encode(getUser($id));
exit;
}

http_response_code(404);
echo json_encode(['error' => 'Not found']);
```
{% endraw %}

---

## Validaci√≥n de Datos con Objetos de Valor

{% raw %}
```
Mostrar c√≥mo evitar errores y asegurar integridad usando Value Objects.
```
{% endraw %}

### Email Value Object

{% raw %}
```php
<?php
declare(strict_types=1);

class Email {
private string $value;

public function __construct(string $email) {
	if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
		throw new InvalidArgumentException("Email inv√°lido.");
	}
	$this->value = $email;
}

public function value(): string {
	return $this->value;
}
}
```
{% endraw %}

### Uso

{% raw %}
```php
$email = new Email("demo@ejemplo.com");
echo $email->value();
```
{% endraw %}

---

## Ejemplo de Servicio de Dominio (Arquitectura Limpia)

{% raw %}
```
Un caso de uso t√≠pico: registrar un usuario.
```
{% endraw %}

### Servicio RegisterUserService

{% raw %}
```php
<?php
declare(strict_types=1);

class RegisterUserService {
public function __construct(private UserRepository $repo) {}

public function handle(string $email, string $name): int {
	$user = new User(new Email($email), $name);
	return $this->repo->save($user);
}
}
```
{% endraw %}

---

## Ejemplo de Repositorio (Interface + Implementaci√≥n)

{% raw %}
```php
<?php
interface UserRepository {
public function save(User $user): int;
public function findById(int $id): ?User;
}
```
{% endraw %}

### Implementaci√≥n con PDO

{% raw %}
```php
<?php
class PdoUserRepository implements UserRepository {
public function save(User $user): int {
	$db = db();
	$stmt = $db->prepare(
		"INSERT INTO users (email, name) VALUES (:email, :name)"
	);
	$stmt->execute([
		'email' => $user->email()->value(),
		'name' => $user->name()
	]);
	return (int)$db->lastInsertId();
}

public function findById(int $id): ?User {
	$stmt = db()->prepare("SELECT * FROM users WHERE id = :id");
	$stmt->execute(['id' => $id]);
	$data = $stmt->fetch();
	if (!$data) return null;

	return new User(
		new Email($data['email']),
		$data['name']
	);
}
}
```
{% endraw %}

---

## Caso Real: Enviar Emails Autom√°ticos (SMTP)

{% raw %}
```php
<?php
use PHPMailer\PHPMailer\PHPMailer;

$mail = new PHPMailer();
$mail->isSMTP();
$mail->Host = 'smtp.example.com';
$mail->SMTPAuth = true;
$mail->Username = 'user';
$mail->Password = 'pass';
$mail->SMTPSecure = 'tls';
$mail->Port = 587;

$mail->setFrom('noreply@app.com');
$mail->addAddress('cliente@correo.com');
$mail->Subject = "Bienvenido";
$mail->Body = "Gracias por registrarte.";

$mail->send();
```
{% endraw %}

---

## Caso Real: Consumir una API Externa (Guzzle)

{% raw %}
```php
<?php
use GuzzleHttp\Client;

$client = new Client(['base_uri' => 'https://api.externa.com/']);

$response = $client->get('/usuarios');
$data = json_decode($response->getBody()->getContents(), true);

print_r($data);
```
{% endraw %}

---

## Caso Real: Cola de Trabajos (Jobs) con Redis

{% raw %}
```
Ideal para tareas as√≠ncronas: correos, PDFs, sincronizaciones.
```
{% endraw %}

### Producer

{% raw %}
```php
<?php
$redis = new Redis();
$redis->connect('localhost');

$redis->lPush('jobs', json_encode([
'type' => 'enviar_email',
'email' => 'demo@correo.com'
]));
```
{% endraw %}

### Worker

{% raw %}
```php
<?php
while (true) {
$job = $redis->rPop('jobs');
if ($job) {
	$data = json_decode($job, true);
	if ($data['type'] === 'enviar_email') {
		// l√≥gica de env√≠o
	}
}
sleep(1);
}
```
{% endraw %}

---

## Caso Real: Login Seguro con PHP

{% raw %}
```php
<?php
function login(string $email, string $password): bool {
$stmt = db()->prepare("SELECT * FROM users WHERE email = :email");
$stmt->execute(['email' => $email]);
$user = $stmt->fetch();

if (!$user) return false;
return password_verify($password, $user['password']);
}
```
{% endraw %}

---

## Caso Real: Generar CSV

{% raw %}
```php
<?php
$data = [
['id', 'name', 'email'],
[1, 'Juan', 'juan@mail.com'],
[2, 'Ana', 'ana@mail.com']
];

$fh = fopen('archivo.csv', 'w');

foreach ($data as $row) {
fputcsv($fh, $row);
}

fclose($fh);
```
{% endraw %}


# PHP ‚Äî Casos Pr√°cticos Avanzados (Arquitectura 2025)

## Introducci√≥n
Casos reales de alto nivel utilizados en plataformas empresariales, SaaS complejos y sistemas distribuidos modernos ‚Äî aplicados espec√≠ficamente con PHP 8.3/8.4.

---

# 1. CQRS Completo (Command + Query Separation)
Separaci√≥n expl√≠cita de modelos de lectura/escritura.

## Carpeta de comandos
{% raw %}
```

/src
/Command
CreateInvoice.php
/CommandHandler
CreateInvoiceHandler.php
/Query
GetInvoiceById.php
/QueryHandler
GetInvoiceByIdHandler.php

```
{% endraw %}`

## Command Handler
{% raw %}
```php
final class CreateInvoiceHandler {
    public function __construct(
        private InvoiceRepository $repo,
        private EventBus $events
    ) {}

    public function __invoke(CreateInvoice $cmd): void {
        $invoice = Invoice::create($cmd->customerId, $cmd->items);
        $this->repo->save($invoice);
        $this->events->dispatch(...$invoice->pullEvents());
    }
}
```
{% endraw %}`

## Query Handler

{% raw %}
```php
final class GetInvoiceByIdHandler {
    public function __construct(private PDO $db) {}

    public function __invoke(GetInvoiceById $query): array {
        $stmt = $this->db->prepare("SELECT * FROM invoices_view WHERE id = ?");
        $stmt->execute([$query->id]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }
}
```
{% endraw %}

---

# 2. Snapshotting de Eventos (Event Sourcing optimizado)

Reducir carga reconstruyendo el estado desde snapshots.

{% raw %}
```php
class SnapshotRepository {
    public function load(string $aggregateId): ?Snapshot {
        // load from snapshots table
    }
}

class AggregateRebuilder {
    public function rebuild(string $id, Snapshot $snapshot = null): Aggregate {
        $agg = $snapshot?->state ?? new Aggregate();
        $events = $this->eventStore->loadAfter($id, $snapshot?->version ?? null);

        foreach ($events as $event) $agg->apply($event);
        return $agg;
    }
}
```
{% endraw %}

---

# 3. API Hexagonal ‚Äî Entrada HTTP + Dominio + Adaptadores

Patr√≥n de puertos y adaptadores.

{% raw %}
```
/Application
	UseCase/RegisterUser.php
/Domain
	Entity/User.php
	Repository/UserRepository.php
/Infrastructure
	Http/RegisterUserController.php
	Persistence/UserRepositoryMySQL.php
```
{% endraw %}

### Controlador (Adaptador de entrada)

{% raw %}
```php
class RegisterUserController {
    public function __construct(private RegisterUser $usecase) {}

    public function __invoke(): void {
        $payload = json_decode(file_get_contents('php://input'), true);
        $this->usecase->execute($payload['email']);
        echo json_encode(['status' => 'ok']);
    }
}
```
{% endraw %}

### Caso de uso (Aplicaci√≥n)

{% raw %}
```php
class RegisterUser {
    public function __construct(private UserRepository $repo) {}

    public function execute(string $email): void {
        $user = User::register($email);
        $this->repo->save($user);
    }
}
```
{% endraw %}

---

# 4. Event Mesh con NATS / Kafka desde PHP

Publicaci√≥n de eventos en un bus empresarial.

{% raw %}
```php
$nats = new Nats();
$nats->connect();

$event = [
    'type' => 'OrderCreated',
    'order_id' => 1001,
    'timestamp' => microtime(true)
];

$nats->publish("orders.created", json_encode($event));
```
{% endraw %}

---

# 5. Microservicio con Consistencia Eventual

Emitir un evento y permitir que otros servicios materialicen su propio estado.

### Servicio ‚ÄúUsuarios‚Äù

{% raw %}
```php
$user = User::create($email);
$this->repo->save($user);

$eventBus->dispatch(new UserRegistered($user->id, $email));
```
{% endraw %}

### Servicio ‚ÄúNotificaciones‚Äù

{% raw %}
```php
$eventBus->subscribe(UserRegistered::class, function ($event) {
    Email::send($event->email, "Bienvenido!");
});
```
{% endraw %}

---

# 6. Sagas (Process Managers)

Coordinaci√≥n de m√∫ltiples microservicios.

{% raw %}
```php
class CheckoutSaga {
    public function onOrderPlaced(OrderPlaced $e) {
        $this->bus->dispatch(new ReserveStock($e->orderId));
    }

    public function onStockReserved(StockReserved $e) {
        $this->bus->dispatch(new ProcessPayment($e->orderId));
    }

    public function onPaymentCompleted(PaymentCompleted $e) {
        $this->bus->dispatch(new FinalizeOrder($e->orderId));
    }
}
```
{% endraw %}

---

# 7. Multi-Tenancy (SaaS Moderno)

Separaci√≥n por base de datos seg√∫n tenant.

### Middleware para identificar tenant

{% raw %}
```php
class TenantResolver {
    public function __invoke($req, $next) {
        $domain = $_SERVER['HTTP_HOST'];
        $tenant = explode('.', $domain)[0];

        TenantContext::set($tenant);

        return $next($req);
    }
}
```
{% endraw %}

### Repositorio multi-tenant

{% raw %}
```php
class TenantPDOFactory {
    public static function connection(): PDO {
        $tenant = TenantContext::get();
        return new PDO("mysql:dbname=app_$tenant;host=localhost", "root", "");
    }
}
```
{% endraw %}

---

# 8. Pipeline de Enriquecimiento de Eventos

Patr√≥n usado en Data Engineering con PHP como worker.

{% raw %}
```php
class Pipeline {
    public function __construct(private array $stages) {}

    public function process(array $event): array {
        foreach ($this->stages as $s) $event = $s($event);
        return $event;
    }
}

$pipeline = new Pipeline([
    fn($e) => array_merge($e, ['ip' => $_SERVER['REMOTE_ADDR']]),
    fn($e) => array_merge($e, ['geo' => geo_lookup($e['ip'])]),
    fn($e) => array_merge($e, ['processed_at' => microtime(true)])
]);

$event = $pipeline->process(['type' => 'login', 'user' => 4]);
```
{% endraw %}

---

# 9. PHP Worker persistente (Swoole / RoadRunner)

Colas, websockets, tareas background.

{% raw %}
```php
use Spiral\RoadRunner\Worker;

$worker = Worker::create();

while ($req = $worker->waitPayload()) {
    $data = json_decode($req->body, true);
    // procesar evento
    $worker->respond(json_encode(['done' => true]));
}
```
{% endraw %}

---

# 10. Capa de Anti-Corrupci√≥n (ACL)

Aislar tu dominio de sistemas externos.

{% raw %}
```php
class ExternalBillingAdapter {
    public function __construct(private BillingApi $api) {}

    public function createInvoice(DomainInvoice $invoice): BillingInvoice {
        return $this->api->createInvoice([
            'amount' => $invoice->total(),
            'items' => $invoice->items(),
        ]);
    }
}
```
{% endraw %}

---

# 11. GraphQL + Domain Services

Exponer dominios complejos con resoluci√≥n por servicios.

{% raw %}
```php
$schema = <<<GRAPHQL
type Query {
    invoice(id: ID!): Invoice
}
GRAPHQL;

$resolvers = [
    'Query' => [
        'invoice' => fn($root, $args) => $invoiceService->getById($args['id'])
    ]
];
```
{% endraw %}

---

# 12. Integraci√≥n con Service Mesh (mTLS)

PHP hablando con un sidecar Envoy.

{% raw %}
```php
$context = stream_context_create([
    "ssl" => [
        "local_cert" => "/etc/certs/client.pem",
        "cafile"     => "/etc/certs/ca.crt"
    ]
]);

$response = file_get_contents("https://orders.internal.svc", false, $context);
```
{% endraw %}

---

# 13. Observabilidad avanzada (OpenTelemetry)

Traza completa de un request.

{% raw %}
```php
$tracer = (new TracerProvider(
    new SimpleSpanProcessor(
        new OtlpHttpExporter(endpoint: "http://otel-collector:4318")
    )
))->getTracer("app");

$span = $tracer->spanBuilder("process_order")->startSpan();
// l√≥gica
$span->setAttribute("order.id", 1209);
$span->end();
```
{% endraw %}

---

# 14. Idempotencia distribuida

Evitar procesamientos duplicados en workers.

{% raw %}
```php
class Idempotency {
    public function __construct(private Redis $redis) {}

    public function check(string $key): bool {
        return $this->redis->set($key, 1, ['nx', 'ex' => 300]);
    }
}

$id = new Idempotency($redis);

if (!$id->check("payment:$txnId")) {
    exit("Already processed");
}
```
{% endraw %}

---

# 15. √Årbol de permisos RBAC din√°mico

Control granular con herencia de roles.

{% raw %}
```php
class PermissionTree {
    private array $roles = [];

    public function addRole(string $role, array $permissions = [], ?string $parent = null) {
        $this->roles[$role] = compact('permissions', 'parent');
    }

    public function allows(string $role, string $perm): bool {
        if (in_array($perm, $this->roles[$role]['permissions'])) return true;
        $parent = $this->roles[$role]['parent'];
        return $parent ? $this->allows($parent, $perm) : false;
    }
}

$tree = new PermissionTree();
$tree->addRole("viewer", ["read"]);
$tree->addRole("editor", ["write"], "viewer");

$tree->allows("editor", "read"); // true
```
{% endraw %}

---

# 16. Cifrado por campos (Field-level encryption)

Est√°ndar en sistemas con GDPR.

{% raw %}
```php
class FieldEncryptor {
    public function __construct(private string $key) {}

    public function encrypt(string $value): string {
        $iv = random_bytes(16);
        $enc = openssl_encrypt($value, "AES-256-GCM", $this->key, 0, $iv, $tag);
        return base64_encode($iv.$tag.$enc);
    }

    public function decrypt(string $payload): string {
        $raw = base64_decode($payload);
        $iv  = substr($raw, 0, 16);
        $tag = substr($raw, 16, 16);
        $enc = substr($raw, 32);
        return openssl_decrypt($enc, "AES-256-GCM", $this->key, 0, $iv, $tag);
    }
}
```
{% endraw %}

---

# 17. Sincronizaci√≥n de proyecciones en paralelo

Materialization pipeline.

{% raw %}
```php
$events = $eventStore->loadSince($checkpoint);

parallel\run(function() use ($events) {
    foreach ($events as $e) UserProjection::apply($e);
});

parallel\run(function() use ($events) {
    foreach ($events as $e) BillingProjection::apply($e);
});
```
{% endraw %}

---

# 18. Dominio con reglas complejas (Policy Pattern)

{% raw %}
```php
interface Policy { public function check(Order $o): bool; }

class MaxAmountPolicy implements Policy {
    public function check(Order $o): bool { return $o->total <= 5000; }
}

class OnlyVerifiedUsersPolicy implements Policy {
    public function check(Order $o): bool { return $o->user->verified; }
}

class OrderApproval {
    public function __construct(private array $policies) {}

    public function approve(Order $o): bool {
        foreach ($this->policies as $p) {
            if (!$p->check($o)) return false;
        }
        return true;
    }
}
```
{% endraw %}

---

# 19. Precalentamiento de cach√©s (Startup warmers)

{% raw %}
```php
class WarmCache {
    public function __invoke() {
        Cache::set('settings', SettingsRepository::loadAll());
        Cache::set('countries', CountryRepository::all());
    }
}

(new WarmCache())();
```
{% endraw %}

---

# 20. Detecci√≥n de cambios en dominio (State Diff)

{% raw %}
```php
function diff(object $old, object $new): array {
    $changes = [];
    foreach (get_object_vars($new) as $prop => $val) {
        if ($old->$prop !== $val) $changes[$prop] = [$old->$prop, $val];
    }
    return $changes;
}

$changes = diff($productOld, $productNew);
```
{% endraw %}

---

# PHP Aplicado a Arquitecturas Empresariales (2025)

## Introducci√≥n
Esta nota describe **c√≥mo aplicar PHP en arquitecturas empresariales modernas**, incluyendo microservicios, CQRS, Event Sourcing, pipelines, observabilidad y multi-tenant.  
Se enfoca en **patrones, pr√°cticas y casos reales** aplicables en entornos corporativos de alta escala.

---

## 1. Arquitectura de Microservicios
PHP puede formar parte de un ecosistema de servicios independientes.

### Caracter√≠sticas
- Servicios desacoplados con responsabilidades claras.
- Comunicaci√≥n as√≠ncrona mediante colas (RabbitMQ, Kafka) o HTTP REST/GraphQL.
- Independencia de base de datos por servicio.
- Implementaci√≥n de contratos (API-first).

### Ejemplo de Microservicio PHP
{% raw %}
```php
// Servicio de usuarios
class UserService {
public function register(string $email): User {
	$user = new User($email);
	$this->repository->save($user);
	$this->eventBus->dispatch(new UserRegistered($user->id));
	return $user;
}
}
```
{% endraw %}`

---

## 2. CQRS y Event Sourcing

Separaci√≥n de **commands** (escritura) y **queries** (lectura), combinada con almacenamiento de eventos.

### Patr√≥n CQRS

- Commands: registran cambios de estado.
- Queries: consultan informaci√≥n optimizada.
- Beneficios: escalabilidad, performance y claridad de negocio.

### Event Sourcing

- Cada cambio en el dominio se registra como un evento inmutable.
- Permite reconstruir el estado del sistema en cualquier momento.
- Facilita auditor√≠a y reproducibilidad.

{% raw %}
```php
class Account {
private array $events = [];
public function deposit(float $amount) {
	$this->events[] = new DepositMade($amount);
	$this->apply($this->events[count($this->events)-1]);
}
private function apply(object $event) { $this->balance += $event->amount; }
}
```
{% endraw %}

---

## 3. Pipelines y Workers Distribuidos

PHP puede ejecutar tareas as√≠ncronas de alto volumen.

### Ejemplo: Worker para env√≠o de correos

{% raw %}
```php
while ($job = $queue->pop()) {
EmailService::send($job->email, $job->subject, $job->body);
}
```
{% endraw %}

### Pipeline de procesamiento de eventos

{% raw %}
```
- Enriquecimiento de datos
- Validaci√≥n
- Persistencia en proyecciones o caches
```
{% endraw %}

---

## 4. Multi-Tenancy

Implementaci√≥n SaaS con separaci√≥n de clientes.

### Base de datos por tenant

{% raw %}
```php
$tenant = TenantContext::get();
$pdo = new PDO("mysql:host=localhost;dbname=app_$tenant", "user", "pass");
```
{% endraw %}

### Middleware de identificaci√≥n de tenant

{% raw %}
```php
class TenantResolver {
public function __invoke($request, $next) {
	$tenant = explode('.', $_SERVER['HTTP_HOST'])[0];
	TenantContext::set($tenant);
	return $next($request);
}
}
```
{% endraw %}

---

## 5. Observabilidad y Telemetr√≠a

Integraci√≥n con OpenTelemetry, logs estructurados y tracing distribuido.

{% raw %}
```php
$tracer = (new TracerProvider(new SimpleSpanProcessor(new OtlpHttpExporter())))
->getTracer("app");

$span = $tracer->spanBuilder("process_order")->startSpan();
$span->setAttribute("order.id", $orderId);
$span->end();
```
{% endraw %}

### Buenas pr√°cticas

{% raw %}
```
- Logs JSON para sistemas centralizados.
- M√©tricas de negocio y t√©cnicas.
- Tracing en requests y jobs.
```
{% endraw %}

---

## 6. Seguridad Empresarial

### Pr√°cticas recomendadas

- Cifrado a nivel de campo (AES-256-GCM) para datos sensibles.
- Autenticaci√≥n moderna: OAuth2, JWT rotativos, OpenID Connect.
- Gesti√≥n de roles y permisos RBAC din√°mico.
- Middleware de validaci√≥n y protecci√≥n contra ataques OWASP.

---

## 7. Integraci√≥n con Service Mesh y Arquitectura Distribuida

PHP puede integrarse con mTLS y sidecars para seguridad y control de tr√°fico.

{% raw %}
```php
$context = stream_context_create([
"ssl" => [
	"local_cert" => "/etc/certs/client.pem",
	"cafile"     => "/etc/certs/ca.crt"
]
]);
$response = file_get_contents("https://orders.internal.svc", false, $context);
```
{% endraw %}

### Beneficios

- Descubrimiento de servicios
- Resiliencia y retries autom√°ticos
- Telemetr√≠a nativa

---

## 8. Integraci√≥n con Legacy y Sistemas Externos

- Adaptadores para sistemas antiguos.
- Anti-Corruption Layer para aislar el dominio.
- Transformaci√≥n de datos entrantes a objetos de dominio.

{% raw %}
```php
class ExternalBillingAdapter {
public function createInvoice(DomainInvoice $invoice) {
	return $this->api->createInvoice([
		'amount' => $invoice->total(),
		'items' => $invoice->items(),
	]);
}
}
```
{% endraw %}

---

## 9. Arquitectura Hexagonal en PHP

### Principios

- Puertos: interfaces del dominio.
- Adaptadores: infraestructura, bases de datos, API externas.
- Beneficios: independencia de framework, facilidad de testing.

### Ejemplo

{% raw %}
```php
// Puerto
interface UserRepository { public function save(User $user); }
// Adaptador
class UserRepositoryMySQL implements UserRepository {
public function save(User $user) { /* persist */ }
}
```
{% endraw %}

---

## 10. Escalabilidad y Performance

### Estrategias

- Uso de Swoole/RoadRunner para PHP sin bloqueo.
- Preloading y Opcache optimizado.
- Cache multi-capa: Redis, Memcached, microcaching HTTP.
- Sharding y replicaci√≥n de datos en grandes sistemas.

---

## 11. Casos de Uso Empresariales

- **Facturaci√≥n masiva**: workers + pipelines + CQRS.
- **SaaS multi-tenant**: bases de datos separadas, configuraci√≥n por tenant.
- **Procesamiento de eventos**: Event Mesh + Event Sourcing.
- **Notificaciones masivas**: colas y workers as√≠ncronos.
- **Auditor√≠a de negocio**: Event Sourcing y logs estructurados.
- **Integraci√≥n con ERPs**: adaptadores y anti-corruption layers.
- **Seguridad y cumplimiento**: cifrado, roles din√°micos y autenticaci√≥n moderna.


---

## 12. Estructura de Proyecto Empresarial

{% raw %}
```
src/
App/
	Domain/
	Application/
	Infrastructure/
	Shared/
config/
workers/
tests/
vendor/
public/
```
{% endraw %}

---

## 13. Buenas Pr√°cticas para PHP Empresarial

- Seguir PSR (12, 4, 3, 7, 15).
- Separaci√≥n estricta de dominio, aplicaci√≥n e infraestructura.
- Tests unitarios, integraci√≥n y end-to-end.
- Documentaci√≥n y OpenAPI para APIs.
- Deploy automatizado y pipelines CI/CD.
- Observabilidad y trazabilidad completa de requests y jobs.

# PHP ‚Äî Gu√≠a de Tools y T√©cnicas Modernas (2025)

## Introducci√≥n
Gu√≠a pr√°ctica de **herramientas y t√©cnicas modernas** para desarrollo PHP en entornos profesionales, SaaS, microservicios y arquitecturas empresariales.  
Incluye **IDE, depuraci√≥n, testing, pipelines, seguridad, performance y observabilidad**.

---

## 1. IDE y Editor de C√≥digo
- **PhpStorm**: refactorizaci√≥n avanzada, debugging y an√°lisis de c√≥digo.
- **VSCode**: extensiones PHP Intelephense, PHP Debug.
- **Neovim / Vim**: integraci√≥n con LSP y PHPStan para an√°lisis est√°tico.

### T√©cnicas
- Autocompletado y navegaci√≥n por clases/m√©todos.
- Plantillas de c√≥digo y snippets.
- Integraci√≥n con Docker y entornos remotos.

---

## 2. Gesti√≥n de Dependencias
- [composer](/backend/composer/): est√°ndar de facto para manejo de paquetes y autoloading.
- **Packagist**: repositorio p√∫blico.
- **Private repositories**: para librer√≠as internas.
- **T√©cnicas**:
- Versionamiento sem√°ntico (SemVer)
- PSR-4 autoloading
- Dependencias m√≠nimas por microservicio

---

## 3. Testing y Calidad de C√≥digo
### Herramientas
- [PHPUnit](/testing/phpunit/): pruebas unitarias y de integraci√≥n.
- **PestPHP**: sintaxis m√°s limpia para tests.
- **PHPStan / Psalm**: an√°lisis est√°tico, detenci√≥n de errores en tiempo de desarrollo.
- **Mockery / Prophecy**: mocks y stubs para pruebas unitarias.

### T√©cnicas
- Test Driven Development (TDD)
- Domain testing (tests centrados en reglas de negocio)
- Cobertura m√≠nima ‚â• 80%
- Integraci√≥n en pipelines CI/CD

---

## 4. Debugging
- **Xdebug**: step debugging, profiling y tracing.
- **Telescope (Laravel)**: monitorizaci√≥n de requests y jobs.
- **Clockwork**: profiling de aplicaciones PHP, integraci√≥n con browser.

### T√©cnicas
- Debug remoto con IDE
- Breakpoints condicionales
- An√°lisis de consumo de memoria y tiempo de ejecuci√≥n
- Dump de variables con `var_dump` o `ray()` de Spatie

---

## 5. Pipelines y CI/CD
- **GitHub Actions**: workflows automatizados.
- **GitLab CI/CD**: pipelines YAML.
- **Jenkins / Bamboo**: integraci√≥n empresarial.

### T√©cnicas
- Linting y static analysis en cada commit
- Ejecuci√≥n de tests unitarios y de integraci√≥n
- Construcci√≥n de contenedores y despliegue automatizado
- Canary releases y blue/green deployment

---

## 6. Contenedores y Orquestaci√≥n
- **Docker**: entornos reproducibles.
- **Docker Compose**: multi-servicios locales.
- **Kubernetes**: despliegue a escala.
- **Helm**: gesti√≥n de configuraciones.

### T√©cnicas
- Separaci√≥n de servicios (PHP-FPM, Nginx, Redis, DB)
- Escalabilidad horizontal y replicaci√≥n
- Multi-tenant en contenedores aislados
- Logs centralizados con EFK stack

---

## 7. Logging y Observabilidad
- **Monolog**: logging estructurado.
- **OpenTelemetry**: tracing y m√©tricas.
- **Prometheus + Grafana**: m√©tricas de negocio y t√©cnicas.
- **Sentry**: error tracking.

### T√©cnicas
- Logs JSON y correlaci√≥n de request-id
- Trazas distribuidas en microservicios
- M√©tricas personalizadas (latencia, throughput)
- Alertas basadas en SLAs

---

## 8. Seguridad
- **libsodium**: cifrado y firmas modernas.
- **JWT**: autenticaci√≥n y autorizaci√≥n.
- **OAuth2 / OpenID Connect**: integraci√≥n con proveedores.
- **OWASP ZAP**: testing de vulnerabilidades.

### T√©cnicas
- Validaci√≥n y sanitizaci√≥n estricta de inputs
- Cifrado de campos sensibles
- Middleware de seguridad (CORS, rate limiting, CSRF)
- Rotaci√≥n de tokens y claves

---

## 9. Performance
- **Opcache**: caching de bytecode.
- **Redis / Memcached**: cache de datos y sesiones.
- **Swoole / RoadRunner**: ejecuci√≥n PHP persistente sin cold start.
- **Blackfire**: profiling avanzado.

### T√©cnicas
- Preload de clases cr√≠ticas
- Optimizaci√≥n de queries y √≠ndices
- Lazy-loading de dependencias
- Batch jobs para operaciones costosas

---

## 10. Integraci√≥n con Sistemas Externos
- **Guzzle / Symfony HttpClient**: consumo de APIs REST/GraphQL.
- **RabbitMQ / Kafka / NATS**: colas y mensajer√≠a distribuida.
- **ETL Pipelines**: procesamiento de datos as√≠ncrono.
- **Webhooks**: integraci√≥n en tiempo real con servicios externos.

### T√©cnicas
- Retries con backoff exponencial
- Circuit Breakers y fallback patterns
- Adaptadores y Anti-Corruption Layers para sistemas legacy
- Observabilidad en cada integraci√≥n

---

## 11. Frameworks Modernos
- **[laravel](/backend/laravel/)**: microservicios, jobs, pipelines, Eloquent ORM.
- **Symfony**: arquitectura hexagonal, DI, reusable bundles.
- **CodeIgniter / Slim**: micro-frameworks ligeros.
- **Techniques**:
- Inyecci√≥n de dependencias
- Event-driven architecture
- Middleware pipelines
- Domain-driven design (DDD)

---

## 12. Testing en Producci√≥n
- Canary deployments y feature flags.
- Smoke tests autom√°ticos.
- Health checks y monitoring en endpoints cr√≠ticos.
- Integraci√≥n de logging y tracing con m√©tricas.

---

## 13. Automatizaci√≥n de Tareas
- **Laravel Scheduler / Cron Jobs**: ejecuci√≥n peri√≥dica de tareas.
- **Supervisor**: monitorizaci√≥n de procesos PHP persistentes.
- **RoadRunner / Swoole Workers**: tareas background as√≠ncronas y persistentes.

---

## 14. Documentaci√≥n y API Management
- **OpenAPI / Swagger**: documentaci√≥n de endpoints.
- **GraphQL Playground / Voyager**: exploraci√≥n de API.
- **Postman / Insomnia**: testing de endpoints.
- **T√©cnicas**:
- Versionado de API (`/v1`, `/v2`)
- Contratos claros y consistentes
- Validaci√≥n de inputs y outputs

---

## 15. Buenas Pr√°cticas Generales
- Seguir PSR (3, 4, 7, 12, 15)
- Separaci√≥n estricta de dominio, aplicaci√≥n e infraestructura
- Automatizaci√≥n completa del ciclo de vida
- Observabilidad y trazabilidad total
- Security-first: cifrado, roles y autenticaci√≥n robusta
- Performance y caching en todos los niveles
- Testing y CI/CD integrados

---

## 16. Recursos Complementarios
- PHP-mysql-old
- [Testing](/testing/testing/)
- Composer
- [laravel](/backend/laravel/)
- Symfony
- [GitHub - PHP Best Practices](https://github.com/php-best-practices/php-best-practices)
- [PHP: The Right Way](https://phptherightway.com/)

# PHP ‚Äî Seguridad Moderna 2025

## Introducci√≥n
Gu√≠a de **pr√°cticas, herramientas y t√©cnicas de seguridad modernas** en PHP 2025, aplicable a aplicaciones web, APIs y arquitecturas empresariales.  
Cubre **cifrado, autenticaci√≥n, autorizaci√≥n, hardening, protecci√≥n de datos y observabilidad de seguridad**.

---

## 1. Cifrado y Hashing

### 1.1 Hashing de contrase√±as
- Usar `password_hash()` y `password_verify()`.
- Algoritmo recomendado: `PASSWORD_ARGON2ID` (PHP 8.3+).
{% raw %}
```php
$hash = password_hash($password, PASSWORD_ARGON2ID);
if (password_verify($input, $hash)) {
    // login exitoso
}
```
{% endraw %}`

### 1.2 Cifrado de datos sensibles

* Uso de **libsodium** para cifrado moderno.
* Cifrado sim√©trico AES-GCM para campos sensibles.

{% raw %}
```php
$key = random_bytes(SODIUM_CRYPTO_SECRETBOX_KEYBYTES);
$nonce = random_bytes(SODIUM_CRYPTO_SECRETBOX_NONCEBYTES);
$cipher = sodium_crypto_secretbox($data, $nonce, $key);
$plain = sodium_crypto_secretbox_open($cipher, $nonce, $key);
```
{% endraw %}

### 1.3 Encriptaci√≥n a nivel de campo (Field-Level Encryption)

* Ideal para GDPR/CCPA.
* Cifrado de emails, n√∫meros de tarjeta, documentos.

{% raw %}
```php
class FieldEncryptor {
    public function encrypt(string $value): string { /* AES-256-GCM */ }
    public function decrypt(string $payload): string { /* AES-256-GCM */ }
}
```
{% endraw %}

---

## 2. Autenticaci√≥n Moderna

### 2.1 OAuth2 / OpenID Connect

* JWTs rotativos y short-lived.
* Refresh tokens con revocaci√≥n y control de uso.
* Ejemplo de verificaci√≥n JWT:

{% raw %}
```php
use Firebase\JWT\JWT;
$decoded = JWT::decode($token, $publicKey, ['RS256']);
```
{% endraw %}

### 2.2 Multi-Factor Authentication (MFA)

* Integraci√≥n TOTP (Google Authenticator, Authy).
* Backup codes y alertas de seguridad.

### 2.3 Session Management seguro

* Cookies `HttpOnly` y `Secure`.
* Regeneraci√≥n de session_id en login.
* Tiempo de expiraci√≥n corto y idle timeout.

---

## 3. Autorizaci√≥n y Roles

### 3.1 RBAC din√°mico

* Roles jer√°rquicos con permisos heredables.

{% raw %}
```php
class PermissionTree {
	public function allows(string $role, string $perm): bool { /* recursivo */ }
}
```
{% endraw %}

### 3.2 ABAC (Attribute-Based Access Control)

* Control basado en atributos de usuario, contexto y recurso.
* Ejemplo: solo usuarios verificados y con pa√≠s permitido pueden acceder a ciertos endpoints.

---

## 4. Protecci√≥n contra ataques comunes

### 4.1 SQL Injection

* Preparar todas las queries con PDO o ORM.

{% raw %}
```php
$stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
$stmt->execute([$email]);
```
{% endraw %}

### 4.2 XSS (Cross-Site Scripting)

* Escapar siempre la salida con `htmlspecialchars()`.
* Validaci√≥n de inputs.

### 4.3 CSRF (Cross-Site Request Forgery)

* Tokens √∫nicos por formulario/session.

{% raw %}
```php
$_SESSION['csrf'] = bin2hex(random_bytes(32));
<input type="hidden" name="csrf" value="<?= $_SESSION['csrf'] ?>">
```
{% endraw %}

### 4.4 Rate Limiting

* Prevenir brute force y abuso de endpoints.

{% raw %}
```php
if (!rate_limit($userId, 100, 60)) {
    http_response_code(429);
    exit("Too many requests");
}
```
{% endraw %}

---

## 5. Seguridad en APIs

### 5.1 Validaci√≥n de Requests

* JSON Schema o DTOs con Attributes (PHP 8+).

{% raw %}
```php
#[Required]
public string $email;
```
{% endraw %}

### 5.2 HMAC / Signatures

* Validaci√≥n de integridad de webhooks.

{% raw %}
```php
$calc = hash_hmac('sha256', $payload, $secret);
hash_equals($calc, $signature);
```
{% endraw %}

### 5.3 Throttling y IP Whitelisting

* Limitar requests por IP o token.

---

## 6. Hardening de PHP

### 6.1 Configuraci√≥n segura

* `expose_php = Off`
* `display_errors = Off` en producci√≥n
* `error_log = /var/log/php_errors.log`
* `session.cookie_httponly = 1`
* `session.cookie_secure = 1`

### 6.2 Dependencias y Composer

* Escanear vulnerabilidades con `composer audit`.
* Mantener paquetes actualizados.
* Evitar librer√≠as abandonadas.

---

## 7. Observabilidad y Seguridad

### 7.1 Logging seguro

* Logs estructurados (JSON) sin exponer datos sensibles.
* Correlaci√≥n de request-id para auditor√≠a.

### 7.2 Monitoreo y alertas

* Integraci√≥n con Sentry, Prometheus, OpenTelemetry.
* Detecci√≥n de comportamientos an√≥malos (brute force, picos de error).

---

## 8. Seguridad en Microservicios

### 8.1 Comunicaci√≥n segura

* TLS/mTLS entre servicios.
* Validaci√≥n de certificados.

{% raw %}
```php
$context = stream_context_create([
	"ssl" => ["local_cert"=>"/etc/certs/client.pem", "cafile"=>"/etc/certs/ca.crt"]
]);
```
{% endraw %}

### 8.2 Idempotencia y Protecci√≥n de Jobs

* Evitar duplicados en colas.

{% raw %}
```php
if (!$idempotency->check("payment:$txnId")) exit("Already processed");
```
{% endraw %}

---

## 9. Pruebas de Seguridad

### 9.1 Unit y Integration Security Tests

* Validaci√≥n de pol√≠ticas, roles y permisos.
* Tests de endpoints para XSS, CSRF y SQLi.

### 9.2 Pentesting Automatizado

* OWASP ZAP o Burp Suite.
* Integraci√≥n en CI/CD pipelines.

---

## 10. Buenas Pr√°cticas Generales

* Principio de m√≠nimo privilegio.
* Validaci√≥n y sanitizaci√≥n exhaustiva de todos los inputs.
* Evitar datos sensibles en URLs o logs.
* Monitorizaci√≥n activa de seguridad.
* Actualizaci√≥n constante de PHP y librer√≠as.
* Cifrado de datos en reposo y en tr√°nsito.
* Implementar MFA y autenticaci√≥n moderna.
* Observabilidad y trazabilidad completa de requests y jobs.

---

## 11. Recursos y Referencias

* PHP-mysql-old
* [composer](/backend/composer/)
* [laravel](/backend/laravel/)
* [OWASP PHP Security](https://owasp.org/www-project-top-ten/)
* [PHP: The Right Way - Security](https://phptherightway.com/#security)
* [libsodium - PHP Docs](https://www.php.net/manual/en/book.sodium.php)

# PHP 2025 ‚Äî Cheatsheet

## 1. Sintaxis B√°sica
{% raw %}
```php
<?php
echo "Hola mundo";
$variable = 123;
$array = [1, 2, 3];
$assoc = ["clave" => "valor"];
```
{% endraw %}`

---

## 2. Tipos de Datos

* `int`, `float`, `string`, `bool`, `array`, `object`, `null`
* PHP 8+: Union types, mixed, static return type

{% raw %}
```php
function foo(int|string $param): int|string {
	return $param;
}
```
{% endraw %}

---

## 3. Control de Flujo

{% raw %}
```php
if ($x > 0) { ... } elseif ($x < 0) { ... } else { ... }
switch($val) { case 1: ... break; default: ... }
for ($i=0; $i<10; $i++) { ... }
foreach ($array as $key => $val) { ... }
while ($cond) { ... }
do { ... } while ($cond);
```
{% endraw %}

---

## 4. Funciones

{% raw %}
```php
function suma(int $a, int $b): int {
	return $a + $b;
}
$suma = fn($a, $b) => $a + $b; // arrow function PHP 7.4+
```
{% endraw %}

---

## 5. Clases y Objetos

{% raw %}
```php
class Persona {
	public string $nombre;
	public function __construct(string $nombre) { $this->nombre = $nombre; }
	public function saludar(): string { return "Hola $this->nombre"; }
}

$persona = new Persona("Eduardo");
echo $persona->saludar();
```
{% endraw %}

### Herencia y Polimorfismo

{% raw %}
```php
class Empleado extends Persona {
	public float $salario;
	public function __construct($nombre, $salario) {
		parent::__construct($nombre);
		$this->salario = $salario;
	}
}
```
{% endraw %}

---

## 6. Namespaces y Autoload

{% raw %}
```php
namespace App\Models;
class User {}
use App\Models\User;
$user = new User();
```
{% endraw %}

* Autoload con [composer](/backend/composer/): PSR-4

---

## 7. Traits, Interfaces y Enums

{% raw %}
```php
trait Logger { public function log($msg){ echo $msg; } }
interface JsonSerializable { public function jsonSerialize(): array; }
enum Status: string { case Active = 'active'; case Inactive = 'inactive'; }
```
{% endraw %}

---

## 8. Arrays y Colecciones

{% raw %}
```php
$arr = [1, 2, 3];
array_map(fn($x)=>$x*2, $arr);
array_filter($arr, fn($x)=>$x>1);
array_reduce($arr, fn($carry,$x)=>$carry+$x, 0);
```
{% endraw %}

---

## 9. Superglobals

* `$_GET`, `$_POST`, `$_COOKIE`, `$_SESSION`, `$_FILES`, `$_SERVER`, `$_ENV`

---

## 10. Manejo de Strings

{% raw %}
```php
$str = "Hola Mundo";
strlen($str);
strpos($str, "Mundo");
substr($str, 0, 4);
str_replace("Hola","Hi",$str);
```
{% endraw %}

---

## 11. Manejo de Fechas

{% raw %}
```php
$date = new DateTime("now", new DateTimeZone("Europe/Madrid"));
echo $date->format("Y-m-d H:i:s");
```
{% endraw %}

---

## 12. Archivos y Directorios

{% raw %}
```php
file_get_contents("archivo.txt");
file_put_contents("archivo.txt","contenido");
fopen("archivo.txt","r");
fclose($handle);
```
{% endraw %}

---

## 13. Errores y Excepciones

{% raw %}
```php
try {
	if($x<0) throw new Exception("Valor negativo");
} catch(Exception $e) {
	echo $e->getMessage();
} finally {
	// cleanup
}
```
{% endraw %}

---

## 14. Funciones Avanzadas

### Match Expression

{% raw %}
```php
$result = match($status) {
	1 => 'activo',
	2 => 'inactivo',
	default => 'desconocido'
};
```
{% endraw %}

### Nullsafe Operator

{% raw %}
```php
$name = $user?->profile?->name;
```
{% endraw %}

### Spread Operator en arrays

{% raw %}
```php
$arr1 = [1,2]; $arr2 = [...$arr1,3,4];
```
{% endraw %}

### Named Arguments

{% raw %}
```php
function connect($host, $port, $user) {}
connect(host: "localhost", user: "root", port: 3306);
```
{% endraw %}

---

## 15. Seguridad B√°sica

{% raw %}
```php
$passwordHash = password_hash($pass, PASSWORD_ARGON2ID);
if(password_verify($input, $passwordHash)) { ... }

$htmlSafe = htmlspecialchars($input, ENT_QUOTES, 'UTF-8');
```
{% endraw %}

---

## 16. Acceso a Base de Datos

{% raw %}
```php
$pdo = new PDO("mysql:host=localhost;dbname=test","root","");
$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");
$stmt->execute([$id]);
$user = $stmt->fetch(PDO::FETCH_ASSOC);
```
{% endraw %}

---

## 17. Composer y Dependencias

* Instalar paquete: `composer require vendor/package`
* Autoload: `require 'vendor/autoload.php';`
* Actualizar: `composer update`
* Analizar vulnerabilidades: `composer audit`

---

## 18. Testing

{% raw %}
```php
use PHPUnit\Framework\TestCase;
class MathTest extends TestCase {
	public function testSuma() { $this->assertEquals(4, 2+2); }
}
```
{% endraw %}

---

## 19. Debugging

* `var_dump($var)`, `print_r($var)`, `debug_backtrace()`
* Xdebug: breakpoints, stack traces y profiling
* Clockwork / Laravel Telescope para profiling HTTP y jobs

---

## 20. PHP 2025 Features

* Match expressions
* Nullsafe operator
* Named arguments
* Attributes / Annotations
* Constructor property promotion
* Union types y static return types
* Fibers para concurrencia ligera
* JIT y performance optimizations

---

## 21. Recursos

* PHP-mysql-old
* [composer](/backend/composer/)
* [laravel](/backend/laravel/)
* [PHP: The Right Way](https://phptherightway.com/)
* [PHP Manual](https://www.php.net/manual/en/)

# PHP Empresarial 2025 ‚Äî Cheatsheet Avanzado

## Introducci√≥n
Resumen de **herramientas, patrones, t√©cnicas y c√≥digo pr√°ctico** para entornos PHP empresariales y arquitecturas modernas (microservicios, CQRS, Event Sourcing, multi-tenant, observabilidad).

---

## 1. Arquitectura y Patrones

### 1.1 Microservicios
- Servicios desacoplados, independientes, con su propia DB.
- Comunicaci√≥n: HTTP REST, GraphQL, gRPC, mensajer√≠a (Kafka, NATS, RabbitMQ).

### 1.2 CQRS (Command/Query Responsibility Segregation)
{% raw %}
```php
// Command Handler
class CreateInvoiceHandler {
	public function __invoke(CreateInvoice $cmd) {
		$invoice = Invoice::create($cmd->customerId, $cmd->items);
		$this->repo->save($invoice);
		$this->events->dispatch(...$invoice->pullEvents());
	}
}
```
{% endraw %}`

### 1.3 Event Sourcing

{% raw %}
```php
$account = new Account();
$account->deposit(100);
$events = $account->pullEvents(); // persistir en Event Store
```
{% endraw %}

### 1.4 Arquitectura Hexagonal

* Separaci√≥n: **Domain**, **Application**, **Infrastructure**

{% raw %}
```php
interface UserRepository { public function save(User $user); }
class UserRepositoryMySQL implements UserRepository { /* ... */ }
```
{% endraw %}

### 1.5 Sagas / Process Managers

* Coordinaci√≥n de microservicios en procesos largos y distribuidos.

---

## 2. Multi-Tenancy y SaaS

### 2.1 Tenant Context

{% raw %}
```php
$tenant = explode('.', $_SERVER['HTTP_HOST'])[0];
TenantContext::set($tenant);
$pdo = new PDO("mysql:dbname=app_$tenant;host=localhost","user","pass");
```
{% endraw %}

### 2.2 Configuraci√≥n y cache por tenant

* Redis namespaces
* Configuraci√≥n din√°mica de recursos

---

## 3. Seguridad Empresarial

### 3.1 Autenticaci√≥n y Autorizaci√≥n

* OAuth2 / OpenID Connect
* JWT short-lived y refresh tokens
* RBAC din√°mico y ABAC

{% raw %}
```php
$tree->allows("editor", "read"); // true
```
{% endraw %}

### 3.2 Cifrado y hashing

* Contrase√±as: `PASSWORD_ARGON2ID`
* AES-256-GCM / libsodium para datos sensibles
* Field-level encryption para GDPR

### 3.3 Protecci√≥n contra ataques

* SQLi: PDO prepared statements
* XSS: `htmlspecialchars()`
* CSRF: tokens por formulario/session
* Rate limiting y throttling

---

## 4. Observabilidad y Monitoreo

### 4.1 Tracing distribuido

{% raw %}
```php
$span = $tracer->spanBuilder("process_order")->startSpan();
$span->setAttribute("order.id", $orderId);
$span->end();
```
{% endraw %}

### 4.2 Logging estructurado

* JSON logs, correlaci√≥n de request-id
* Integraci√≥n con Sentry, Prometheus, Grafana

### 4.3 Health Checks y Metrics

* Verificaci√≥n de endpoints cr√≠ticos
* M√©tricas de negocio y t√©cnicas

---

## 5. Colas y Workers

{% raw %}
```php
while ($job = $queue->pop()) {
	ProcessJob::handle($job);
}
```
{% endraw %}

* Mensajer√≠a: RabbitMQ, Kafka, NATS
* Worker persistente: Swoole, RoadRunner
* Idempotencia y retries
* Pipelines de enriquecimiento y proyecciones

---

## 6. API Empresarial

### 6.1 REST y GraphQL

* Versionado `/v1`, `/v2`
* Validaci√≥n DTO / JSON Schema
* HMAC/webhooks y throttling

### 6.2 Contratos y OpenAPI

* Documentaci√≥n clara
* Mock servers y tests autom√°ticos

---

## 7. Performance y Escalabilidad

### 7.1 Opcache y Preload

* PHP JIT y caching de bytecode

### 7.2 Cache de datos

* Redis / Memcached
* Microcaching HTTP

### 7.3 Paralelismo

* Fibers para concurrencia ligera
* Workers y pipelines distribuidos
* Sharding de bases de datos y replicaci√≥n

---

## 8. Testing Empresarial

### 8.1 Unit, Integration, E2E

* PHPUnit, PestPHP
* Mocks: Mockery / Prophecy
* Cobertura ‚â• 80%

### 8.2 Security and Compliance Tests

* Validaci√≥n de roles, permisos y pol√≠ticas
* Tests autom√°ticos de SQLi, XSS, CSRF
* Integraci√≥n con CI/CD

---

## 9. Herramientas Clave

* [composer](/backend/composer/): dependencias y autoload PSR-4
* [PHPUnit](/testing/phpunit/): pruebas unitarias
* PhpStorm / VSCode + Intelephense
* Sentry / Prometheus / Grafana / OpenTelemetry
* Docker / Docker Compose / Kubernetes
* Swoole / RoadRunner para workers persistentes

---

## 10. T√©cnicas Avanzadas

* Snapshotting en Event Sourcing
* Anti-Corruption Layer para sistemas legacy
* Domain Events y Event Mesh
* Canary releases y Blue/Green Deployment
* Multi-tenant con aislamiento completo
* Observabilidad full-stack (request + jobs + eventos)
* Idempotencia distribuida y locks
* Feature flags y experimentaci√≥n controlada

---

## 11. Recursos

* PHP-mysql-old
* [laravel](/backend/laravel/)
* Symfony
* [PHP: The Right Way](https://phptherightway.com/)
* [GitHub - PHP Best Practices](https://github.com/php-best-practices/php-best-practices)





# omnivore PHP
{% raw %}
```base
type: list
name: "Notas con #powershell en Omnivore"
order:
  - property: date_saved
    direction: desc
columns:
  - file.name
  - date_saved
filters:
  and:
    - file.inFolder("Omnivore")
    - file.hasTag("php", "PHP", "Php")
views:
  - type: table
    name: Table
    sort:
      - property: file.mtime
        direction: DESC

```
{% endraw %}

